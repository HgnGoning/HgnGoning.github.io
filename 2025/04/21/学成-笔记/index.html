<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>学成技术文档 | TTDB's blog</title><meta name="author" content="TTDB"><meta name="copyright" content="TTDB"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="需求分析–展示一个接口的开发流程 简单理解就是要搞清问题域，问题域就是用户的需求，软件要为用户解决什么问题，实现哪些业务功能，满足什么样的性能要求 那么如何做需求分析？ 首先确认用户需求 用户需求即用户的原始需求。通过用户访谈、问卷调查、开会讨论、查阅资料等调研手段梳理用户的原始需求，产品人员根据用户需求绘制界面原型，再通过界面原型让用户确认需求是否符合预期   确认关键问题 用户的原始需求可能是">
<meta property="og:type" content="article">
<meta property="og:title" content="学成技术文档">
<meta property="og:url" content="http://example.com/2025/04/21/%E5%AD%A6%E6%88%90-%E7%AC%94%E8%AE%B0/index.html">
<meta property="og:site_name" content="TTDB&#39;s blog">
<meta property="og:description" content="需求分析–展示一个接口的开发流程 简单理解就是要搞清问题域，问题域就是用户的需求，软件要为用户解决什么问题，实现哪些业务功能，满足什么样的性能要求 那么如何做需求分析？ 首先确认用户需求 用户需求即用户的原始需求。通过用户访谈、问卷调查、开会讨论、查阅资料等调研手段梳理用户的原始需求，产品人员根据用户需求绘制界面原型，再通过界面原型让用户确认需求是否符合预期   确认关键问题 用户的原始需求可能是">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/img/ab271877b6d5d966b6bcd9cda1623d51.jpeg">
<meta property="article:published_time" content="2025-04-21T06:26:10.419Z">
<meta property="article:modified_time" content="2025-04-22T02:35:12.239Z">
<meta property="article:author" content="TTDB">
<meta property="article:tag" content="TTDB">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/img/ab271877b6d5d966b6bcd9cda1623d51.jpeg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "学成技术文档",
  "url": "http://example.com/2025/04/21/%E5%AD%A6%E6%88%90-%E7%AC%94%E8%AE%B0/",
  "image": "http://example.com/img/ab271877b6d5d966b6bcd9cda1623d51.jpeg",
  "datePublished": "2025-04-21T06:26:10.419Z",
  "dateModified": "2025-04-22T02:35:12.239Z",
  "author": [
    {
      "@type": "Person",
      "name": "TTDB",
      "url": "http://example.com/"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://example.com/2025/04/21/%E5%AD%A6%E6%88%90-%E7%AC%94%E8%AE%B0/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin=""/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web&amp;display=swap" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: {"chs_to_cht":"已切换为繁体中文","cht_to_chs":"已切换为简体中文","day_to_night":"已切换为深色模式","night_to_day":"已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"bottom-left"},
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '学成技术文档',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="generator" content="Hexo 7.3.0"></head><body><div id="web_bg" style="background-image: url(https://i.loli.net/2019/09/09/5oDRkWVKctx2b6A.png);"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/ab271877b6d5d966b6bcd9cda1623d51.jpeg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">19</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">10</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">4</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg fixed" id="page-header" style="background-image: url(/img/e93f858d798bea4fbdee83331ff488c.jpg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">TTDB's blog</span></a><a class="nav-page-title" href="/"><span class="site-name">学成技术文档</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">学成技术文档</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-04-21T06:26:10.419Z" title="发表于 2025-04-21 14:26:10">2025-04-21</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-04-22T02:35:12.239Z" title="更新于 2025-04-22 10:35:12">2025-04-22</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h1 id="需求分析–展示一个接口的开发流程"><a href="#需求分析–展示一个接口的开发流程" class="headerlink" title="需求分析–展示一个接口的开发流程"></a>需求分析–展示一个接口的开发流程</h1><ul>
<li>简单理解就是要搞清问题域，问题域就是用户的需求，软件要为用户解决什么问题，实现哪些业务功能，满足什么样的性能要求</li>
<li>那么如何做需求分析？<ol>
<li>首先确认用户需求<ul>
<li>用户需求即用户的原始需求。通过用户访谈、问卷调查、开会讨论、查阅资料等调研手段梳理用户的原始需求，产品人员根据用户需求绘制界面原型，再通过界面原型让用户确认需求是否符合预期</li>
</ul>
</li>
<li>确认关键问题<ul>
<li>用户的原始需求可能是含糊不清的，需求分析要从繁杂的问题中梳理出关键问题。比如：教学机构的老师想要将课程发布到网上，这是原始需求，根据这个用户需求我们需要进行扩展分析，扩展出以下几个点：<ol>
<li>课程发布需要哪些信息？</li>
<li>如果用户发布了不良信息怎么办？</li>
<li>课程发布后用户怎么查看？</li>
</ol>
</li>
<li>课程发布需要课程名称、价格、介绍、图片（封面）、师资信息等。继续延伸分析：这么多课程信息进行归类，方便用户编辑，可以分为课程基本信息、课程营销信息、课程师资信息。</li>
<li>按照这样的思路对用户需求逐项分析，梳理出若干问题，再从中找到关键信息。比如：上边对课程信息分类后，哪些是关键信息，课程名称、课程图片、课程介绍扥基本信息为关键信息，所以发布课程的第一步要编写课程基本信息。</li>
<li>找到了关键问题，下一步就是进行数据建模，创建课程基本信息表，并设计其中的字段</li>
</ul>
</li>
<li>数据建模<ul>
<li>数据建模要根据分析的关键问题将其相关的信息全部建模。比如：根据发布课程的用户需求，可创建课程基本信息表、课程营销信息表、课程师资表、课程发布记录表、课程审核记录表等</li>
</ul>
</li>
<li>编写需求规格说明书<ul>
<li>针对每一个关键问题最终都需要编写需求规格说明书，包括：功能名称、功能描述、参与者、基本时间流程、可选事件流、数据描述、前置条件、后置条件等</li>
<li>比如添加课程的需求规格如下</li>
</ul>
</li>
</ol>
</li>
</ul>
<table>
<thead>
<tr>
<th align="center">项目</th>
<th align="center">添加课程</th>
</tr>
</thead>
<tbody><tr>
<td align="center">功能名称</td>
<td align="center">添加课程</td>
</tr>
<tr>
<td align="center">功能描述</td>
<td align="center">添加课程基本信息</td>
</tr>
<tr>
<td align="center">参与者</td>
<td align="center">教学机构管理员</td>
</tr>
<tr>
<td align="center">前置条件</td>
<td align="center">教学机构管理只允许向自己机构添加课程 拥有添加课程的权限</td>
</tr>
<tr>
<td align="center">基本事件流程</td>
<td align="center">1、登录教学机构平台 2、进入课程列表页面 3、点击添加课程按钮进入添加课程界面 4、填写课程基本信息 5、点击提交。</td>
</tr>
<tr>
<td align="center">可选事件流程</td>
<td align="center">成功：提示添加成功，跳转到课程营销信息添加界面 失败：提示具体的失败信息，用户根据失败信息进行修改。</td>
</tr>
<tr>
<td align="center">数据描述</td>
<td align="center">课程基本信息：课程id、课程名称、课程介绍、课程大分类、课程小分类、课程等级、课程图片、所属机构、课程创建时间、课程修改时间、课程状态</td>
</tr>
<tr>
<td align="center">后置条件</td>
<td align="center">向课程基本信息插入一条记录</td>
</tr>
</tbody></table>
<h2 id="课程查询模块设计"><a href="#课程查询模块设计" class="headerlink" title="课程查询模块设计"></a>课程查询模块设计</h2><h3 id="1-业务流程"><a href="#1-业务流程" class="headerlink" title="1.业务流程"></a>1.业务流程</h3><ol>
<li>教学机构点击课程管理，进入课程查询界面</li>
<li>在课程查询页面输入查询条件查询课程信息<br>-当不输入查询条件时，输出全部课程信息<br>- 输入查询条件，查询符合条件的课程信息<br>- 约束：教学机构只允许查询本教学机构的课程信息</li>
</ol>
<h3 id="2-数据模型"><a href="#2-数据模型" class="headerlink" title="2.数据模型"></a>2.数据模型</h3><ul>
<li>课程查询涉及到的数据表有：课程基本信息表，教学计划表</li>
</ul>
<p><img src="https://raw.githubusercontent.com/HgnGoning/images/main/img/image-20250407074217475.png" alt="image-20250407074217475"></p>
<p><img src="https://raw.githubusercontent.com/HgnGoning/images/main/img/image-20250407074242491.png" alt="image-20250407074242491"></p>
<ul>
<li>下面从查询条件、查询列表两方面进行分析<ol>
<li>查询条件<ul>
<li>包括：课程名称、课程审核状态、课程发布状态</li>
<li>课程名称：可以模糊搜索</li>
<li>课程审核状态：未提交、已提交、审核通过、审核未通过</li>
<li>课程发布状态：未发布、已发布、已下线</li>
<li>因为是分页查询，所以查询条件中还要包括当前页码、每页显示记录数</li>
</ul>
</li>
<li>查询结果<ul>
<li>包括：课程id、课程名称、任务数、创建时间、审核状态、类型</li>
<li>从结果上看基本来源于课程基本信息表，任务书需要关联教学计划表查询</li>
<li>因为是分页查询，所以查询结果中还要包括总记录数、当前页码、每页显示记录数</li>
</ul>
</li>
</ol>
</li>
</ul>
<h3 id="生成PO"><a href="#生成PO" class="headerlink" title="生成PO"></a>生成PO</h3><ul>
<li>PO即持久对象（Persistent Object），它们是由一组属性和属性的get&#x2F;set方法组成的。<strong>PO对应于数据库的表</strong></li>
<li>在开发持久层代码需要根据数据表编写PO类，在实际开发中通常使用代码生成器工具来生成PO类代码（人人开源、MP代码生成器、MybatisX插件等）</li>
</ul>
<h3 id="接口定义"><a href="#接口定义" class="headerlink" title="接口定义"></a>接口定义</h3><h4 id="接口定义分析"><a href="#接口定义分析" class="headerlink" title="接口定义分析"></a>接口定义分析</h4><ul>
<li><p>定义一个接口需要包括以下几个方面</p>
<ol>
<li><p>协议</p>
<ul>
<li>通常使用HTTP协议，查询类的接口请求方式通常为GET或POST，查询条件较少的时候使用GET，较多的时候使用POST</li>
<li>本接口使用http post</li>
<li>同时也要确定content-type，参数以什么数据格式提交，结果以什么数据格式响应</li>
<li>一般情况下都以json格式响应</li>
</ul>
</li>
<li><p>分析请求参数</p>
<ul>
<li>根据前面对数据模型的分析，请求参数为：课程名称、课程审核状态、当前页码、每页显示的记录数</li>
<li>根据分析的请求参数定义模型类</li>
</ul>
</li>
<li><p>分析响应结果</p>
<ul>
<li>根据前面对数据模型的分析，响应结果为数据列表和一些分页信息（总记录数、当前页码、每页显示记录数）</li>
<li>数据列表中数据的属性包括：课程id、课程名称、任务数、创建时间、审核状态、类型</li>
</ul>
<p>注意：查询结果中的审核状态为数据字典中的代码字段，前端会根据审核状态代码字段找到对应的名称显示（例如错误响应码404&#x2F;401&#x2F;502等）</p>
<ul>
<li>根据分析的相应结果定义模型类</li>
</ul>
</li>
<li><p>分析完成，使用SpringBoot注解开发一个Http接口</p>
</li>
<li><p>使用接口文档工具查看接口的内容</p>
</li>
<li><p>接口中调用Service方法完成业务处理</p>
</li>
</ol>
</li>
</ul>
<p>接口请求示例</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">POST /content/course/list?pageNo=<span class="number">2</span>&amp;pageSize=<span class="number">1</span></span><br><span class="line">Content-Type<span class="punctuation">:</span> application/json</span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;auditStatus&quot;</span><span class="punctuation">:</span> <span class="string">&quot;202002&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;courseName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="comment">//成功响应结果</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;items&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">26</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;companyId&quot;</span><span class="punctuation">:</span> <span class="number">1232141425</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;companyName&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;spring cloud实战&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;users&quot;</span><span class="punctuation">:</span> <span class="string">&quot;所有人&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;tags&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;mt&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1-3&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;mtName&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;st&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1-3-2&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;stName&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;grade&quot;</span><span class="punctuation">:</span> <span class="string">&quot;200003&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;teachmode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;201001&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;本课程主要从四个章节进行讲解： 1.微服务架构入门 2.spring cloud 基础入门 3.实战Spring Boot 4.注册中心eureka。&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;pic&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://cdn.educba.com/academy/wp-content/uploads/2018/08/Spring-BOOT-Interview-questions.jpg&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;createDate&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2019-09-04 09:56:19&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;changeDate&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2021-12-26 22:10:38&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;createPeople&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;changePeople&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;auditStatus&quot;</span><span class="punctuation">:</span> <span class="string">&quot;202002&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;auditMind&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;auditNums&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;auditDate&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;auditPeople&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;coursePubId&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;coursePubDate&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;counts&quot;</span><span class="punctuation">:</span> <span class="number">23</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;page&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;pageSize&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="课程查询接口定义"><a href="#课程查询接口定义" class="headerlink" title="课程查询接口定义"></a>课程查询接口定义</h3><ol>
<li><p>定义请求模型类</p>
<ul>
<li><p>对于查询条件较多的接口定义单独的模型类接收参数</p>
</li>
<li><p>由于分页查询这一类的接口在项目中很多地方都会用到，这里针对分页查询的参数（当前页码、每页显示的记录数）单独在xuecheng-plus-base基础工程中定义</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.base.model;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PageParams</span> &#123;</span><br><span class="line">    <span class="comment">// 默认起始页码</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">DEFAULT_PAGE_CURRENT</span> <span class="operator">=</span> <span class="number">1L</span>;</span><br><span class="line">    <span class="comment">// 默认每页记录数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">DEFAULT_PAGE_SIZE</span> <span class="operator">=</span> <span class="number">10L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 当前页码</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Long</span> <span class="variable">pageNo</span> <span class="operator">=</span> DEFAULT_PAGE_CURRENT;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 当前每页记录数</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Long</span> <span class="variable">pageSize</span> <span class="operator">=</span> DEFAULT_PAGE_SIZE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>除了分页查询参数，剩下的就是课程查询的特有参数，此时需要在内容管理的model工程中定义课程查询的参数模型类</p>
</li>
<li><p>定义DTO包，DTO即数据传输对象（Data Transfer Object），用于接口层和业务层之间传输数据</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.content.model.dto;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">QueryCourseParamDto</span> &#123;</span><br><span class="line">    <span class="comment">// 审核状态</span></span><br><span class="line">    <span class="keyword">private</span> String auditStatus;</span><br><span class="line">    <span class="comment">// 课程名称</span></span><br><span class="line">    <span class="keyword">private</span> String courseName;</span><br><span class="line">    <span class="comment">// 发布状态</span></span><br><span class="line">    <span class="keyword">private</span> String publishStatus;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>多样化的模型类</p>
<p>现在项目中有两种模型类：DTO数据传输对象、PO持久化对象。</p>
<ul>
<li><p>DTO用于接口层向业务层之间传输数据</p>
</li>
<li><p>PO用于业务层与持久层之间传输数据</p>
</li>
<li><p>有些公司还会设置VO对象，VO对象用在前端和接口层之间传输数据</p>
</li>
<li><p>当前端有多个平台且接口存在差异时，就需要设置VO对象用于前端和接口层传输数据。比如：课程列表查询接口，根据用户需求，用户在手机端也要查询课程信息，此时课程查询接口是否需要编写手机端和PC端两个接口呢？</p>
</li>
<li><p>如果用户要求通过手机和PC的查询条件或查询结果不一样，那此时就需要定义两个Controller课程查询接口，每个接口定义VO对象与前端传输数据</p>
<ul>
<li>手机查询：根据课程状态查询，查询结果只有课程名称和课程状态</li>
<li>PC查询：可以改根据课程名称、课程状态、课程审核状态等条件查询，查询结果也比手机查询的结果内容多</li>
</ul>
</li>
<li><p>此时，Service业务层尽量提供一个业务接口，即使两个前端接口需要的数据不一样，Service可以提供一个最群的查询结果，由Controller层进行数据整合。</p>
<p><img src="https://raw.githubusercontent.com/HgnGoning/images/main/img/image-20250407075311824.png" alt="image-20250407075311824"></p>
</li>
<li><p>如果前端接口没有多样性，且比较固定，此时可以取消VO，只用DTO即可</p>
</li>
</ul>
</li>
<li><p>定义模型响应类</p>
<ul>
<li><p>根据接口分析，下面定义响应结果模型类</p>
</li>
<li><p>针对分页查询结果经过分析，也存在固定的数据和格式，所以还是在base工程定义一个基础的结果模型类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="comment">//Serializable---可序列化对象</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PageResult</span>&lt;T&gt; <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="comment">// 数据列表</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;T&gt; items;</span><br><span class="line">    <span class="comment">// 总记录数</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> counts;</span><br><span class="line">    <span class="comment">// 当前页码</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> page;</span><br><span class="line">    <span class="comment">// 每页记录数</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> pageSize;</span><br><span class="line">&#125;   </span><br></pre></td></tr></table></figure>

<p>ps:为啥要<code>implements Serializable</code></p>
<p>一个<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=%E5%AF%B9%E8%B1%A1%E5%BA%8F%E5%88%97%E5%8C%96&spm=1001.2101.3001.7020">对象序列化</a>的接口，一个类只有实现了Serializable接口，它的对象才是可序列化的。因此如果要序列化某些类的对象，这些类就必须实现Serializable接口。而实际上，Serializable是一个空接口，没有什么具体内容，它的目的只是简单的标识一个类的对象可以被序列化。</p>
<p>什么情况下需要<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=%E5%BA%8F%E5%88%97%E5%8C%96&spm=1001.2101.3001.7020">序列化</a>：</p>
<ol>
<li>当你想把的内存中的对象写入到硬盘的时候。</li>
<li>当你想用<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=%E5%A5%97%E6%8E%A5%E5%AD%97&spm=1001.2101.3001.7020">套接字</a>在网络上传送对象的时候。</li>
<li>当你想通过RMI传输对象的时候。</li>
</ol>
<p>再稍微解释一下:</p>
<ol>
<li>比如说你的内存不够用了，那计算机就要将内存里面的一部分对象暂时的保存到硬盘中，等到要用的时候再读入到内存中，硬盘的那部分存储空间就是所谓的虚拟内存。在比如过你要将某个特定的对象保存到文件中，我隔几天在把它拿出来用，那么这时候就要实现Serializable接口。</li>
<li>在进行Java的Socket编程的时候，你有时候可能要传输某一类的对象，那么也就要实现Serializable接口。最常见的你传输一个字符串，它是JDK里面的类，也实现了Serializable接口，这样做为的是将数据变为二进制来传输，所以可以在网络上传输。</li>
<li>如果要通过远程的方法调用（RMI）去调用一个远程对象的方法，如在计算机A中调用另一台计算机B的对象的方法，那么你需要通过JNDI服务获取计算机B目标对象的引用，将对象从B传送到A，就需要实现序列化接口。</li>
</ol>
</li>
</ul>
</li>
<li><p>定义接口</p>
<ul>
<li><p>根据分析，此接口提供http post协议，查询条件以json格式提交，响应结果为json格式</p>
</li>
<li><p>首先咋xuecheng-plus-content-api中添加依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.xuecheng<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xuecheng-plus-content-model<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.xuecheng<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xuecheng-plus-content-service<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--cloud的基础环境包--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-context<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Spring Boot 的 Spring Web MVC 集成 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- 排除 Spring Boot 依赖的日志包冲突 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-logging<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-validation<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Spring Boot 集成 log4j2 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-log4j2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- Spring Boot 集成 swagger --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.spring4all<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>swagger-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.9.0.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>之后定义Controller方法</p>
<ul>
<li>说明：pageParams分页参数通过url的key&#x2F;value传入，queryCourseParams通过json数据传入，所以queryCourseParams前面需要用@RequestBody注解将json转为QueryCourseParamDto对象。这里的两个@Api注解是swagger的，用于描述接口的</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Api(value = &quot;课程信息编辑接口&quot;, tags = &quot;课程信息编辑接口&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CourseBaseInfoController</span> &#123;</span><br><span class="line">    <span class="meta">@PostMapping(&quot;/course/list&quot;)</span></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;课程查询接口&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> PageResult&lt;CourseBase&gt; <span class="title function_">list</span><span class="params">(PageParams pageParams, <span class="meta">@RequestBody</span> QueryCourseParamDto queryCourseParams)</span> &#123;</span><br><span class="line">        <span class="type">CourseBase</span> <span class="variable">courseBase</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CourseBase</span>();</span><br><span class="line">        courseBase.setId(<span class="number">15L</span>);</span><br><span class="line">        courseBase.setDescription(<span class="string">&quot;测试课程&quot;</span>);</span><br><span class="line">        PageResult&lt;CourseBase&gt; result = <span class="keyword">new</span> <span class="title class_">PageResult</span>&lt;&gt;();</span><br><span class="line">        result.setItems(Arrays.asList(courseBase));</span><br><span class="line">        result.setPage(<span class="number">1</span>);</span><br><span class="line">        result.setPageSize(<span class="number">10</span>);</span><br><span class="line">        result.setCounts(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>定义启动类，使用@EnableSwagger2Doc注解，启用Swagger</p>
</li>
<li><p>添加黑马给的两个文件：log4j2-dev.xml, bootstrap.yml</p>
</li>
</ul>
</li>
<li><p>接口开发</p>
</li>
</ol>
<ul>
<li><p>DAO开发</p>
<ul>
<li><p>业务层为接口层提供业务处理支撑，本项目业务层包括了持久层代码，一些大型公司的团队职责划分更细，会将持久层和业务层分为两个工程，不过这需要增加成本</p>
</li>
<li><p>DAO即数据访问对象，通过DAO去访问数据库对数据进行持久化，本项目持久层使用MyBatis-Plus进行开发</p>
</li>
<li><p>持久层的基础代码我们使用MP提供的代码生成器生成，将生成的Mapper和对应的xml拷贝纸service工程的com.xuecheng.content.mapper包下</p>
</li>
<li><p>同时在service的pom.xml中添加MP和日志的一些依赖</p>
</li>
<li><p>在config包中创建MP配置类，配置分页拦截器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Mybatis-Plus配置</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@MapperScan(&quot;com.xuecheng.content.mapper&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MybatisPlusConfig</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 定义分页拦截器</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> MybatisPlusInterceptor <span class="title function_">mybatisPlusInterceptor</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">MybatisPlusInterceptor</span> <span class="variable">interceptor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MybatisPlusInterceptor</span>();</span><br><span class="line">        interceptor.addInnerInterceptor(<span class="keyword">new</span> <span class="title class_">PaginationInnerInterceptor</span>(DbType.MYSQL));</span><br><span class="line">        <span class="keyword">return</span> interceptor;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>然后在yml中配置数据库连接信息和日志信息等    </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  application:</span><br><span class="line">    name: content-service</span><br><span class="line">  datasource:</span><br><span class="line">    driver-class-name: com.mysql.cj.jdbc.Driver</span><br><span class="line">        #这个url实际情况修改</span><br><span class="line">    url: jdbc:mysql:<span class="comment">//localhost:3306/xc_content?serverTimezone=UTC&amp;userUnicode=true&amp;useSSL=false</span></span><br><span class="line">    username: root</span><br><span class="line">    password: mysql</span><br><span class="line">logging:</span><br><span class="line">  config: classpath:log4j2-dev.xml</span><br></pre></td></tr></table></figure>
</li>
<li><p>最后编写测试方法并进行测试，控制台可以输出查到的数据（前提保证你的id真的对应有数据）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@SpringBootTest(classes = XuechengPlusContentServiceApplication.class)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">XuechengPlusContentServiceApplicationTests</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    CourseBaseMapper courseBaseMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">contextLoads</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">CourseBase</span> <span class="variable">courseBase</span> <span class="operator">=</span> courseBaseMapper.selectById(<span class="number">22</span>);</span><br><span class="line">        log.info(<span class="string">&quot;查询到数据：&#123;&#125;&quot;</span>, courseBase);</span><br><span class="line">        Assertions.assertNotNull(courseBase);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<ol start="6">
<li><p>Service开发</p>
<ol>
<li>数据字典表</li>
</ol>
<ul>
<li><p>课程基本信息查询的主要数据来源是课程基本信息表，这里有一点需要注意：课程的审核状态、发布状态</p>
</li>
<li><p>审核状态在查询条件和查询结果中都存在，包括：未审核、审核通过、审核未通过这三种</p>
</li>
<li><p>那么我们思考一个问题：直接在数据库表中的字段填充审核未通过</p>
<p>这几个大字，合适吗？</p>
<ul>
<li>如果将<code>审核未通过</code>这五个字记录在课程基本信息表中，查询出来的状态就是<code>审核未通过</code>这几个字，那么如果有一天客户想把<code>审核未通过</code>改为<code>未通过</code>，怎么办？</li>
<li>词汇我们可以批量处理数据库中的数据，写一个update语句，将所有的<code>审核未通过</code>更新为<code>未通过</code>。看起来解决了问题，但是万一后期客户抽风又想改呢？真实情况就是这样，但是这一类数据也有共同点：它有一些分类项，且这些分类项比较固定，大致的意思都是一样的，只是表述方式不一样。</li>
</ul>
</li>
<li><p>那么针对这一类数据，为了提高系统的可扩展性，专门定义数据字典去维护，例如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">    &#123;<span class="string">&quot;code&quot;</span>:<span class="string">&quot;202001&quot;</span>,<span class="string">&quot;desc&quot;</span>:<span class="string">&quot;审核未通过&quot;</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;code&quot;</span>:<span class="string">&quot;202002&quot;</span>,<span class="string">&quot;desc&quot;</span>:<span class="string">&quot;未审核&quot;</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;code&quot;</span>:<span class="string">&quot;202003&quot;</span>,<span class="string">&quot;desc&quot;</span>:<span class="string">&quot;审核通过&quot;</span>&#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<ul>
<li><p>那么我们创建系统管理数据库xc_system，在其中创建管理系统服务的数据表，导入黑马提供的SQL脚本就好了。这样查询出的数据在前端展示时，就根据代码取出它对应的内容显示给用户。如果客户需要修改<code>审核未通过</code>的显示内容，直接在数据字典中修改就好了，无需修改课程基本信息表</p>
</li>
<li><p>插入：对于异常信息处理则使用常量类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ShenHeConstant&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">final</span> <span class="type">constan</span> <span class="variable">A</span> <span class="operator">=</span> <span class="string">&quot;查询异常&quot;</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">final</span> <span class="type">constan</span> <span class="variable">B</span> <span class="operator">=</span> <span class="string">&quot;数据库异常&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
</li>
<li><p>Service开发</p>
<ol>
<li><p>接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">CourseBaseInfoService</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 课程查询接口</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> pageParams 分页参数</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> queryCourseParams 查询条件</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    PageResult&lt;CourseBase&gt; <span class="title function_">queryCourseBaseList</span><span class="params">(PageParams pageParams, QueryCourseParamDto queryCourseParams)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>实现类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CourseBaseInfoServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">CourseBaseInfoService</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    CourseBaseMapper courseBaseMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> PageResult&lt;CourseBase&gt; <span class="title function_">queryCourseBaseList</span><span class="params">(PageParams pageParams, QueryCourseParamDto queryCourseParams)</span> &#123;</span><br><span class="line">        <span class="comment">// 构建条件查询器</span></span><br><span class="line">        LambdaQueryWrapper&lt;CourseBase&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">// 构建查询条件：按照课程名称模糊查询</span></span><br><span class="line">        queryWrapper.like(StringUtils.isNotEmpty(queryCourseParams.getCourseName()), CourseBase::getCompanyName, queryCourseParams.getCourseName());</span><br><span class="line">        <span class="comment">// 构建查询条件，按照课程审核状态查询</span></span><br><span class="line">        queryWrapper.eq(StringUtils.isNotEmpty(queryCourseParams.getAuditStatus()), CourseBase::getAuditStatus, queryCourseParams.getAuditStatus());</span><br><span class="line">        <span class="comment">// 构建查询条件，按照课程发布状态查询</span></span><br><span class="line">        queryWrapper.eq(StringUtils.isNotEmpty(queryCourseParams.getPublishStatus()), CourseBase::getStatus, queryCourseParams.getPublishStatus());</span><br><span class="line">        <span class="comment">// 分页对象</span></span><br><span class="line">        Page&lt;CourseBase&gt; page = <span class="keyword">new</span> <span class="title class_">Page</span>&lt;&gt;(pageParams.getPageNo(), pageParams.getPageSize());</span><br><span class="line">        <span class="comment">// 查询数据内容获得结果</span></span><br><span class="line">        Page&lt;CourseBase&gt; pageInfo = courseBaseMapper.selectPage(page, queryWrapper);</span><br><span class="line">        <span class="comment">// 获取数据列表</span></span><br><span class="line">        List&lt;CourseBase&gt; items = pageInfo.getRecords();</span><br><span class="line">        <span class="comment">// 获取数据总条数</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">counts</span> <span class="operator">=</span> pageInfo.getTotal();</span><br><span class="line">        <span class="comment">// 构建结果集</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">PageResult</span>&lt;&gt;(items, counts, pageParams.getPageNo(), pageParams.getPageSize());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>单元测试类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span><span class="comment">//按名字注入，另一个按类名注入</span></span><br><span class="line">CourseBaseInfoService courseBaseInfoService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">contextQueryCourseTest</span><span class="params">()</span> &#123;</span><br><span class="line">    PageResult&lt;CourseBase&gt; result = courseBaseInfoService.queryCourseBaseList(<span class="keyword">new</span> <span class="title class_">PageParams</span>(<span class="number">1L</span>, <span class="number">10L</span>), <span class="keyword">new</span> <span class="title class_">QueryCourseParamDto</span>());</span><br><span class="line">    log.info(<span class="string">&quot;查询到数据：&#123;&#125;&quot;</span>, result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
</li>
<li><p>测试</p>
<ol>
<li>可以使用postman, swagger, HttpClient</li>
</ol>
</li>
<li><p>接口完善，个人觉得直接最初完善即可毕竟也不复杂，可以直接跳转创建实现方法也简单</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line">CourseBaseInfoService courseBaseInfoService;</span><br><span class="line"><span class="meta">@ApiOperation(&quot;课程查询接口&quot;)</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/course/list&quot;)</span></span><br><span class="line"><span class="keyword">public</span> PageResult&lt;CourseBase&gt; <span class="title function_">list</span><span class="params">(PageParams pageParams, <span class="meta">@RequestBody</span> QueryCourseParamDto queryCourseParams)</span> &#123;</span><br><span class="line">    PageResult&lt;CourseBase&gt; result = courseBaseInfoService.queryCourseBaseList(pageParams, queryCourseParams);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h1 id="异常处理"><a href="#异常处理" class="headerlink" title="异常处理"></a>异常处理</h1><h4 id="异常问题分析"><a href="#异常问题分析" class="headerlink" title="异常问题分析"></a>异常问题分析</h4><ul>
<li>在service方法中，有很多的参数合法性校验，当参数不合法的时候抛出异常，例如我们添加课程时，设置一个负数的课程价格，会报500异常</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;timestamp&quot;</span><span class="punctuation">:</span><span class="string">&quot;2023-02-02T14:42:36.820+00:00&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span><span class="number">500</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;error&quot;</span><span class="punctuation">:</span><span class="string">&quot;Internal Server Error&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;message&quot;</span><span class="punctuation">:</span><span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span><span class="string">&quot;/content/course&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>现在存在一个问题：并没有输出我们抛出异常时的指定异常信息，只有查看控制台日志才能看到异常信息</li>
</ul>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java<span class="selector-class">.lang</span><span class="selector-class">.RuntimeException</span>: 课程设置了收费，价格不能为空，且必须大于<span class="number">0</span></span><br></pre></td></tr></table></figure>

<ul>
<li>所以我们现在要对异常信息进行处理，异常处理除了输出在日志中，还需要提示给用户。</li>
<li>前端和后端需要做一些约定<ol>
<li>错误体会信息统一以json格式返回给前端</li>
<li>以HTTP状态码决定当前是否出错，非<code>200</code>状态码为操作异常</li>
</ol>
</li>
<li>那么如何规范异常信息？<ul>
<li>代码中统一抛出项目的自定义异常类型，这样可以统一去捕获这一类或几类的异常</li>
<li>规范了异常类型，就可以去获取异常信息</li>
<li>如果捕获了非项目自定义的异常类型，则统一向用户提示<code>执行过程异常，请重试</code>的错误信息</li>
</ul>
</li>
<li>如何捕获异常？<ul>
<li>代码统一使用try&#x2F;catch方式去捕获代码比较臃肿，可以通过SpringMVC提供的控制器增强类统一由一个类去完成异常的捕获<br><img src="/2025/04/21/%E5%AD%A6%E6%88%90-%E7%AC%94%E8%AE%B0/image-20250409150718120.png" alt="image-20250409150718120"></li>
</ul>
</li>
</ul>
<h4 id="统一异常处理实现"><a href="#统一异常处理实现" class="headerlink" title="统一异常处理实现"></a>统一异常处理实现</h4><ul>
<li><p>根据上面分析的方案，统一在base基础工程实现统一异常处理，各模块依赖了base基础工程，都可以使用</p>
</li>
<li><p>统一异常处理的步骤如下</p>
<ol>
<li>在base工程中添加依赖</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-log4j2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol>
<li>定义一个枚举类，枚举一些通用的异常信息</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* <span class="doctag">@description</span> 通用错误信息</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">CommonError</span> &#123;</span><br><span class="line">    UNKOWN_ERROR(<span class="string">&quot;执行过程异常，请重试&quot;</span>),</span><br><span class="line">    PARAS_ERROR(<span class="string">&quot;非法参数&quot;</span>),</span><br><span class="line">    OBJECT_NULL(<span class="string">&quot;对象为空&quot;</span>),</span><br><span class="line">    QUERY_NULL(<span class="string">&quot;查询结果为空&quot;</span>),</span><br><span class="line">    REQUEST_NULL(<span class="string">&quot;请求参数为空&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String errMessage;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getErrMessage</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> errMessage;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    CommonError(String errMessage) &#123;</span><br><span class="line">        <span class="built_in">this</span>.errMessage = errMessage;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>自定义异常类型</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* <span class="doctag">@description</span> 学成在线项目异常类</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">XueChengPlusException</span> <span class="keyword">extends</span> <span class="title class_">RuntimeException</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String errMessage;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getErrMessage</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> errMessage;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">XueChengPlusException</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>();<span class="comment">//父类无参构造器</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">XueChengPlusException</span><span class="params">(String errMessage)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(errMessage);</span><br><span class="line">        <span class="built_in">this</span>.errMessage = errMessage;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">cast</span><span class="params">(CommonError commonError)</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">XueChengPlusException</span>(commonError.getErrMessage());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">cast</span><span class="params">(String errMessage)</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">XueChengPlusException</span>(errMessage);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>响应用户的统一类型</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RestErrorResponse</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String errMessage;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li><p>全局异常处理器</p>
<ul>
<li>从Spring 3.0-Spring 3.2版本之间，对Spring架构和SpringMVC的Controller的异常捕获提供了相应的异常处理<ul>
<li><code>@ExceptionHandler</code>：<code>Spring3.0</code>提供的标识，在方法上或类上的注解，用于表明方法的处理异常类型</li>
<li><code>@ControllerAdvice</code>：<code>Spring3.2</code>提供的新注解，用于增强SpringMVC中的Controller。通常与<code>@ExceptionHandler</code>结合使用，来处理SpringMVC的异常信息</li>
<li><code>@ResponseStatus</code>：<code>Spring3.0</code>提供的标识在方法或类上的注解，用状态码和应返回的原因标记方法或异常类。调用处理程序方法时，状态码将应用于HTTP响应</li>
</ul>
</li>
<li>通过上面的注解便可实现微服务全局异常处理，具体代码如下</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* <span class="doctag">@description</span> 全局异常处理器</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@ControllerAdvice</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GlobalExceptionHandler</span> &#123;</span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="meta">@ExceptionHandler(XueChengPlusException.class)</span></span><br><span class="line">    <span class="meta">@ResponseStatus(HttpStatus.INTERNAL_SERVER_ERROR)</span> <span class="comment">// 该异常枚举错误码为500，</span></span><br><span class="line">    <span class="keyword">public</span> RestErrorResponse <span class="title function_">customException</span><span class="params">(XueChengPlusException exception)</span> &#123;</span><br><span class="line">        log.error(<span class="string">&quot;系统异常：&#123;&#125;&quot;</span>, exception.getErrMessage());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RestErrorResponse</span>(exception.getErrMessage());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="meta">@ExceptionHandler(Exception.class)</span></span><br><span class="line">    <span class="meta">@ResponseStatus(HttpStatus.INTERNAL_SERVER_ERROR)</span></span><br><span class="line">    <span class="keyword">public</span> RestErrorResponse <span class="title function_">exception</span><span class="params">(Exception exception)</span> &#123;</span><br><span class="line">        log.error(<span class="string">&quot;系统异常：&#123;&#125;&quot;</span>, exception.getMessage());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RestErrorResponse</span>(exception.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
</li>
</ul>
<h4 id="异常处理测试"><a href="#异常处理测试" class="headerlink" title="异常处理测试"></a>异常处理测试</h4><ul>
<li>在ContentAPI的启动类上添加<code>scanBasePackages = &quot;com.xuecheng&quot;</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableSwagger2Doc</span></span><br><span class="line"><span class="meta">@SpringBootApplication(scanBasePackages = &quot;com.xuecheng&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ContentApiApplication</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(ContentApiApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>在异常处理测试之前，我们首先要将代码中抛出自定义类型的异常，这个自定义异常类的文字设定常量类来保存</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (price == <span class="literal">null</span> || price.floatValue() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">    XueChengPlusException.cast(<span class="string">&quot;课程设置了收费，价格不能为空，且必须大于0&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>使用HTTP Client进行测试，故意将收费课程价格设置为负数，捕获到的响应信息如下</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">POST http<span class="punctuation">:</span><span class="comment">//localhost:53040/content/course</span></span><br><span class="line"></span><br><span class="line">HTTP/<span class="number">1.1</span> <span class="number">500</span> </span><br><span class="line">Content-Type<span class="punctuation">:</span> application/json</span><br><span class="line">Transfer-Encoding<span class="punctuation">:</span> chunked</span><br><span class="line">Date<span class="punctuation">:</span> Fri<span class="punctuation">,</span> <span class="number">03</span> Feb <span class="number">2023</span> <span class="number">02</span><span class="punctuation">:</span><span class="number">32</span><span class="punctuation">:</span><span class="number">20</span> GMT</span><br><span class="line">Connection<span class="punctuation">:</span> close</span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;errMessage&quot;</span><span class="punctuation">:</span> <span class="string">&quot;课程设置了收费，价格不能为空，且必须大于0&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>前后端联调，测试前端会不会抛出我们自定义的异常信息<br><a target="_blank" rel="noopener" href="https://s1.ax1x.com/2023/02/03/pSs9EpF.png"><img src="https://s1.ax1x.com/2023/02/03/pSs9EpF.png" alt="img"></a></li>
<li>那么至此，项目的异常处理测试完毕，我们在开发中对于业务分支中的错误，要抛出项目自定义的异常类型</li>
</ul>
<h4 id="面试"><a href="#面试" class="headerlink" title="面试"></a>面试</h4><ol>
<li>系统如何处理异常？<ul>
<li>我们自定义一个统一的异常处理器去捕获并处理异常</li>
<li>使用控制器增强注解@ControllerAdvice（也可以用@RestControllerAdvice）和异常处理注解@ExceptionHandler来实现</li>
</ul>
</li>
<li>如何处理自定义异常？<ul>
<li>程序在编写代码时，根据校验结果主动抛出自定义异常类对象，抛出异常时指定详细的异常信息，异常处理器捕获异常信息记录、异常日志，并响应给用户</li>
</ul>
</li>
<li>如何处理未知异常？<ul>
<li>接口执行过程中的一些运行时异常也会被异常处理器统一捕获，记录异常日志，统一响应给用户500错误</li>
<li>在异常处理其中还可以对某个异常类型进行单独处理（使用@ExceptionHandler来声明要捕获的异常类型）</li>
</ul>
</li>
</ol>
<h2 id="JSR303校验"><a href="#JSR303校验" class="headerlink" title="JSR303校验"></a>JSR303校验</h2><h4 id="统一校验的需求"><a href="#统一校验的需求" class="headerlink" title="统一校验的需求"></a>统一校验的需求</h4><ul>
<li>前端请求后端接口传输参数，是在Controller中校验还是Service中校验？<ul>
<li>答案是都需要校验，只是分工不同</li>
</ul>
</li>
<li>Controller中校验请求参数的合法性，包括：必填项校验、数据格式校验，比如：参数是否符合一定的日期格式等<ul>
<li><code>Controller</code>中可以将校验的代码写成通用代码</li>
</ul>
</li>
<li>Service中要校验的是业务规则相关的内容，比如：课程已经审核通过，所以提交失败等<ul>
<li><code>Service</code>中需要根据业务规则去校验，所以不方便写成通用代码</li>
</ul>
</li>
<li>早在<code>JavaEE6</code>规范中，就定义了<strong>参数校验的规范</strong>，它就是<code>JSR-303</code>，它定义了<code>Bean Validation</code>，即对bean属性进行校验</li>
<li><code>SpringBoot</code>提供了<code>JSR-303</code>的支持，它就是<code>spring-boot-stater-validation</code>，它的底层使用<code>Hibernate Validation</code>，<code>Hibernate Validation</code>是<code>Bean Validation</code>的参考实现</li>
<li>所以我们打算在<code>Controller</code>层使用<code>spring-boot-stater-validation</code>完成对参数的基本合法性进行校验</li>
</ul>
<h4 id="统一校验实现"><a href="#统一校验实现" class="headerlink" title="统一校验实现"></a>统一校验实现</h4><ul>
<li>首先在Base工程中引入<code>spring-boot-starter-validation</code>依赖</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-validation<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>现在准备对内容管理模块添加课程接口进行校验</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiOperation(&quot;新增课程基础信息接口&quot;)</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/course&quot;)</span></span><br><span class="line"><span class="keyword">public</span> CourseBaseInfoDto <span class="title function_">createCourseBase</span><span class="params">(<span class="meta">@RequestBody</span> AddCourseDto addCourseDto)</span> &#123;</span><br><span class="line">    <span class="comment">// 机构id，暂时硬编码模拟假数据</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">companyId</span> <span class="operator">=</span> <span class="number">22L</span>;</span><br><span class="line">    <span class="keyword">return</span> courseBaseInfoService.createCourseBase(companyId, addCourseDto);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>此接口使用AddCourseDto模型对象接收参数，所以进入AddCourseDto模型类，在属性上添加校验规则</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ApiModel(value = &quot;AddCourseDto&quot;, description = &quot;新增课程基本信息&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AddCourseDto</span> &#123;</span><br><span class="line"></span><br><span class="line">+   <span class="meta">@NotEmpty(message = &quot;课程名称不能为空&quot;)</span></span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;课程名称&quot;, required = true)</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">+   <span class="meta">@NotEmpty(message = &quot;适用人群不能为空&quot;)</span></span><br><span class="line">+   <span class="meta">@Size(min = 10, message = &quot;适用人群内容过少，至少10个字符&quot;)</span></span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;适用人群&quot;, required = true)</span></span><br><span class="line">    <span class="keyword">private</span> String users;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;课程标签&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String tags;</span><br><span class="line"></span><br><span class="line">+   <span class="meta">@NotEmpty(message = &quot;课程分类不能为空&quot;)</span></span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;大分类&quot;, required = true)</span></span><br><span class="line">    <span class="keyword">private</span> String mt;</span><br><span class="line"></span><br><span class="line">+   <span class="meta">@NotEmpty(message = &quot;课程分类不能为空&quot;)</span></span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;小分类&quot;, required = true)</span></span><br><span class="line">    <span class="keyword">private</span> String st;</span><br><span class="line"></span><br><span class="line">+   <span class="meta">@NotEmpty(message = &quot;课程等级不能为空&quot;)</span></span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;课程等级&quot;, required = true)</span></span><br><span class="line">    <span class="keyword">private</span> String grade;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;教学模式（普通，录播，直播等）&quot;, required = true)</span></span><br><span class="line">    <span class="keyword">private</span> String teachmode;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;课程介绍&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String description;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;课程图片&quot;, required = true)</span></span><br><span class="line">    <span class="keyword">private</span> String pic;</span><br><span class="line"></span><br><span class="line">+   <span class="meta">@NotEmpty(message = &quot;收费规则不能为空&quot;)</span></span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;收费规则，对应数据字典&quot;, required = true)</span></span><br><span class="line">    <span class="keyword">private</span> String charge;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;价格&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Float price;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;原价&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Float originalPrice;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;qq&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String qq;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;微信&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String wechat;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;电话&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String phone;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;有效期&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Integer validDays;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>上面用到了<code>@NotEmpty</code>和<code>@Size</code>两个注解，<code>@NotEmpty</code>表示属性不能为空，<code>@Size</code>表示限制属性内容的长度</li>
<li>在javax.validation.constraints包下有很多这样的校验注解</li>
</ul>
<table>
<thead>
<tr>
<th align="center">限制</th>
<th align="center">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center">@Nul</td>
<td align="center">限制只能为null</td>
</tr>
<tr>
<td align="center">@NotNull</td>
<td align="center">限制制必须不为null</td>
</tr>
<tr>
<td align="center">@AssertFalse</td>
<td align="center">限制必须为false</td>
</tr>
<tr>
<td align="center">@AssertTrue</td>
<td align="center">限制必须为true</td>
</tr>
<tr>
<td align="center">@DecimalMax(value)</td>
<td align="center">限制必须为一个不大于指定值的数字</td>
</tr>
<tr>
<td align="center">@DecimalMin(value)</td>
<td align="center">限制必须为一个不小于指定值的数字</td>
</tr>
<tr>
<td align="center">@Digits(integer fraction</td>
<td align="center">限制必须为一个小数，且整数部分的位数不能超过integer，小数部分的位数不能超过fraction</td>
</tr>
<tr>
<td align="center">@Future</td>
<td align="center">限制必须是一个将来的日期</td>
</tr>
<tr>
<td align="center">@Max(value)</td>
<td align="center">限制必须为一个不大于指定值的数字</td>
</tr>
<tr>
<td align="center">@Min(value)</td>
<td align="center">限制必须为一个不小于指定值的数字</td>
</tr>
<tr>
<td align="center">@Past</td>
<td align="center">限制必须是一个过去的日期</td>
</tr>
<tr>
<td align="center">@Pattern(value)</td>
<td align="center">限制必须符合指定的正则表达式</td>
</tr>
<tr>
<td align="center">@Size(max, min)</td>
<td align="center">限制字符长度必须在min到max之间</td>
</tr>
<tr>
<td align="center">@NotEmpty</td>
<td align="center">验证注解的元素值不为null且不为空(字符串长度不为0、集合大小不为0)</td>
</tr>
<tr>
<td align="center">@NotBlank</td>
<td align="center">验证注解的元素值不为空(不为null、去除首位空格后长度为0)，不同于@NotEmpty,@NotBlank只应用于字符串且在比较时会去除字符串的空格</td>
</tr>
<tr>
<td align="center">@Email</td>
<td align="center">验证注解的元素值是Email，也可以通过正则表达式和flag指定自定义的email格式</td>
</tr>
</tbody></table>
<ul>
<li>定义好了规则校验，还需要开启校验，在Controller方法中添加<code>@Validated</code>注解，如下</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiOperation(&quot;新增课程基础信息接口&quot;)</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/course&quot;)</span></span><br><span class="line"><span class="keyword">public</span> CourseBaseInfoDto <span class="title function_">createCourseBase</span><span class="params">(<span class="meta">@RequestBody</span> <span class="meta">@Validated</span> AddCourseDto addCourseDto)</span> &#123;</span><br><span class="line">    <span class="comment">// 机构id，暂时硬编码模拟假数据</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">companyId</span> <span class="operator">=</span> <span class="number">22L</span>;</span><br><span class="line">    <span class="keyword">return</span> courseBaseInfoService.createCourseBase(companyId, addCourseDto);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>如果校验出错，Spring会抛出<code>MethodArgumentNotValidException</code>异常，我们需要在全局异常处理器中捕获异常，解析出异常信息</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ExceptionHandler(MethodArgumentNotValidException.class)</span></span><br><span class="line"><span class="meta">@ResponseStatus(HttpStatus.INTERNAL_SERVER_ERROR)</span></span><br><span class="line"><span class="keyword">public</span> RestErrorResponse <span class="title function_">doMethodArgumentNotValidException</span><span class="params">(MethodArgumentNotValidException exception)</span> &#123;</span><br><span class="line">    <span class="comment">// 由于用户输入的内容可能存在多处错误，所以我们要将所有错误信息都提示给用户</span></span><br><span class="line">    <span class="type">BindingResult</span> <span class="variable">bindingResult</span> <span class="operator">=</span> exception.getBindingResult();</span><br><span class="line">    <span class="comment">// 获取错误集合</span></span><br><span class="line">    List&lt;FieldError&gt; fieldErrors = bindingResult.getFieldErrors();</span><br><span class="line">    <span class="comment">// 拼接字符串</span></span><br><span class="line">    <span class="type">StringBuffer</span> <span class="variable">stringBuffer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>();</span><br><span class="line">    fieldErrors.forEach(fieldError -&gt; stringBuffer.append(fieldError.getDefaultMessage()).append(<span class="string">&quot;,&quot;</span>));</span><br><span class="line">    <span class="comment">// 记录日志</span></span><br><span class="line">    log.error(stringBuffer.toString());</span><br><span class="line">    <span class="comment">// 响应给用户</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RestErrorResponse</span>(stringBuffer.toString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>重启内容管理服务，使用HTTP Client进行测试，将必填项设置为空，适用人群设置小于10个字，执行测试，接口响应结果如下</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">POST http<span class="punctuation">:</span><span class="comment">//localhost:53040/content/course</span></span><br><span class="line"></span><br><span class="line">HTTP/<span class="number">1.1</span> <span class="number">500</span> </span><br><span class="line">Content-Type<span class="punctuation">:</span> application/json</span><br><span class="line">Transfer-Encoding<span class="punctuation">:</span> chunked</span><br><span class="line">Date<span class="punctuation">:</span> Fri<span class="punctuation">,</span> <span class="number">03</span> Feb <span class="number">2023</span> <span class="number">04</span><span class="punctuation">:</span><span class="number">52</span><span class="punctuation">:</span><span class="number">30</span> GMT</span><br><span class="line">Connection<span class="punctuation">:</span> close</span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;errMessage&quot;</span><span class="punctuation">:</span> <span class="string">&quot;课程名称不能为空,适用人群内容过少，至少10个字符,&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>可以看到校验器已生效</li>
</ul>
<h4 id="分组校验"><a href="#分组校验" class="headerlink" title="分组校验"></a>分组校验</h4><ul>
<li>有时候在同一个属性上设置一个校验规则不能满足要求<ul>
<li>比如：订单标号是由系统生成，所以在添加订单时，要求订单编号为空；但是在更新订单时，要求订单编号不能为空。</li>
</ul>
</li>
<li><strong>此时就需要用到分组校验，在同一个属性定义多个校验规则属于不同的分组</strong><ul>
<li>比如：添加订单定义<code>@NULL</code>规则属于<code>insert</code>分组，更新订单定义<code>@NotEmpty</code>属于<code>update</code>分组，<code>insert</code>和<code>update</code>是分组的名称，可以自定义的</li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Null(message = &quot;订单id需为空&quot;, groups = Insert.class)</span></span><br><span class="line"><span class="meta">@NotEmpty(message = &quot;订单id不能为空&quot;, groups = Update.class)</span></span><br><span class="line"><span class="keyword">private</span> String id;</span><br></pre></td></tr></table></figure>

<ul>
<li>下面举例说明，我们用class类型来表示不同的分组，所以我们定义不同的接口类型（空接口）表示不同的分组，由于校验分组是公用的，所以定义在base工程中</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.base.exception;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 校验分组</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ValidationGroups</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Insert</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Update</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Delete</span>&#123;&#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>下面在定义校验规则时指定分组</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@NotEmpty(message = &quot;添加课程名称不能为空&quot;, groups = ValidationGroups.Insert.class)</span></span><br><span class="line"><span class="meta">@NotEmpty(message = &quot;修改课程名称不能为空&quot;, groups = ValidationGroups.Update.class)</span></span><br><span class="line"><span class="meta">@ApiModelProperty(value = &quot;课程名称&quot;, required = true)</span></span><br><span class="line"><span class="keyword">private</span> String name;</span><br></pre></td></tr></table></figure>

<ul>
<li>在Controller方法中启动校验规则时指定要使用的分组名</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiOperation(&quot;新增课程基础信息接口&quot;)</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/course&quot;)</span></span><br><span class="line"><span class="keyword">public</span> CourseBaseInfoDto <span class="title function_">createCourseBase</span><span class="params">(<span class="meta">@RequestBody</span> <span class="meta">@Validated(ValidationGroups.Insert.class)</span> AddCourseDto addCourseDto)</span> &#123;<span class="comment">//指定分组使用Insert.class</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">companyId</span> <span class="operator">=</span> <span class="number">22L</span>;</span><br><span class="line">    <span class="keyword">return</span> courseBaseInfoService.createCourseBase(companyId, addCourseDto);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>重启服务，使用HTTP Client&#x2F;PostMan进行测试</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">POST http<span class="punctuation">:</span><span class="comment">//localhost:53040/content/course</span></span><br><span class="line"></span><br><span class="line">HTTP/<span class="number">1.1</span> <span class="number">500</span> </span><br><span class="line">Content-Type<span class="punctuation">:</span> application/json</span><br><span class="line">Transfer-Encoding<span class="punctuation">:</span> chunked</span><br><span class="line">Date<span class="punctuation">:</span> Fri<span class="punctuation">,</span> <span class="number">03</span> Feb <span class="number">2023</span> <span class="number">05</span><span class="punctuation">:</span><span class="number">28</span><span class="punctuation">:</span><span class="number">23</span> GMT</span><br><span class="line">Connection<span class="punctuation">:</span> close</span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;errMessage&quot;</span><span class="punctuation">:</span> <span class="string">&quot;添加课程名称不能为空,&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>由于这里指定的是Insert分组，所以抛出异常信息<code>添加课程名称不能为空</code>，如果修改分组为Update分组，则异常信息为<code>修改课程名称不能为空</code>，符合我们的预期</li>
</ul>
<h4 id="校验规则不满足？"><a href="#校验规则不满足？" class="headerlink" title="校验规则不满足？"></a>校验规则不满足？</h4><ul>
<li>如果javax.validation.constraints包下的校验规则满足不了需求怎么办？<ol>
<li>手写校验代码</li>
<li>自定义校验规则注解</li>
</ol>
</li>
</ul>
<h4 id="面试-1"><a href="#面试-1" class="headerlink" title="面试"></a>面试</h4><ul>
<li>请求参数的合法性如何校验？<ul>
<li>使用基于<code>JSR-303</code>的校验框架实现，<code>SpringBoot</code>提供了<code>JSR-303</code>的支持，它就是<code>spring-boot-starter-validation</code>，它包括了很多校验规则，只需要在模型类中通过注解指定校验规则，在<code>Controller</code>方法上开启校验。</li>
</ul>
</li>
</ul>
<h1 id="sql"><a href="#sql" class="headerlink" title="sql"></a>sql</h1><h2 id="xml语句"><a href="#xml语句" class="headerlink" title="xml语句"></a>xml语句</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;selectTreeNodes&quot;</span> <span class="attr">resultMap</span>=<span class="string">&quot;treeNodeResultMap&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- SQL查询语句 --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong><code>&lt;select&gt;</code> 标签</strong></p>
<ul>
<li>这是MyBatis中定义查询语句的根元素</li>
<li><code>id=&quot;selectTreeNodes&quot;</code>：指定该查询的唯一标识符，在Java代码中通过这个ID调用</li>
<li><code>resultMap=&quot;treeNodeResultMap&quot;</code>：指定结果集映射到Java对象的规则</li>
</ul>
<p>完整的xml：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;com.example.mapper.CategoryMapper&quot;</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">id</span>=<span class="string">&quot;treeNodeResultMap&quot;</span> <span class="attr">type</span>=<span class="string">&quot;com.example.model.TreeNode&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 一级节点映射 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span> <span class="attr">property</span>=<span class="string">&quot;id&quot;</span> <span class="attr">column</span>=<span class="string">&quot;one_id&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">&quot;name&quot;</span> <span class="attr">column</span>=<span class="string">&quot;one_name&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">&quot;parentId&quot;</span> <span class="attr">column</span>=<span class="string">&quot;one_parentid&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">&quot;orderby&quot;</span> <span class="attr">column</span>=<span class="string">&quot;one_orderby&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">&quot;label&quot;</span> <span class="attr">column</span>=<span class="string">&quot;one_label&quot;</span>/&gt;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">&lt;!-- 二级节点集合 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">collection</span> <span class="attr">property</span>=<span class="string">&quot;children&quot;</span> <span class="attr">ofType</span>=<span class="string">&quot;com.example.model.TreeNode&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span> <span class="attr">property</span>=<span class="string">&quot;id&quot;</span> <span class="attr">column</span>=<span class="string">&quot;two_id&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">&quot;name&quot;</span> <span class="attr">column</span>=<span class="string">&quot;two_name&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">&quot;parentId&quot;</span> <span class="attr">column</span>=<span class="string">&quot;two_parentid&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">&quot;orderby&quot;</span> <span class="attr">column</span>=<span class="string">&quot;two_orderby&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">&quot;label&quot;</span> <span class="attr">column</span>=<span class="string">&quot;two_label&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">collection</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;selectTreeNodes&quot;</span> <span class="attr">resultMap</span>=<span class="string">&quot;treeNodeResultMap&quot;</span>&gt;</span></span><br><span class="line">        select</span><br><span class="line">            one.id            one_id,</span><br><span class="line">            one.name          one_name,</span><br><span class="line">            one.parentid      one_parentid,</span><br><span class="line">            one.orderby       one_orderby,</span><br><span class="line">            one.label         one_label,</span><br><span class="line">            two.id            two_id,</span><br><span class="line">            two.name          two_name,</span><br><span class="line">            two.parentid      two_parentid,</span><br><span class="line">            two.orderby       two_orderby,</span><br><span class="line">            two.label         two_label</span><br><span class="line">        from course_category one</span><br><span class="line">                 inner join course_category two on one.id = two.parentid</span><br><span class="line">        where one.parentid = &#x27;1&#x27;</span><br><span class="line">          and one.is_show = 1</span><br><span class="line">          and two.is_show = 1</span><br><span class="line">        order by one.orderby, two.orderby</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="递归查询树形结构的sql"><a href="#递归查询树形结构的sql" class="headerlink" title="递归查询树形结构的sql"></a>递归查询树形结构的sql</h2><p>语法：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">WITH</span> <span class="keyword">RECURSIVE</span> t1 <span class="keyword">AS</span> (</span><br><span class="line">    <span class="keyword">SELECT</span> <span class="number">1</span> <span class="keyword">AS</span> n</span><br><span class="line">    <span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line">    <span class="keyword">SELECT</span> n <span class="operator">+</span> <span class="number">1</span> <span class="keyword">FROM</span> t1 <span class="keyword">WHERE</span> n <span class="operator">&lt;</span> <span class="number">5</span></span><br><span class="line">)</span><br><span class="line">SELECCT <span class="operator">*</span> <span class="keyword">FROM</span> t1;</span><br></pre></td></tr></table></figure>

<p>语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">WITH</span> <span class="keyword">RECURSIVE</span> t1 <span class="keyword">AS</span> (</span><br><span class="line">    <span class="comment">-- 基础查询(锚成员)</span></span><br><span class="line">    <span class="keyword">SELECT</span> p.<span class="operator">*</span> <span class="keyword">FROM</span> course_category p <span class="keyword">WHERE</span> p.id <span class="operator">=</span> <span class="string">&#x27;1&#x27;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 递归查询(递归成员)</span></span><br><span class="line">    <span class="keyword">SELECT</span> c.<span class="operator">*</span> <span class="keyword">FROM</span> course_category c <span class="keyword">JOIN</span> t1 <span class="keyword">WHERE</span> c.parentid <span class="operator">=</span> t1.id</span><br><span class="line">)</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> t1;</span><br></pre></td></tr></table></figure>

<h3 id="执行步骤解析"><a href="#执行步骤解析" class="headerlink" title="执行步骤解析"></a>执行步骤解析</h3><ol>
<li><strong>初始化阶段(基础查询)</strong>:<ul>
<li>首先执行<code>SELECT p.* FROM course_category p WHERE p.id = &#39;1&#39;</code></li>
<li>获取ID为’1’的根节点记录</li>
<li>这个结果集形成递归CTE的初始结果(第一代)</li>
</ul>
</li>
<li><strong>递归阶段</strong>:<ul>
<li>然后执行<code>SELECT c.* FROM course_category c JOIN t1 WHERE c.parentid = t1.id</code></li>
<li>将<code>course_category</code>表与当前CTE结果(t1)连接</li>
<li>找出所有父节点ID等于当前结果集中节点ID的记录</li>
<li>这些新记录被添加到结果集中(下一代)</li>
</ul>
</li>
<li><strong>终止条件</strong>:<ul>
<li>递归会一直进行，直到不再有新记录被添加到结果集</li>
<li>当<code>JOIN</code>操作不再产生新行时，递归终止</li>
</ul>
</li>
<li><strong>最终输出</strong>:<ul>
<li>最后<code>SELECT * FROM t1</code>返回所有递归查询到的记录</li>
</ul>
</li>
</ol>
<h1 id="认证授权"><a href="#认证授权" class="headerlink" title="认证授权"></a>认证授权</h1><p>用户认证：需要验证用户身份信息才行</p>
<p>用户授权：不同用户有不同的角色，不同的角色有不同的访问权限</p>
<p>认证授权做三件：</p>
<ul>
<li>统一认证：所以的用户登录使用同一个入口登录</li>
<li>单点登录：SSO,认证一次就可以再多个拥有访问权限的系统中访问</li>
<li>第三方认证：如何实现微信扫码认证登录</li>
</ul>
<h2 id="框架-Spring-Security"><a href="#框架-Spring-Security" class="headerlink" title="框架-Spring Security"></a>框架-Spring Security</h2><ul>
<li>依赖</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-oauth2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>Spring Security提供认证和授权服务：</p>
<p>在Controller方法上加上： @PreAuthorize(“hasAuthority(‘p1’)”)&#x2F;&#x2F;拥有p1权限方可访问</p>
<p>注意：如果访问上不加@PreAuthorize，此方法没有授权控制。</p>
<h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><p>Spring Security所解决的问题就是<strong>安全访问控制</strong>，而安全访问控制功能其实就是对所有进入系统的请求进行拦截，校验每个请求是否能够访问它所期望的资源。根据前边知识的学习，可以通过Filter或AOP等技术来实现，Spring Security对Web资源的保护是靠Filter实现的，所以从这个Filter来入手，逐步深入Spring Security原理。</p>
<p><img src="/2025/04/21/%E5%AD%A6%E6%88%90-%E7%AC%94%E8%AE%B0/image-20250422093237855.png" alt="image-20250422093237855"></p>
<p>FilterChainProxy是一个代理，真正起作用的是FilterChainProxy中SecurityFilterChain所包含的各个Filter，同时这些Filter作为Bean被Spring管理，它们是Spring Security核心，各有各的职责，但他们并不直接处理用户的<strong>认证</strong>，也不直接处理用户的<strong>授权</strong>，而是把它们交给了认证管理器（AuthenticationManager）和决策管理器（AccessDecisionManager）进行处理。</p>
<p>spring Security功能的实现主要是由一系列过滤器链相互配合完成。</p>
<p><img src="/2025/04/21/%E5%AD%A6%E6%88%90-%E7%AC%94%E8%AE%B0/image-20250422093245992.png" alt="image-20250422093245992"></p>
<p>下面介绍过滤器链中主要的几个过滤器及其作用：</p>
<p><strong>SecurityContextPersistenceFilter</strong> 这个Filter是整个拦截过程的入口和出口（也就是第一个和最后一个拦截器），会在请求开始时从配置好的 SecurityContextRepository 中获取 SecurityContext，然后把它设置给 SecurityContextHolder。在请求完成后将 SecurityContextHolder 持有的 SecurityContext 再保存到配置好的 SecurityContextRepository，同时清除 securityContextHolder 所持有的 SecurityContext；</p>
<p><strong>UsernamePasswordAuthenticationFilter</strong> 用于处理来自表单提交的认证。该表单必须提供对应的用户名和密码，其内部还有登录成功或失败后进行处理的 AuthenticationSuccessHandler 和 AuthenticationFailureHandler，这些都可以根据需求做相关改变；</p>
<p><strong>FilterSecurityInterceptor</strong> 是用于保护web资源的，使用AccessDecisionManager对当前用户进行授权访问，前面已经详细介绍过了；</p>
<p><strong>ExceptionTranslationFilter</strong> 能够捕获来自 FilterChain 所有的异常，并进行处理。但是它只会处理两类异常：AuthenticationException 和 AccessDeniedException，其它的异常它会继续抛出。</p>
<h3 id="执行流程：—–核心也是代码编程的核心"><a href="#执行流程：—–核心也是代码编程的核心" class="headerlink" title="执行流程：—–核心也是代码编程的核心"></a>执行流程：—–核心也是代码编程的核心</h3><p><img src="/2025/04/21/%E5%AD%A6%E6%88%90-%E7%AC%94%E8%AE%B0/image-20250422093407869.png" alt="image-20250422093407869"></p>
<ol>
<li>用户提交用户名、密码被SecurityFilterChain中的<code>UsernamePasswordAuthenticationFilter</code>过滤器获取到，封装为请求Authentication，通常情况下是UsernamePasswordAuthenticationToken这个实现类。</li>
<li>然后过滤器将Authentication提交至认证管理器（AuthenticationManager）进行认证</li>
<li>认证成功后，<code>AuthenticationManager</code>身份管理器返回一个被填充满了信息的（包括上面提到的权限信息，身份信息，细节信息，但密码通常会被移除）<code>Authentication</code>实例。</li>
<li><code>SecurityContextHolder</code>安全上下文容器将第3步填充了信息的<code>Authentication</code>，通过SecurityContextHolder.getContext().setAuthentication(…)方法，设置到其中。</li>
<li>可以看出AuthenticationManager接口（认证管理器）是认证相关的核心接口，也是发起认证的出发点，它的实现类为ProviderManager。而Spring Security支持多种认证方式，因此ProviderManager维护着一个<code>List&lt;AuthenticationProvider&gt;</code>列表，存放多种认证方式，最终实际的认证工作是由AuthenticationProvider完成的。咱们知道web表单的对应的AuthenticationProvider实现类为DaoAuthenticationProvider，它的内部又维护着一个UserDetailsService负责UserDetails的获取。最终AuthenticationProvider将UserDetails填充至Authentication。</li>
</ol>
<p><strong>之后编写代码时会体现这个流程</strong></p>
<h2 id="OAuth2"><a href="#OAuth2" class="headerlink" title="OAuth2"></a>OAuth2</h2><h3 id="工作流程"><a href="#工作流程" class="headerlink" title="工作流程"></a>工作流程</h3><p>OAuth2第三方安全认证登录协议：第三方认证方式。</p>
<p>例子：扫码登录流程</p>
<p><img src="/2025/04/21/%E5%AD%A6%E6%88%90-%E7%AC%94%E8%AE%B0/image-20250422093727683.png" alt="image-20250422093727683"></p>
<p>流程图很清晰就是一个扫码登录的流程，注意微信用户信息下放肯定也是一些简单的信息，未注册则补充注册网站用户</p>
<p>oauth2.0认证流程</p>
<p><img src="/2025/04/21/%E5%AD%A6%E6%88%90-%E7%AC%94%E8%AE%B0/image-20250422094044506.png" alt="image-20250422094044506"></p>
<p>Oauth2包括以下角色：</p>
<p>1、客户端</p>
<p>本身不存储资源，需要通过资源拥有者的授权去请求资源服务器的资源，比如：手机客户端、浏览器等。</p>
<p>上边示例中黑马网站即为客户端，它需要通过浏览器打开。</p>
<p>2、资源拥有者</p>
<p>通常为用户，也可以是应用程序，即该资源的拥有者。</p>
<p>A表示 客户端请求资源拥有者授权。</p>
<p>B表示 资源拥有者授权客户端即黑马网站访问自己的用户信息。</p>
<p>3、授权服务器（也称认证服务器）</p>
<p>认证服务器对资源拥有者进行认证，还会对客户端进行认证并颁发令牌。</p>
<p>C 客户端即黑马网站携带授权码请求认证。</p>
<p>D认证通过颁发令牌。</p>
<p>4、资源服务器</p>
<p>存储资源的服务器。</p>
<p>E表示客户端即黑马网站携带令牌请求资源服务器获取资源。</p>
<p>F表示资源服务器校验令牌通过后提供受保护资源。</p>
<h3 id="授权模式"><a href="#授权模式" class="headerlink" title="授权模式"></a>授权模式</h3><p>pring Security支持OAuth2认证，OAuth2提供授权码模式、密码模式、简化模式、客户端模式等四种授权模式，前边举的微信扫码登录的例子就是基于授权码模式，一般来说就使用授权码和密码模式即可</p>
<h4 id="授权码模式"><a href="#授权码模式" class="headerlink" title="授权码模式"></a>授权码模式</h4><p>授权码模式简单理解是使用授权码去获取令牌，要想获取令牌先要获取授权码，授权码的获取需要资源拥有者亲自授权同意才可以获取。</p>
<p><img src="/2025/04/21/%E5%AD%A6%E6%88%90-%E7%AC%94%E8%AE%B0/image-20250422094226875.png" alt="image-20250422094226875"></p>
<p>1、用户打开浏览器。</p>
<p>2、通过浏览器访问客户端即黑马网站。</p>
<p>3、用户通过浏览器向认证服务请求授权，请求授权时会携带客户端的URL，此URL为下发授权码的重定向地址。</p>
<p>4、认证服务向资源拥有者返回授权页面。</p>
<p>5、资源拥有者亲自授权同意。</p>
<p>6、通过浏览器向认证服务发送授权同意。</p>
<p>7、认证服务向客户端地址重定向并携带授权码。</p>
<p>8、客户端即黑马网站收到授权码。</p>
<p>9、客户端携带授权码向认证服务申请令牌。</p>
<p>10、认证服务向客户端颁发令牌。</p>
<h4 id="密码模式"><a href="#密码模式" class="headerlink" title="密码模式"></a>密码模式</h4><p>密码模式相对授权码模式简单，授权码模式需要借助浏览器供用户亲自授权，密码模式不用借助浏览器</p>
<p><img src="/2025/04/21/%E5%AD%A6%E6%88%90-%E7%AC%94%E8%AE%B0/image-20250422094432620.png" alt="image-20250422094432620"></p>
<p>1、资源拥有者提供账号和密码</p>
<p>2、客户端向认证服务申请令牌，请求中携带账号和密码</p>
<p>3、认证服务校验账号和密码正确颁发令牌。</p>
<h2 id="JWT"><a href="#JWT" class="headerlink" title="JWT"></a>JWT</h2><h3 id="普通令牌"><a href="#普通令牌" class="headerlink" title="普通令牌"></a>普通令牌</h3><p>就是校验令牌需要远程请求认证服务，客户端的每次访问都会远程校验，执行性能低。</p>
<p><strong>如果能够让资源服务自己校验令牌的合法性将省去远程请求认证服务的成本</strong>，提高了性能</p>
<p><img src="/2025/04/21/%E5%AD%A6%E6%88%90-%E7%AC%94%E8%AE%B0/image-20250422094612244.png" alt="image-20250422094612244"></p>
<p><img src="/2025/04/21/%E5%AD%A6%E6%88%90-%E7%AC%94%E8%AE%B0/image-20250422094633352.png" alt="image-20250422094633352"></p>
<p>由1-&gt;2就是JWT做出的改进，令牌采用JWT格式即可解决上边的问题，用户认证通过后会得到一个JWT令牌，JWT令牌中已经包括了用户相关的信息，客户端只需要携带JWT访问资源服务，资源服务根据事先约定的算法自行完成令牌校验，无需每次都请求认证服务完成授权。</p>
<h3 id="JWT令牌"><a href="#JWT令牌" class="headerlink" title="JWT令牌"></a>JWT令牌</h3><ul>
<li>它定义了一种简洁的、自包含的协议格式，用于在通信双方传递json对象，传递的信息经过数字签名可以被验证和信任，它可以使用HMAC算法或使用RSA的公钥&#x2F;私钥对来签名，防止内容篡改</li>
<li>实现无状态认证，传统session方式需要将用户信息存放在服务端，用户访问服务，就需要去服务器查看session,有则认证成功允许访问，无则不允许；如果是基于令牌技术在分布式系统中实现认证则服务端不用存储session，可以将用户身份信息存储在令牌中，用户认证通过后认证服务颁发令牌给用户，用户将令牌存储在客户端，去访问应用服务时携带令牌去访问，服务端从jwt解析出用户信息。这个过程就是无状态认证。差距就是用户请求服务后服务需不需要去服务器上检验认证，Session就需要，而token就不需要了</li>
</ul>
<h4 id="结构"><a href="#结构" class="headerlink" title="结构"></a>结构</h4><p>JWT令牌由三部分组成，每部分中间使用点（.）分隔，比如：xxxxx.yyyyy.zzzzz</p>
<ul>
<li><p>Header        </p>
<p>头部包括令牌的类型（即JWT）及使用的哈希算法（如HMAC SHA256或RSA）</p>
<p>一个例子如下： 下边是Header部分的内容</p>
</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> <span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;alg&quot;</span><span class="punctuation">:</span> <span class="string">&quot;HS256&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;typ&quot;</span><span class="punctuation">:</span> <span class="string">&quot;JWT&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>将上边的内容使用Base64Url编码，得到一个字符串就是JWT令牌的第一部分。</p>
<ul>
<li><p>Payload</p>
<p>第二部分是负载，内容也是一个json对象，它是存放有效信息的地方，它可以存放jwt提供的信息字段，比如：iss（签发者）,exp（过期时间戳）, sub（面向的用户）等，也可自定义字段。</p>
<p>此部分不建议存放敏感信息，因为此部分可以解码还原原始内容。</p>
<p>最后将第二部分负载使用Base64Url编码，得到一个字符串就是JWT令牌的第二部分。</p>
<p>一个例子：</p>
</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;sub&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1234567890&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;456&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;admin&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>Signature</li>
</ul>
<p>  第三部分是签名，此部分用于防止jwt内容被篡改。</p>
<p>  这个部分使用base64url将前两部分进行编码，编码后使用点（.）连接组成字符串，最后使用header中声明的签名算法进行签名。</p>
<p>JWT缺点就是太长了，密钥泄露可以伪造因为什么都可以还原</p>
<h2 id="网关认证"><a href="#网关认证" class="headerlink" title="网关认证"></a>网关认证</h2><p><img src="/2025/04/21/%E5%AD%A6%E6%88%90-%E7%AC%94%E8%AE%B0/image-20250422095812201.png" alt="image-20250422095812201"></p>
<p>所有访问微服务的请求都要经过网关，在网关进行用户身份的认证可以将很多非法的请求拦截到微服务以外，这叫做网关认证。</p>
<p>1、网站白名单维护</p>
<p>针对不用认证的URL全部放行。</p>
<p>2、校验jwt的合法性。</p>
<p>除了白名单剩下的就是需要认证的请求，网关需要验证jwt的合法性，jwt合法则说明用户身份合法，否则说明身份不合法则拒绝继续访问。</p>
<h2 id="用户认证实现"><a href="#用户认证实现" class="headerlink" title="用户认证实现"></a>用户认证实现</h2><h3 id="框架认证"><a href="#框架认证" class="headerlink" title="框架认证"></a>框架认证</h3><p>账号密码认证、手机验证码认证、扫码登录等。本项目也要支持多种认证试</p>
<p><img src="/2025/04/21/%E5%AD%A6%E6%88%90-%E7%AC%94%E8%AE%B0/image-20250422100007291.png" alt="image-20250422100007291"></p>
<p>使用SpringSecurity我们只要实现UserDetailsService 接口查询数据库得到用户信息返回UserDetails 类型的用户信息即可,框架调用loadUserByUsername()方法拿到用户信息之后是如何执行的，见下图：</p>
<p><img src="/2025/04/21/%E5%AD%A6%E6%88%90-%E7%AC%94%E8%AE%B0/image-20250422100144158.png" alt="image-20250422100144158"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.ucenter.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.ucenter.mapper.XcUserMapper;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.ucenter.model.po.XcUser;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.User;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetails;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetailsService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UsernameNotFoundException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/28 18:09</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">UserDetailsService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    XcUserMapper xcUserMapper;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@description</span> 根据账号查询用户信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> s  账号</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> org.springframework.security.core.userdetails.UserDetails</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="comment">//自定义loadUserByUsername，返回一个UserDetails</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> UserDetails <span class="title function_">loadUserByUsername</span><span class="params">(String s)</span> <span class="keyword">throws</span> UsernameNotFoundException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//根据账户名取，非主键不用Byid，用selectOne</span></span><br><span class="line">        <span class="type">XcUser</span> <span class="variable">user</span> <span class="operator">=</span> xcUserMapper.selectOne(<span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;XcUser&gt;().eq(XcUser::getUsername, s));</span><br><span class="line">        <span class="keyword">if</span>(user==<span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="comment">//返回空表示用户不存在</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//取出数据库存储的正确密码</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">password</span>  <span class="operator">=</span>user.getPassword();</span><br><span class="line">        <span class="comment">//用户权限,如果不加报Cannot pass a null GrantedAuthority collection</span></span><br><span class="line">        String[] authorities= &#123;<span class="string">&quot;test&quot;</span>&#125;;</span><br><span class="line">        <span class="comment">//创建UserDetails对象,权限信息待实现授权功能时再向UserDetail中加入</span></span><br><span class="line">        <span class="type">UserDetails</span> <span class="variable">userDetails</span> <span class="operator">=</span> User.withUsername(user.getUsername()).password(password).authorities(authorities).build();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> userDetails;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="密码比对"><a href="#密码比对" class="headerlink" title="密码比对"></a>密码比对</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> PasswordEncoder <span class="title function_">passwordEncoder</span><span class="params">()</span> &#123;</span><br><span class="line"><span class="comment">//        //密码为明文方式</span></span><br><span class="line"><span class="comment">//        return NoOpPasswordEncoder.getInstance();</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BCryptPasswordEncoder</span>();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>数据库中的密码加过密的，用户输入的密码是明文，我们需要修改密码格式器PasswordEncoder，原来使用的是NoOpPasswordEncoder，它是通过明文方式比较密码，现在我们修改为BCryptPasswordEncoder，它是将用户输入的密码编码为BCrypt格式与数据库中的密码进行比对.</p>
<p>BCrypt:</p>
<p>1.BCryptPasswordEncoder(）加密是有加盐的</p>
<p>2.盐被存储在了加密后的密文中</p>
<p>3.由于每次盐是随机生成的，所以每次加密结果不同</p>
<p>4.校验时通过加密密码中的盐对原密码加密可判断出密码是否相同</p>
<h3 id="拓展用户信息"><a href="#拓展用户信息" class="headerlink" title="拓展用户信息"></a>拓展用户信息</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//创建UserDetails对象,权限信息待实现授权功能时再向UserDetail中加入</span></span><br><span class="line">        <span class="type">UserDetails</span> <span class="variable">userDetails</span> <span class="operator">=</span> User.withUsername(user.getUsername()).password(password).authorities(authorities).build();</span><br></pre></td></tr></table></figure>

<p>上文中返回的UserDetail只放入了username,password,感觉很少，不够用，例如登录后显示用户头像等信息也需要放入</p>
<p>在认证阶段DaoAuthenticationProvider会调用UserDetailService查询用户的信息，这里是可以获取到齐全的用户信息的。由于JWT令牌中用户身份信息来源于UserDetails，UserDetails中仅定义了username为用户的身份信息，这里有两个思路：</p>
<ul>
<li>第一是可以扩展UserDetails，使之包括更多的自定义属性，</li>
<li>第二也可以扩展username的内容 ，比如存入json数据内容作为username的内容。</li>
<li>相比较而言，方案二比较简单还不用破坏UserDetails的结构，我们采用方案二。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//为了安全在令牌中不放密码</span></span><br><span class="line">      user.setPassword(<span class="literal">null</span>);</span><br><span class="line">      <span class="comment">//将user对象转json</span></span><br><span class="line">      <span class="type">String</span> <span class="variable">userString</span> <span class="operator">=</span> JSON.toJSONString(user);</span><br><span class="line">      <span class="comment">//创建UserDetails对象</span></span><br><span class="line">      <span class="type">UserDetails</span> <span class="variable">userDetails</span> <span class="operator">=</span> User.withUsername(userString).password(password).authorities(authorities).build();</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="资源服务获取用户身份"><a href="#资源服务获取用户身份" class="headerlink" title="资源服务获取用户身份"></a>资源服务获取用户身份</h3><p>定义一个工具类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.content.util;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.context.SecurityContextHolder;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 获取当前用户身份工具类</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/10/18 18:02</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityUtil</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> XcUser <span class="title function_">getUser</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//SecurityContextHolder安全上下文</span></span><br><span class="line">            <span class="type">Object</span> <span class="variable">principalObj</span> <span class="operator">=</span> SecurityContextHolder.getContext().getAuthentication().getPrincipal();</span><br><span class="line">            <span class="keyword">if</span> (principalObj <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">                <span class="comment">//取出用户身份信息</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">principal</span> <span class="operator">=</span> principalObj.toString();</span><br><span class="line">                <span class="comment">//将json转成对象</span></span><br><span class="line">                <span class="type">XcUser</span> <span class="variable">user</span> <span class="operator">=</span> JSON.parseObject(principal, XcUser.class);</span><br><span class="line">                <span class="keyword">return</span> user;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;获取当前登录用户身份出错:&#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//静态内部类</span></span><br><span class="line">    <span class="meta">@Data</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">XcUser</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> String id;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> String username;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> String salt;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> String name;</span><br><span class="line">        <span class="keyword">private</span> String nickname;</span><br><span class="line">        <span class="keyword">private</span> String wxUnionid;</span><br><span class="line">        <span class="keyword">private</span> String companyId;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 头像</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">private</span> String userpic;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> String utype;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> LocalDateTime birthday;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> String sex;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> String email;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> String cellphone;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> String qq;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 用户状态</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">private</span> String status;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> LocalDateTime createTime;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> LocalDateTime updateTime;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SecurityUtil.<span class="type">XcUser</span> <span class="variable">user</span> <span class="operator">=</span> SecurityUtil.getUser();</span><br></pre></td></tr></table></figure>

<h3 id="支持认证方式多样"><a href="#支持认证方式多样" class="headerlink" title="支持认证方式多样"></a>支持认证方式多样</h3><h4 id="统一认证入口"><a href="#统一认证入口" class="headerlink" title="统一认证入口"></a>统一认证入口</h4><p>1、支持账号和密码认证</p>
<p>采用OAuth2协议的密码模式即可实现。</p>
<p>2、支持手机号加验证码认证</p>
<p>用户认证提交的是手机号和验证码，并不是账号和密码。</p>
<p>3、微信扫码认证</p>
<p>基于OAuth2协议与微信交互，学成在线网站向微信服务器申请到一个令牌，然后携带令牌去微信查询用户信息，查询成功则用户在学成在线项目认证通过。</p>
<p>目前我们测试通过OAuth2的密码模式，用户认证会提交账号和密码，由DaoAuthenticationProvider调用UserDetailsService的loadUserByUsername()方法获取UserDetails用户信息。</p>
<p>在前边我们自定义了UserDetailsService接口实现类，通过loadUserByUsername()方法根据账号查询用户信息。</p>
<p>而不同的认证方式提交的数据不一样，比如：手机加验证码方式会提交手机号和验证码，账号密码方式会提交账号、密码、验证码。</p>
<p>我们可以在loadUserByUsername()方法上作文章，将用户原来提交的账号数据改为提交json数据，json数据可以扩展不同认证方式所提交的各种参数。</p>
<p>首先创建一个DTO类表示认证的参数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.ucenter.model.dto;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 认证用户请求参数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/29 10:56</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AuthParamsDto</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String username; <span class="comment">//用户名</span></span><br><span class="line">    <span class="keyword">private</span> String password; <span class="comment">//域  用于扩展</span></span><br><span class="line">    <span class="keyword">private</span> String cellphone;<span class="comment">//手机号</span></span><br><span class="line">    <span class="keyword">private</span> String checkcode;<span class="comment">//验证码</span></span><br><span class="line">    <span class="keyword">private</span> String checkcodekey;<span class="comment">//验证码key</span></span><br><span class="line">    <span class="keyword">private</span> String authType; <span class="comment">// 认证的类型   password:用户名密码模式类型    sms:短信模式类型</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, Object&gt; payload = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();<span class="comment">//附加数据，作为扩展，不同认证类型可拥有不同的附加数据。如认证类型为短信时包含smsKey : sms:3d21042d054548b08477142bbca95cfa; 所有情况下都包含clientId</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>所以修改获取loadUserByUsername（）方式：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">AuthParamsDto</span> <span class="variable">authParamsDto</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="comment">//将认证参数转为AuthParamsDto类型</span></span><br><span class="line">          authParamsDto = JSON.parseObject(s, AuthParamsDto.class);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">          log.info(<span class="string">&quot;认证请求不符合项目要求:&#123;&#125;&quot;</span>,s);</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;认证请求数据格式不对&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">//账号</span></span><br><span class="line">      <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> authParamsDto.getUsername();</span><br></pre></td></tr></table></figure>

<p>原来的DaoAuthenticationProvider 会进行密码校验，现在重新定义DaoAuthenticationProviderCustom类，重写类的additionalAuthenticationChecks方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.auth.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.BadCredentialsException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.UsernamePasswordAuthenticationToken;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.dao.DaoAuthenticationProvider;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.AuthenticationException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetails;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetailsService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 自定义DaoAuthenticationProvider</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/29 10:31</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DaoAuthenticationProviderCustom</span> <span class="keyword">extends</span> <span class="title class_">DaoAuthenticationProvider</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> <span class="meta">@Autowired</span></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setUserDetailsService</span><span class="params">(UserDetailsService userDetailsService)</span> &#123;</span><br><span class="line">  <span class="built_in">super</span>.setUserDetailsService(userDetailsService);</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> <span class="comment">//屏蔽密码对比</span></span><br><span class="line"> <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">additionalAuthenticationChecks</span><span class="params">(UserDetails userDetails, UsernamePasswordAuthenticationToken authentication)</span> <span class="keyword">throws</span> AuthenticationException &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改WebSecurityConfig类指定daoAuthenticationProviderCustom</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">DaoAuthenticationProviderCustom daoAuthenticationProviderCustom;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    auth.authenticationProvider(daoAuthenticationProviderCustom);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>经过测试发现loadUserByUsername()方法可以正常接收到认证请求中的json数据。</p>
<p>有了这些认证参数我们可以定义一个认证Service接口去进行各种方式的认证。</p>
<p>定义用户信息，为了扩展性让它继承XcUser</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.ucenter.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xuecheng.ucenter.model.dto.AuthParamsDto;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.ucenter.model.po.XcUser;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 认证service</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/29 12:10</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">AuthService</span> &#123;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@description</span> 认证方法</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> authParamsDto 认证参数</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> com.xuecheng.ucenter.model.po.XcUser 用户信息</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@date</span> 2022/9/29 12:11</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">    <span class="comment">//认证方法</span></span><br><span class="line">   XcUserExt <span class="title function_">execute</span><span class="params">(AuthParamsDto authParamsDto)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>所以userDetail</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">AuthParamsDto</span> <span class="variable">authParamsDto</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">//将认证参数转为AuthParamsDto类型</span></span><br><span class="line">    authParamsDto = JSON.parseObject(s, AuthParamsDto.class);</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    log.info(<span class="string">&quot;认证请求不符合项目要求:&#123;&#125;&quot;</span>,s);</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;认证请求数据格式不对&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//开始认证</span></span><br><span class="line">authService.execute(authParamsDto);</span><br></pre></td></tr></table></figure>

<p><img src="/2025/04/21/%E5%AD%A6%E6%88%90-%E7%AC%94%E8%AE%B0/image-20250422101803790.png" alt="image-20250422101803790"></p>
<h4 id="如何进入不同认证方法"><a href="#如何进入不同认证方法" class="headerlink" title="如何进入不同认证方法"></a>如何进入不同认证方法</h4><p>实现了认证接口，实现该接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//认证方法</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">authType</span> <span class="operator">=</span> authParamsDto.getAuthType();</span><br><span class="line"><span class="comment">//@service（）名称获得不同bean从而进入不同逻辑</span></span><br><span class="line">        <span class="type">AuthService</span> <span class="variable">authService</span> <span class="operator">=</span>  applicationContext.getBean(authType + <span class="string">&quot;_authservice&quot;</span>,AuthService.class);</span><br><span class="line">        <span class="type">XcUserExt</span> <span class="variable">user</span> <span class="operator">=</span> authService.execute(authParamsDto);</span><br></pre></td></tr></table></figure>

<p>账号密码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.ucenter.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.ucenter.mapper.XcUserMapper;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.ucenter.model.dto.AuthParamsDto;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.ucenter.model.po.XcUser;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.ucenter.service.AuthService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.crypto.password.PasswordEncoder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 账号密码认证</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/29 12:12</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> <span class="meta">@Service(&quot;password_authservice&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PasswordAuthServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">AuthService</span> &#123;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@Autowired</span></span><br><span class="line"> XcUserMapper xcUserMapper;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@Autowired</span></span><br><span class="line"> PasswordEncoder passwordEncoder;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line"> <span class="keyword">public</span> XcUserExt <span class="title function_">execute</span><span class="params">(AuthParamsDto authParamsDto)</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//账号</span></span><br><span class="line">  <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> authParamsDto.getUsername();</span><br><span class="line">  <span class="type">XcUser</span> <span class="variable">user</span> <span class="operator">=</span> xcUserMapper.selectOne(<span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;XcUser&gt;().eq(XcUser::getUsername, username));</span><br><span class="line">  <span class="keyword">if</span>(user==<span class="literal">null</span>)&#123;</span><br><span class="line">   <span class="comment">//返回空表示用户不存在</span></span><br><span class="line">   <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;账号不存在&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">     <span class="comment">//XcUserExt继承XcUser,多了一个权限列表</span></span><br><span class="line">  <span class="type">XcUserExt</span> <span class="variable">xcUserExt</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XcUserExt</span>();</span><br><span class="line">  BeanUtils.copyProperties(user,xcUserExt);</span><br><span class="line">  <span class="comment">//校验密码</span></span><br><span class="line">  <span class="comment">//取出数据库存储的正确密码</span></span><br><span class="line">  <span class="type">String</span> <span class="variable">passwordDb</span>  <span class="operator">=</span>user.getPassword();</span><br><span class="line">  <span class="type">String</span> <span class="variable">passwordForm</span> <span class="operator">=</span> authParamsDto.getPassword();</span><br><span class="line">  <span class="type">boolean</span> <span class="variable">matches</span> <span class="operator">=</span> passwordEncoder.matches(passwordForm, passwordDb);</span><br><span class="line">  <span class="keyword">if</span>(!matches)&#123;</span><br><span class="line">   <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;账号或密码错误&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> xcUserExt;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="验证码服务"><a href="#验证码服务" class="headerlink" title="验证码服务"></a>验证码服务</h4><p>验证码可以防止恶性攻击，比如：XSS跨站脚本攻击、CSRF跨站请求伪造攻击，一些比较复杂的图形验证码可以有效的防止恶性攻击。提供了有Check-code模块.</p>
<p>简单解释验证码服务：</p>
<ul>
<li>生成一个key:value,一个图片，用redis，存放key:value</li>
<li>前端页面显示key和图片,key以隐藏的形式存放</li>
<li>用户发送key和自己填写的code</li>
<li>后端进入redis中拿出code和用户填写的code比对</li>
</ul>
<h4 id="整合"><a href="#整合" class="headerlink" title="整合"></a>整合</h4><p>1、在认证服务定义远程调用验证码服务的接口</p>
<p>2、CheckCodeClientFactory:，降级策略防止远程调用失败后系统出错</p>
<p>3、启动类添加：@Enable</p>
<p>4、配置文件引入feign-dev.yaml</p>
<p>5、完善：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">/校验验证码</span><br><span class="line">  <span class="type">String</span> <span class="variable">checkcode</span> <span class="operator">=</span> authParamsDto.getCheckcode();</span><br><span class="line">  <span class="type">String</span> <span class="variable">checkcodekey</span> <span class="operator">=</span> authParamsDto.getCheckcodekey();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(StringUtils.isBlank(checkcodekey) || StringUtils.isBlank(checkcode))&#123;</span><br><span class="line">   <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;验证码为空&quot;</span>);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="type">Boolean</span> <span class="variable">verify</span> <span class="operator">=</span> checkCodeClient.verify(checkcodekey, checkcode);</span><br><span class="line">  <span class="keyword">if</span>(!verify)&#123;</span><br><span class="line">   <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;验证码输入错误&quot;</span>);</span><br></pre></td></tr></table></figure>

<h2 id="微信扫码登录"><a href="#微信扫码登录" class="headerlink" title="微信扫码登录"></a>微信扫码登录</h2><p>查看官方文档或者看项目中wx部分吧</p>
<p><img src="/2025/04/21/%E5%AD%A6%E6%88%90-%E7%AC%94%E8%AE%B0/image-20250422103204472.png" alt="image-20250422103204472"></p>
<h2 id="用户授权"><a href="#用户授权" class="headerlink" title="用户授权"></a>用户授权</h2><p>RBAC分为两种方式：</p>
<p>基于角色的访问控制（Role-Based Access Control）</p>
<p>基于资源的访问控制（Resource-Based Access Control）</p>
<p>流程：</p>
<ul>
<li><p>使用注解在需要授权的接口处使用@PreAuthorize(“hasAuthority(‘权限标识符’)”)进行控制</p>
</li>
<li><p>当前用户请求接口没有权限则抛出异常org.springframework.security.access.AccessDeniedException: 不允许访问</p>
</li>
<li><p>捕获异常：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="meta">@ExceptionHandler(Exception.class)</span></span><br><span class="line"><span class="meta">@ResponseStatus(HttpStatus.INTERNAL_SERVER_ERROR)</span></span><br><span class="line"><span class="keyword">public</span> RestErrorResponse <span class="title function_">exception</span><span class="params">(Exception e)</span> &#123;</span><br><span class="line"></span><br><span class="line">   log.error(<span class="string">&quot;【系统异常】&#123;&#125;&quot;</span>,e.getMessage(),e);</span><br><span class="line">   e.printStackTrace();</span><br><span class="line">   <span class="keyword">if</span>(e.getMessage().equals(<span class="string">&quot;不允许访问&quot;</span>))&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RestErrorResponse</span>(<span class="string">&quot;没有操作此功能的权限&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RestErrorResponse</span>(CommonError.UNKOWN_ERROR.getErrMessage());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="用户分配权限"><a href="#用户分配权限" class="headerlink" title="用户分配权限"></a>用户分配权限</h3><p><img src="/2025/04/21/%E5%AD%A6%E6%88%90-%E7%AC%94%E8%AE%B0/image-20250422103440815.png" alt="image-20250422103440815"></p>
<p>一步步查：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">XcMenuMapper</span> <span class="keyword">extends</span> <span class="title class_">BaseMapper</span>&lt;XcMenu&gt; &#123;</span><br><span class="line">    <span class="meta">@Select(&quot;SELECT    * FROM xc_menu WHERE id IN (SELECT menu_id FROM xc_permission WHERE role_id IN ( SELECT role_id FROM xc_user_role WHERE user_id = #&#123;userId&#125; ))&quot;)</span></span><br><span class="line">    List&lt;XcMenu&gt; <span class="title function_">selectPermissionByUserId</span><span class="params">(<span class="meta">@Param(&quot;userId&quot;)</span> String userId)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="http://example.com">TTDB</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2025/04/21/%E5%AD%A6%E6%88%90-%E7%AC%94%E8%AE%B0/">http://example.com/2025/04/21/%E5%AD%A6%E6%88%90-%E7%AC%94%E8%AE%B0/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="http://example.com" target="_blank">TTDB's blog</a>！</span></div></div><div class="tag_share"><div class="post-share"><div class="social-share" data-image="/img/ab271877b6d5d966b6bcd9cda1623d51.jpeg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i>赞助</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/0ed4d56b723a59b4303d73913cf16f7.jpg" target="_blank"><img class="post-qr-code-img" src="/img/0ed4d56b723a59b4303d73913cf16f7.jpg" alt="wechat"/></a><div class="post-qr-code-desc">wechat</div></li><li class="reward-item"><a href="/img/8151e0eadcb22bce884312f7f78e0f6.jpg" target="_blank"><img class="post-qr-code-img" src="/img/8151e0eadcb22bce884312f7f78e0f6.jpg" alt="alipay"/></a><div class="post-qr-code-desc">alipay</div></li></ul></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2025/04/21/%E9%9D%A2%E8%AF%95/" title="面试---java基础"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">面试---java基础</div></div><div class="info-2"><div class="info-item-1">一、java基础java特点 平台无关性 面向对象：OOP 内存管理  跨平台java跨平台主要依赖与JVM Jvm JVM是一个软件由C&#x2F;C++开发，本身是编译后的机器码，不支持跨平台，需要安装不同版本的JDK JVM可以将字节码文件翻译成机器码，从而运行java程序，于是就有了： 我们编写的Java源码，编译后会生成一种 .class...</div></div></div></a><a class="pagination-related" href="/2025/04/21/%E6%B3%A8%E8%A7%A3/" title="注解"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">注解</div></div><div class="info-2"><div class="info-item-1">前言本篇笔记是对注解的理解，了解为什么注解，注解有哪些，功能又是什么 Javaweb&gt;spring&gt;springMVC&gt;mybatis&gt;spring高级，一路走来，跌跌撞撞，发现spring也不过尔尔，说白了，spring就是想尽办法将new做的更简单，更完美，更可配置。 Spring的一个核心功能是IOC，就是将Bean初始化加载到容器中，Bean是如何加载到容器的，可以使用Spring注解方式或者Spring XML配置方式。 Spring注解方式减少了配置文件内容，更加便于管理，并且使用注解可以大大提高了开发效率！ 注解本身是没有功能的，和xml一样，注解和xml都是一种元数据，元数据即解释数据的数据，也就是所谓的配置。 什么是注解(Annotation)注解是Java...</div></div></div></a></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/ab271877b6d5d966b6bcd9cda1623d51.jpeg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">TTDB</div><div class="author-info-description">What can I do for you?</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">19</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">10</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">4</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/HgnGoning" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:hgn314134@163.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90%E2%80%93%E5%B1%95%E7%A4%BA%E4%B8%80%E4%B8%AA%E6%8E%A5%E5%8F%A3%E7%9A%84%E5%BC%80%E5%8F%91%E6%B5%81%E7%A8%8B"><span class="toc-number">1.</span> <span class="toc-text">需求分析–展示一个接口的开发流程</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E6%A8%A1%E5%9D%97%E8%AE%BE%E8%AE%A1"><span class="toc-number">1.1.</span> <span class="toc-text">课程查询模块设计</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B"><span class="toc-number">1.1.1.</span> <span class="toc-text">1.业务流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B"><span class="toc-number">1.1.2.</span> <span class="toc-text">2.数据模型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%9F%E6%88%90PO"><span class="toc-number">1.1.3.</span> <span class="toc-text">生成PO</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89"><span class="toc-number">1.1.4.</span> <span class="toc-text">接口定义</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89%E5%88%86%E6%9E%90"><span class="toc-number">1.1.4.1.</span> <span class="toc-text">接口定义分析</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89"><span class="toc-number">1.1.5.</span> <span class="toc-text">课程查询接口定义</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86"><span class="toc-number">2.</span> <span class="toc-text">异常处理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%82%E5%B8%B8%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90"><span class="toc-number">2.0.0.1.</span> <span class="toc-text">异常问题分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%9F%E4%B8%80%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E5%AE%9E%E7%8E%B0"><span class="toc-number">2.0.0.2.</span> <span class="toc-text">统一异常处理实现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E6%B5%8B%E8%AF%95"><span class="toc-number">2.0.0.3.</span> <span class="toc-text">异常处理测试</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9D%A2%E8%AF%95"><span class="toc-number">2.0.0.4.</span> <span class="toc-text">面试</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#JSR303%E6%A0%A1%E9%AA%8C"><span class="toc-number">2.1.</span> <span class="toc-text">JSR303校验</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%9F%E4%B8%80%E6%A0%A1%E9%AA%8C%E7%9A%84%E9%9C%80%E6%B1%82"><span class="toc-number">2.1.0.1.</span> <span class="toc-text">统一校验的需求</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%9F%E4%B8%80%E6%A0%A1%E9%AA%8C%E5%AE%9E%E7%8E%B0"><span class="toc-number">2.1.0.2.</span> <span class="toc-text">统一校验实现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%86%E7%BB%84%E6%A0%A1%E9%AA%8C"><span class="toc-number">2.1.0.3.</span> <span class="toc-text">分组校验</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A0%A1%E9%AA%8C%E8%A7%84%E5%88%99%E4%B8%8D%E6%BB%A1%E8%B6%B3%EF%BC%9F"><span class="toc-number">2.1.0.4.</span> <span class="toc-text">校验规则不满足？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9D%A2%E8%AF%95-1"><span class="toc-number">2.1.0.5.</span> <span class="toc-text">面试</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#sql"><span class="toc-number">3.</span> <span class="toc-text">sql</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#xml%E8%AF%AD%E5%8F%A5"><span class="toc-number">3.1.</span> <span class="toc-text">xml语句</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%92%E5%BD%92%E6%9F%A5%E8%AF%A2%E6%A0%91%E5%BD%A2%E7%BB%93%E6%9E%84%E7%9A%84sql"><span class="toc-number">3.2.</span> <span class="toc-text">递归查询树形结构的sql</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E6%AD%A5%E9%AA%A4%E8%A7%A3%E6%9E%90"><span class="toc-number">3.2.1.</span> <span class="toc-text">执行步骤解析</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83"><span class="toc-number">4.</span> <span class="toc-text">认证授权</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A1%86%E6%9E%B6-Spring-Security"><span class="toc-number">4.1.</span> <span class="toc-text">框架-Spring Security</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86"><span class="toc-number">4.1.1.</span> <span class="toc-text">原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B%EF%BC%9A%E2%80%94%E2%80%93%E6%A0%B8%E5%BF%83%E4%B9%9F%E6%98%AF%E4%BB%A3%E7%A0%81%E7%BC%96%E7%A8%8B%E7%9A%84%E6%A0%B8%E5%BF%83"><span class="toc-number">4.1.2.</span> <span class="toc-text">执行流程：—–核心也是代码编程的核心</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#OAuth2"><span class="toc-number">4.2.</span> <span class="toc-text">OAuth2</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B"><span class="toc-number">4.2.1.</span> <span class="toc-text">工作流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%88%E6%9D%83%E6%A8%A1%E5%BC%8F"><span class="toc-number">4.2.2.</span> <span class="toc-text">授权模式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8E%88%E6%9D%83%E7%A0%81%E6%A8%A1%E5%BC%8F"><span class="toc-number">4.2.2.1.</span> <span class="toc-text">授权码模式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AF%86%E7%A0%81%E6%A8%A1%E5%BC%8F"><span class="toc-number">4.2.2.2.</span> <span class="toc-text">密码模式</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#JWT"><span class="toc-number">4.3.</span> <span class="toc-text">JWT</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%99%AE%E9%80%9A%E4%BB%A4%E7%89%8C"><span class="toc-number">4.3.1.</span> <span class="toc-text">普通令牌</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JWT%E4%BB%A4%E7%89%8C"><span class="toc-number">4.3.2.</span> <span class="toc-text">JWT令牌</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%93%E6%9E%84"><span class="toc-number">4.3.2.1.</span> <span class="toc-text">结构</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BD%91%E5%85%B3%E8%AE%A4%E8%AF%81"><span class="toc-number">4.4.</span> <span class="toc-text">网关认证</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E8%AE%A4%E8%AF%81%E5%AE%9E%E7%8E%B0"><span class="toc-number">4.5.</span> <span class="toc-text">用户认证实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A1%86%E6%9E%B6%E8%AE%A4%E8%AF%81"><span class="toc-number">4.5.1.</span> <span class="toc-text">框架认证</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%86%E7%A0%81%E6%AF%94%E5%AF%B9"><span class="toc-number">4.5.2.</span> <span class="toc-text">密码比对</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8B%93%E5%B1%95%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF"><span class="toc-number">4.5.3.</span> <span class="toc-text">拓展用户信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B5%84%E6%BA%90%E6%9C%8D%E5%8A%A1%E8%8E%B7%E5%8F%96%E7%94%A8%E6%88%B7%E8%BA%AB%E4%BB%BD"><span class="toc-number">4.5.4.</span> <span class="toc-text">资源服务获取用户身份</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%94%AF%E6%8C%81%E8%AE%A4%E8%AF%81%E6%96%B9%E5%BC%8F%E5%A4%9A%E6%A0%B7"><span class="toc-number">4.5.5.</span> <span class="toc-text">支持认证方式多样</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%9F%E4%B8%80%E8%AE%A4%E8%AF%81%E5%85%A5%E5%8F%A3"><span class="toc-number">4.5.5.1.</span> <span class="toc-text">统一认证入口</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E8%BF%9B%E5%85%A5%E4%B8%8D%E5%90%8C%E8%AE%A4%E8%AF%81%E6%96%B9%E6%B3%95"><span class="toc-number">4.5.5.2.</span> <span class="toc-text">如何进入不同认证方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81%E7%A0%81%E6%9C%8D%E5%8A%A1"><span class="toc-number">4.5.5.3.</span> <span class="toc-text">验证码服务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%B4%E5%90%88"><span class="toc-number">4.5.5.4.</span> <span class="toc-text">整合</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BE%AE%E4%BF%A1%E6%89%AB%E7%A0%81%E7%99%BB%E5%BD%95"><span class="toc-number">4.6.</span> <span class="toc-text">微信扫码登录</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E6%8E%88%E6%9D%83"><span class="toc-number">4.7.</span> <span class="toc-text">用户授权</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E5%88%86%E9%85%8D%E6%9D%83%E9%99%90"><span class="toc-number">4.7.1.</span> <span class="toc-text">用户分配权限</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/07/08/%E8%8B%A5%E4%BE%9D/" title="RuoYi">RuoYi</a><time datetime="2025-07-08T02:22:32.745Z" title="发表于 2025-07-08 10:22:32">2025-07-08</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/06/03/spring-ai/" title="spring-ai">spring-ai</a><time datetime="2025-06-03T00:31:56.613Z" title="发表于 2025-06-03 08:31:56">2025-06-03</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/05/13/java%E7%BC%96%E7%A8%8Btpis/" title="java编程tpis">java编程tpis</a><time datetime="2025-05-13T02:08:13.922Z" title="发表于 2025-05-13 10:08:13">2025-05-13</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/04/29/langchain4j/" title="langchain4j">langchain4j</a><time datetime="2025-04-29T08:18:34.845Z" title="发表于 2025-04-29 16:18:34">2025-04-29</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/04/21/%E6%B3%A8%E8%A7%A3/" title="注解">注解</a><time datetime="2025-04-21T06:26:10.422Z" title="发表于 2025-04-21 14:26:10">2025-04-21</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2025 By TTDB</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo 7.3.0</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.3.5</a></div><div class="footer_custom_text">Hi, welcome to my <a target="_blank" rel="noopener" href="https://butterfly.js.org/">blog</a>!</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><div class="js-pjax"></div><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-nest.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = false;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script id="click-heart" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/click-heart.min.js" async="async" mobile="false"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>