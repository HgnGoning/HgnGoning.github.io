<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>langchain4j | TTDB's blog</title><meta name="author" content="TTDB"><meta name="copyright" content="TTDB"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="一、入门LangChain4j 的目标是简化将大语言模型（LLM - Large Language Model）集成到 Java 应用程序中的过程。 1、主要功能 与大型语言模型和向量数据库的便捷交互 通过统一的应用程序编程接口（API），可以轻松访问所有主要的商业和开源大型语言模型以及向量数据 库，使你能够构建聊天机器人、智能助手等应用。  专为 Java 打造 借助Spring Boot 集成">
<meta property="og:type" content="article">
<meta property="og:title" content="langchain4j">
<meta property="og:url" content="http://example.com/2025/04/29/langchain4j/index.html">
<meta property="og:site_name" content="TTDB&#39;s blog">
<meta property="og:description" content="一、入门LangChain4j 的目标是简化将大语言模型（LLM - Large Language Model）集成到 Java 应用程序中的过程。 1、主要功能 与大型语言模型和向量数据库的便捷交互 通过统一的应用程序编程接口（API），可以轻松访问所有主要的商业和开源大型语言模型以及向量数据 库，使你能够构建聊天机器人、智能助手等应用。  专为 Java 打造 借助Spring Boot 集成">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/img/ab271877b6d5d966b6bcd9cda1623d51.jpeg">
<meta property="article:published_time" content="2025-04-29T08:18:34.845Z">
<meta property="article:modified_time" content="2025-05-06T07:01:42.264Z">
<meta property="article:author" content="TTDB">
<meta property="article:tag" content="java, 大模型">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/img/ab271877b6d5d966b6bcd9cda1623d51.jpeg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "langchain4j",
  "url": "http://example.com/2025/04/29/langchain4j/",
  "image": "http://example.com/img/ab271877b6d5d966b6bcd9cda1623d51.jpeg",
  "datePublished": "2025-04-29T08:18:34.845Z",
  "dateModified": "2025-05-06T07:01:42.264Z",
  "author": [
    {
      "@type": "Person",
      "name": "TTDB",
      "url": "http://example.com/"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://example.com/2025/04/29/langchain4j/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin=""/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web&amp;display=swap" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: {"chs_to_cht":"已切换为繁体中文","cht_to_chs":"已切换为简体中文","day_to_night":"已切换为深色模式","night_to_day":"已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"bottom-left"},
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'langchain4j',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="generator" content="Hexo 7.3.0"></head><body><div id="web_bg" style="background-image: url(https://i.loli.net/2019/09/09/5oDRkWVKctx2b6A.png);"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/ab271877b6d5d966b6bcd9cda1623d51.jpeg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">16</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">8</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">4</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg fixed" id="page-header" style="background-image: url(/img/e93f858d798bea4fbdee83331ff488c.jpg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">TTDB's blog</span></a><a class="nav-page-title" href="/"><span class="site-name">langchain4j</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">langchain4j</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-04-29T08:18:34.845Z" title="发表于 2025-04-29 16:18:34">2025-04-29</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-05-06T07:01:42.264Z" title="更新于 2025-05-06 15:01:42">2025-05-06</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h1 id="一、入门"><a href="#一、入门" class="headerlink" title="一、入门"></a>一、入门</h1><p>LangChain4j 的目标是简化将大语言模型（LLM - Large Language Model）集成到 Java 应用程序中的过程。</p>
<h2 id="1、主要功能"><a href="#1、主要功能" class="headerlink" title="1、主要功能"></a>1、主要功能</h2><ul>
<li>与大型语言模型和向量数据库的便捷交互 通过统一的应用程序编程接口（API），可以轻松访问所有主要的商业和开源大型语言模型以及向量数据 库，使你能够构建聊天机器人、智能助手等应用。 </li>
<li>专为 Java 打造 借助Spring Boot 集成，能够将大模型集成到ava 应用程序中。</li>
<li>大型语言模型与 Java 之间实现了双向集 成：你可以从 Java 中调用大型语言模型，同时也允许大型语言模型反过来调用你的 Java 代码 智能代理、工具、检索增强生成（RAG） 为常见的大语言模型操作提供了广泛的工具，涵盖从底层的提示词模板创建、聊天记忆管理和输出解 析，到智能代理和检索增强生成等高级模式。</li>
</ul>
<h2 id="2、创建SpringBoot测试环境"><a href="#2、创建SpringBoot测试环境" class="headerlink" title="2、创建SpringBoot测试环境"></a>2、创建SpringBoot测试环境</h2><h3 id="2-1新建一个Maven项目"><a href="#2-1新建一个Maven项目" class="headerlink" title="2.1新建一个Maven项目"></a>2.1新建一个Maven项目</h3><p>添加如下依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>17<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>17<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">spring-boot.version</span>&gt;</span>3.2.6<span class="tag">&lt;/<span class="name">spring-boot.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">knife4j.version</span>&gt;</span>4.3.0<span class="tag">&lt;/<span class="name">knife4j.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">langchain4j.version</span>&gt;</span>1.0.0-beta3<span class="tag">&lt;/<span class="name">langchain4j.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mybatis-plus.version</span>&gt;</span>3.5.11<span class="tag">&lt;/<span class="name">mybatis-plus.version</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- web应用程序核心依赖 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 编写和运行测试用例 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 前后端分离中的后端接口测试工具 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.xiaoymin<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>knife4j-openapi3-jakarta-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;knife4j.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--引入SpringBoot依赖管理清单--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring-boot.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="2-2配置文件"><a href="#2-2配置文件" class="headerlink" title="2.2配置文件"></a>2.2配置文件</h3><p>在resources下创建配置文件application.properties</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment"># web服务访问端口</span></span><br><span class="line"><span class="string">server.port=8080</span></span><br></pre></td></tr></table></figure>

<h3 id="2-3创建启动类"><a href="#2-3创建启动类" class="headerlink" title="2.3创建启动类"></a>2.3创建启动类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.java.ai.langchain4j;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">XiaozhiApp</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(XiaozhiApp.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-4接口测试文档"><a href="#2-4接口测试文档" class="headerlink" title="2.4接口测试文档"></a>2.4接口测试文档</h3><p>访问 <a target="_blank" rel="noopener" href="http://localhost:8080/doc.html">http://localhost:8080/doc.html</a> 查看程序能否成功运行并显示如下页面</p>
<p><img src="/2025/04/29/langchain4j/image-20250429162606658.png" alt="image-20250429162606658"></p>
<h2 id="3、接入大模型"><a href="#3、接入大模型" class="headerlink" title="3、接入大模型"></a>3、接入大模型</h2><ul>
<li>参考文档： Get Started<a target="_blank" rel="noopener" href="https://docs.langchain4j.dev/get-started">https://docs.langchain4j.dev/get-started</a></li>
</ul>
<h3 id="3-1、LangChain4j-库结构"><a href="#3-1、LangChain4j-库结构" class="headerlink" title="3.1、LangChain4j 库结构"></a>3.1、LangChain4j 库结构</h3><p>LangChain4j 具有模块化设计，包括： </p>
<ol>
<li>langchain4j-core 模块，它定义了核心抽象概念（如聊天语言模型和嵌入存储）及其 API。 </li>
<li>主 langchain4j 模块，包含有用的工具，如文档加载器、聊天记忆实现，以及诸如人工智能服务等 高层功能。 </li>
<li>大量的 langchain4j-{集成} 模块，每个模块都将各种大语言模型提供商和嵌入存储集成到  LangChain4j 中。你可以独立使用 langchain4j-{集成} 模块。如需更多功能，只需导入主 langchain4j  依赖项即可。</li>
</ol>
<h3 id="3-2、依赖"><a href="#3-2、依赖" class="headerlink" title="3.2、依赖"></a>3.2、依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">langchain4j.version</span>&gt;</span>1.0.0-beta3<span class="tag">&lt;/<span class="name">langchain4j.version</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 基于open-ai的langchain4j接口：ChatGPT、deepseek都是open-ai标准下的大模型 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>dev.langchain4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>langchain4j-open-ai<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--引入langchain4j依赖管理清单--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>dev.langchain4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>langchain4j-bom<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;langchain4j.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="3-3、创建测试用例"><a href="#3-3、创建测试用例" class="headerlink" title="3.3、创建测试用例"></a>3.3、创建测试用例</h3><p>接入任何一个大模型都需要先去申请apiKey。 </p>
<p>如果你暂时没有密钥，也可以使用LangChain4j 提供的演示密钥，这个密钥是免费的，有使用配额限制， 且仅限于 gpt-4o-mini 模型。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.java.ai.langchain4j;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.community.model.dashscope.QwenChatModel;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.community.model.dashscope.WanxImageModel;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.data.image.Image;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.model.chat.ChatLanguageModel;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.model.ollama.OllamaChatModel;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.model.openai.OpenAiChatModel;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.model.output.Response;</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LLMTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testGPTDemo</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="comment">//初始化模型</span></span><br><span class="line">        <span class="type">OpenAiChatModel</span> <span class="variable">model</span> <span class="operator">=</span> OpenAiChatModel.builder()</span><br><span class="line">        <span class="comment">//LangChain4j提供的代理服务器，该代理服务器会将演示密钥替换成真实密钥， 再将请求转发给OpenAI API</span></span><br><span class="line">        .baseUrl(<span class="string">&quot;http://langchain4j.dev/demo/openai/v1&quot;</span>) <span class="comment">//设置模型api地址（如果apiKey=&quot;demo&quot;，则可省略baseUrl的配置）</span></span><br><span class="line">                .apiKey(<span class="string">&quot;demo&quot;</span>) <span class="comment">//设置模型apiKey</span></span><br><span class="line">                .modelName(<span class="string">&quot;gpt-4o-mini&quot;</span>) <span class="comment">//设置模型名称 尚硅⾕</span></span><br><span class="line">                .build();</span><br><span class="line">        <span class="comment">//向模型提问</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">answer</span> <span class="operator">=</span> model.chat(<span class="string">&quot;你好&quot;</span>);</span><br><span class="line">        <span class="comment">//输出结果</span></span><br><span class="line">        System.out.println(answer);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> OpenAiChatModel OpenAiChatModel;</span><br><span class="line">    <span class="comment">//private ChatLanguageModel OpenAiChatModel;通用，但如果有多个大模型就会不知道了</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSpringBoot</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="comment">//初始化模型</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">answer</span> <span class="operator">=</span> OpenAiChatModel.chat(<span class="string">&quot;你是谁&quot;</span>);</span><br><span class="line">        System.out.println(answer);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//ollama测试</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> OllamaChatModel ollamaChatModel;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testOllama</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="comment">//初始化模型</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">answer</span> <span class="operator">=</span> ollamaChatModel.chat(<span class="string">&quot;你是谁&quot;</span>);</span><br><span class="line">        System.out.println(answer);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> QwenChatModel qwenChatModel;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testQwen</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="comment">//初始化模型</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">answer</span> <span class="operator">=</span> qwenChatModel.chat(<span class="string">&quot;你是谁&quot;</span>);</span><br><span class="line">        System.out.println(answer);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//图像生成测试</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testDashScopeWanx</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">WanxImageModel</span> <span class="variable">wanxImageModel</span> <span class="operator">=</span> WanxImageModel.builder()</span><br><span class="line">                .modelName(<span class="string">&quot;wanx2.1-t2i-plus&quot;</span>)</span><br><span class="line">                .apiKey(System.getenv(<span class="string">&quot;DASH_SCOPE_API_KEY&quot;</span>))</span><br><span class="line">                .build();</span><br><span class="line">        Response&lt;Image&gt; response = wanxImageModel.generate(<span class="string">&quot;奇幻森林精灵：在一片弥漫着轻柔薄雾的 古老森林深处，阳光透过茂密枝叶洒下金色光斑。一位身材娇小、长着透明薄翼的精灵少女站在一朵硕大的蘑菇上。她 有着海藻般的绿色长发，发间点缀着蓝色的小花，皮肤泛着珍珠般的微光。身上穿着由翠绿树叶和白色藤蔓编织而成的 连衣裙，手中捧着一颗散发着柔和光芒的水晶球，周围环绕着五彩斑斓的蝴蝶，脚下是铺满苔藓的地面，蘑菇和蕨类植物丛生，营造出神秘而梦幻的氛围&quot;</span>);</span><br><span class="line">                System.out.println(response.content().url());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="4、SpringBoot整合"><a href="#4、SpringBoot整合" class="headerlink" title="4、SpringBoot整合"></a>4、SpringBoot整合</h3><p>参考文档：<a target="_blank" rel="noopener" href="https://docs.langchain4j.dev/tutorials/spring-boot-integration">https://docs.langchain4j.dev/tutorials/spring-boot-integration</a></p>
<h3 id="4-1替换依赖"><a href="#4-1替换依赖" class="headerlink" title="4.1替换依赖"></a>4.1替换依赖</h3><p>将 langchain4j-open-ai 替换成  langchain4j-open-ai-spring-boot-starter</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"> 	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>dev.langchain4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"> 	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>langchain4j-open-ai-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="4-2模型参数"><a href="#4-2模型参数" class="headerlink" title="4.2模型参数"></a>4.2模型参数</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#langchain4j测试模型</span></span><br><span class="line"><span class="string">langchain4j.open-ai.chat-model.api-key=demo</span></span><br><span class="line"><span class="string">langchain4j.open-ai.chat-model.model-name=gpt-4o</span></span><br><span class="line"> <span class="comment">#请求和响应日志</span></span><br><span class="line"><span class="string">langchain4j.open-ai.chat-model.log-requests=true</span></span><br><span class="line"><span class="string">langchain4j.open-ai.chat-model.log-responses=true</span></span><br><span class="line"> <span class="comment">#启用日志debug级别</span></span><br><span class="line"><span class="string">logging.level.root=debug</span></span><br></pre></td></tr></table></figure>

<h3 id="4-3-测试"><a href="#4-3-测试" class="headerlink" title="4.3 测试"></a>4.3 测试</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> OpenAiChatModel OpenAiChatModel;</span><br><span class="line">    <span class="comment">//private ChatLanguageModel OpenAiChatModel;通用，但如果有多个大模型就会不知道了</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSpringBoot</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="comment">//初始化模型</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">answer</span> <span class="operator">=</span> OpenAiChatModel.chat(<span class="string">&quot;你是谁&quot;</span>);</span><br><span class="line">        System.out.println(answer);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h2 id="4、接入其他大模型"><a href="#4、接入其他大模型" class="headerlink" title="4、接入其他大模型"></a>4、接入其他大模型</h2><p>上面有很多</p>
<h3 id="4-1-Deepseek"><a href="#4-1-Deepseek" class="headerlink" title="4.1 Deepseek"></a>4.1 Deepseek</h3><p>接入Deepseek, 需要去官网申请API配置后申请</p>
<p>api注意事项，为避免源码泄露造成的 api丢失，可以将api配置系统环境变量，直接引入${}即可后文多个模型的api也都可以这么做</p>
<p>大语言模型排行榜：<a target="_blank" rel="noopener" href="https://superclueai.com/">https://superclueai.com/</a></p>
<p>DeepSeek API文档：<a target="_blank" rel="noopener" href="https://api-docs.deepseek.com/zh-cn/">https://api-docs.deepseek.com/zh-cn/</a></p>
<h3 id="4-2-ollama本地部署"><a href="#4-2-ollama本地部署" class="headerlink" title="4.2 ollama本地部署"></a>4.2 ollama本地部署</h3><p>官网：<a target="_blank" rel="noopener" href="https://ollama.com/">https://ollama.com/</a>  </p>
<p>（1）下载并安装ollama： OllamaSetup.exe  </p>
<p>（2）查看模型列表，选择要部署的模型，模型列表： <a target="_blank" rel="noopener" href="https://ollama.com/search">https://ollama.com/search</a></p>
<p>执行命令： ollama run deepseek-r1:1.5 运行大模型。如果是第一次运行则会先下载大模型</p>
<p><img src="/2025/04/29/langchain4j/image-20250429163424021.png" alt="image-20250429163424021"></p>
<p>参考文档：<a target="_blank" rel="noopener" href="https://docs.langchain4j.dev/integrations/language-models/ollama#get-started">https://docs.langchain4j.dev/integrations/language-models/ollama#get-started</a></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 接入ollama --&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>dev.langchain4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>langchain4j-ollama-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"> </span><br><span class="line"> #ollama</span><br><span class="line"> langchain4j.ollama.chat-model.base-url=http://localhost:11434</span><br><span class="line"> langchain4j.ollama.chat-model.model-name=deepseek-r1:1.5b</span><br><span class="line"> langchain4j.ollama.chat-model.log-requests=true</span><br><span class="line"> langchain4j.ollama.chat-model.log-responses=true</span><br><span class="line"> </span><br><span class="line"> /**</span><br><span class="line"> * ollama接入</span><br><span class="line">*/</span><br><span class="line"> @Autowired</span><br><span class="line"> private OllamaChatModel ollamaChatModel;</span><br><span class="line"> @Test</span><br><span class="line"> public void testOllama() &#123;</span><br><span class="line"> //向模型提问</span><br><span class="line">String answer = ollamaChatModel.chat(&quot;你好&quot;);</span><br><span class="line"> //输出结果</span><br><span class="line">System.out.println(answer);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-3-阿里百炼平台"><a href="#4-3-阿里百炼平台" class="headerlink" title="4.3 阿里百炼平台"></a>4.3 阿里百炼平台</h3><ul>
<li>支持接入的模型列表：<a target="_blank" rel="noopener" href="https://help.aliyun.com/zh/model-studio/models">https://help.aliyun.com/zh/model-studio/models</a> </li>
<li>模型广场：<a target="_blank" rel="noopener" href="https://bailian.console.aliyun.com/?productCode=p_efm#/model-market">https://bailian.console.aliyun.com/?productCode=p_efm#/model-market</a></li>
<li>申请apiKey：<a target="_blank" rel="noopener" href="https://bailian.console.aliyun.com/?apiKey=1&productCode=p_efm#/api-key">https://bailian.console.aliyun.com/?apiKey=1&amp;productCode=p_efm#/api-key</a></li>
<li>LangChain4j参考文档：<a target="_blank" rel="noopener" href="https://docs.langchain4j.dev/integrations/language-models/dashscope#plain-java">https://docs.langchain4j.dev/integrations/language-models/dashscope#plain-java</a></li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 接入阿里云百炼平台 --&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>dev.langchain4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>langchain4j-community-dashscope-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">       </span><br><span class="line">       </span><br><span class="line">       <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">       <span class="comment">&lt;!--引入百炼依赖管理清单--&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>dev.langchain4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>langchain4j-community-bom<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;langchain4j.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>模型参数</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#阿里百炼平台</span></span><br><span class="line"><span class="string">langchain4j.community.dashscope.chat-model.api-key=$&#123;DASH_SCOPE_API_KEY&#125;</span></span><br><span class="line"><span class="string">langchain4j.community.dashscope.chat-model.model-name=qwen-max</span></span><br></pre></td></tr></table></figure>

<p>测试：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> QwenChatModel qwenChatModel;</span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testQwen</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="comment">//初始化模型</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">answer</span> <span class="operator">=</span> qwenChatModel.chat(<span class="string">&quot;你是谁&quot;</span>);</span><br><span class="line">    System.out.println(answer);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testDashScopeWanx</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">WanxImageModel</span> <span class="variable">wanxImageModel</span> <span class="operator">=</span> WanxImageModel.builder()</span><br><span class="line">            .modelName(<span class="string">&quot;wanx2.1-t2i-plus&quot;</span>)</span><br><span class="line">            .apiKey(System.getenv(<span class="string">&quot;DASH_SCOPE_API_KEY&quot;</span>))</span><br><span class="line">            .build();</span><br><span class="line">    Response&lt;Image&gt; response = wanxImageModel.generate(<span class="string">&quot;奇幻森林精灵：在一片弥漫着轻柔薄雾的 古老森林深处，阳光透过茂密枝叶洒下金色光斑。一位身材娇小、长着透明薄翼的精灵少女站在一朵硕大的蘑菇上。她 有着海藻般的绿色长发，发间点缀着蓝色的小花，皮肤泛着珍珠般的微光。身上穿着由翠绿树叶和白色藤蔓编织而成的 连衣裙，手中捧着一颗散发着柔和光芒的水晶球，周围环绕着五彩斑斓的蝴蝶，脚下是铺满苔藓的地面，蘑菇和蕨类植物丛生，营造出神秘而梦幻的氛围&quot;</span>);</span><br><span class="line">            System.out.println(response.content().url());</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="二、人工智能服务-AIService"><a href="#二、人工智能服务-AIService" class="headerlink" title="二、人工智能服务 AIService"></a>二、人工智能服务 AIService</h1><h2 id="1、什么是AlService"><a href="#1、什么是AlService" class="headerlink" title="1、什么是AlService"></a>1、什么是AlService</h2><p>AlService使用面向接口和动态代理的方式完成程序的编写，更灵活的实现高级功能。</p>
<h3 id="1-1、链Chain-l旧版"><a href="#1-1、链Chain-l旧版" class="headerlink" title="1.1、链Chain(l旧版)"></a>1.1、链Chain(l旧版)</h3><p>链的概念源自Python中的LangChain。其理念是针对每个常见的用例都设置一条链，比如聊天机器人、<br>检索增强生成(RG)等。链将多个底层组件组合起来，并协调它们之间的交互。链存在的主要问题是不<br>灵活，我们不进行深入的研究。</p>
<h3 id="1-2、人工智能服务AlService"><a href="#1-2、人工智能服务AlService" class="headerlink" title="1.2、人工智能服务AlService"></a>1.2、人工智能服务AlService</h3><p>在LangChain4j中我们使用AIService?完成复杂操作。底层组件将由AlServicei进行组装。<br>AlService可处理最常见的操作：</p>
<ul>
<li>·为大语言模型格式化输入内</li>
<li>·解析大语言模型的输出结果</li>
</ul>
<p>它们还支持更高级的功能：。</p>
<ul>
<li>聊天记忆Chat memory</li>
<li>工具Tools</li>
<li>检索增强生成RAG</li>
</ul>
<h2 id="2、创建AIService"><a href="#2、创建AIService" class="headerlink" title="2、创建AIService"></a>2、创建AIService</h2><h3 id="2-1、引入依赖"><a href="#2-1、引入依赖" class="headerlink" title="2.1、引入依赖"></a>2.1、引入依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--langchain4j高级功能--&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"> 	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>dev.langchain4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"> 	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>langchain4j-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="2-2、创建接口"><a href="#2-2、创建接口" class="headerlink" title="2.2、创建接口"></a>2.2、创建接口</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.java.ai.langchain4j.assistant;</span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Assistant</span> &#123;</span><br><span class="line"> 	String <span class="title function_">chat</span><span class="params">(String userMessage)</span>;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-3、测试用例"><a href="#2-3、测试用例" class="headerlink" title="2.3、测试用例"></a>2.3、测试用例</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">   <span class="keyword">private</span> QwenChatModel qwenChatModel;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Test</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testChat</span><span class="params">()</span> &#123;</span><br><span class="line">       <span class="type">Assistant</span> <span class="variable">assiant</span> <span class="operator">=</span> AiServices.create(Assistant.class, qwenChatModel);</span><br><span class="line">       <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> assiant.chat(<span class="string">&quot;你叫什么名字&quot;</span>);</span><br><span class="line">       System.out.println(result);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-4、-AiService"><a href="#2-4、-AiService" class="headerlink" title="2.4、@AiService"></a>2.4、@AiService</h3><p>也可以在 Assistant 接口上添加 @AiService 注解</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.java.ai.langchain4j.assistant;</span><br><span class="line"> <span class="comment">//因为我们在配置文件中同时配置了多个大语言模型，所以需要在这里明确指定（EXPLICIT）模型的beanName（qwenChatModel）</span></span><br><span class="line"> <span class="meta">@AiService(wiringMode = EXPLICIT, chatModel = &quot;qwenChatModel&quot;)</span></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Assistant</span> &#123;</span><br><span class="line"> 	String <span class="title function_">chat</span><span class="params">(String userMessage)</span>;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//测试可以直接注入，不需要再create</span></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"> <span class="keyword">private</span> Assistant assistant;</span><br></pre></td></tr></table></figure>

<h3 id="2-5、工作原理"><a href="#2-5、工作原理" class="headerlink" title="2.5、工作原理"></a>2.5、工作原理</h3><p>AiServices会组装Assistant接口以及其他组件，并使用反射机制创建一个实现Assistant接口的代理对象。 这个代理对象会处理输入和输出的所有转换工作。在这个例子中，chat方法的输入是一个字符串，但是大 模型需要一个 UserMessage 对象。所以，代理对象将这个字符串转换为 UserMessage ，并调用聊天语 言模型。chat方法的输出类型也是字符串，但是大模型返回的是  AiMessage 对象，代理对象会将其转换 为字符串。 </p>
<p>简单理解就是：代理对象的作用是输入转换和输出转换</p>
<h1 id="三、聊天记忆-Chat-memory"><a href="#三、聊天记忆-Chat-memory" class="headerlink" title="三、聊天记忆 Chat memory"></a>三、聊天记忆 Chat memory</h1><h2 id="1、聊天记忆的简单实现"><a href="#1、聊天记忆的简单实现" class="headerlink" title="1、聊天记忆的简单实现"></a>1、聊天记忆的简单实现</h2><p>聊天记忆就是将以前的对话也一起发给大模型</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"> <span class="keyword">private</span> QwenChatModel qwenChatModel;</span><br><span class="line"> <span class="meta">@Test</span></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testChatMemory2</span><span class="params">()</span> &#123;</span><br><span class="line">     <span class="comment">//第一轮对话</span></span><br><span class="line">     <span class="type">UserMessage</span> <span class="variable">userMessage1</span> <span class="operator">=</span> UserMessage.userMessage(<span class="string">&quot;我是环环&quot;</span>);</span><br><span class="line">     <span class="type">ChatResponse</span> <span class="variable">chatResponse1</span> <span class="operator">=</span> qwenChatModel.chat(userMessage1);</span><br><span class="line">     <span class="type">AiMessage</span> <span class="variable">aiMessage1</span> <span class="operator">=</span> chatResponse1.aiMessage();</span><br><span class="line">     <span class="comment">//输出大语言模型的回复</span></span><br><span class="line">     System.out.println(aiMessage1.text());</span><br><span class="line">     <span class="comment">//第二轮对话</span></span><br><span class="line">     <span class="type">UserMessage</span> <span class="variable">userMessage2</span> <span class="operator">=</span> UserMessage.userMessage(<span class="string">&quot;你知道我是谁吗&quot;</span>);</span><br><span class="line">     <span class="type">ChatResponse</span> <span class="variable">chatResponse2</span> <span class="operator">=</span> qwenChatModel.chat(Arrays.asList(userMessage1, aiMessage1, userMessage2));</span><br><span class="line">     <span class="type">AiMessage</span> <span class="variable">aiMessage2</span> <span class="operator">=</span> chatResponse2.aiMessage();</span><br><span class="line">     <span class="comment">//输出大语言模型的回复</span></span><br><span class="line">    System.out.println(aiMessage2.text());</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<h2 id="2、使用ChatMemory实现聊天记忆"><a href="#2、使用ChatMemory实现聊天记忆" class="headerlink" title="2、使用ChatMemory实现聊天记忆"></a>2、使用ChatMemory实现聊天记忆</h2><p>使用AIService可以封装多轮对话的复杂性，使聊天记忆功能的实现变得简单</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">@Test</span><br><span class="line"> public void testChatMemory3() &#123;</span><br><span class="line">     //创建chatMemory</span><br><span class="line">     MessageWindowChatMemory chatMemory = MessageWindowChatMemory.withMaxMessages(10);</span><br><span class="line">     //创建AIService</span><br><span class="line">     Assistant assistant = AiServices</span><br><span class="line">     	.builder(Assistant.class)</span><br><span class="line">     	.chatLanguageModel(qwenChatModel)</span><br><span class="line">     	.chatMemory(chatMemory)</span><br><span class="line">    	.build();</span><br><span class="line">     //调用service的接口</span><br><span class="line">     String answer1 = assistant.chat(&quot;我是环环&quot;);</span><br><span class="line">     System.out.println(answer1);</span><br><span class="line">     String answer2 = assistant.chat(&quot;我是谁&quot;);</span><br><span class="line">     System.out.println(answer2);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<h2 id="3、使用AIService实现聊天记忆"><a href="#3、使用AIService实现聊天记忆" class="headerlink" title="3、使用AIService实现聊天记忆"></a>3、使用AIService实现聊天记忆</h2><h3 id="3-1、创建记忆对话智能体"><a href="#3-1、创建记忆对话智能体" class="headerlink" title="3.1、创建记忆对话智能体"></a>3.1、创建记忆对话智能体</h3><p>当AIService由多个组件（大模型，聊天记忆，等）组成的时候，我们就可以称他为 智能体 了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.java.ai.langchain4j.assistant;</span><br><span class="line"> <span class="meta">@AiService(</span></span><br><span class="line"><span class="meta">     wiringMode = EXPLICIT,</span></span><br><span class="line"><span class="meta">     chatModel = &quot;qwenChatModel&quot;,</span></span><br><span class="line"><span class="meta">     chatMemory = &quot;chatMemory&quot;</span></span><br><span class="line"><span class="meta"> )</span></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MemoryChatAssistant</span> &#123;</span><br><span class="line">     String <span class="title function_">chat</span><span class="params">(String message)</span>;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-2、配置ChatMemory"><a href="#3-2、配置ChatMemory" class="headerlink" title="3.2、配置ChatMemory"></a>3.2、配置ChatMemory</h3><p>注册bean记得名字和类型一致</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.java.ai.langchain4j.config;</span><br><span class="line"> <span class="meta">@Configuration</span></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MemoryChatAssistantConfig</span> &#123;</span><br><span class="line">     <span class="meta">@Bean</span></span><br><span class="line">     ChatMemory <span class="title function_">chatMemory</span><span class="params">()</span> &#123;</span><br><span class="line">         <span class="comment">//设置聊天记忆记录的message数量</span></span><br><span class="line">        <span class="keyword">return</span> MessageWindowChatMemory.withMaxMessages(<span class="number">10</span>);</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<h2 id="4、隔离聊天记忆"><a href="#4、隔离聊天记忆" class="headerlink" title="4、隔离聊天记忆"></a>4、隔离聊天记忆</h2><p>为每个用户的新聊天或者不同的用户区分聊天记忆</p>
<h3 id="4-1、创建记忆隔离对话智能体"><a href="#4-1、创建记忆隔离对话智能体" class="headerlink" title="4.1、创建记忆隔离对话智能体"></a>4.1、创建记忆隔离对话智能体</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.java.ai.langchain4j.assistant;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.service.MemoryId;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.service.UserMessage;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.service.spring.AiService;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> dev.langchain4j.service.spring.AiServiceWiringMode.EXPLICIT;</span><br><span class="line"></span><br><span class="line"><span class="meta">@AiService(</span></span><br><span class="line"><span class="meta">        wiringMode = EXPLICIT,</span></span><br><span class="line"><span class="meta">        chatMemory = &quot;chatMemory&quot;,</span></span><br><span class="line"><span class="meta">        chatMemoryProvider = &quot;chatMemoryProvider&quot;</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">SeparateChatAssistant</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 分离聊天记录</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> memoryId 聊天id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userMessage 用户消息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String <span class="title function_">chat</span><span class="params">(<span class="meta">@MemoryId</span> <span class="type">int</span> memoryId, <span class="meta">@UserMessage</span> String userMessage)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="4-2、配置ChatMemoryProvider"><a href="#4-2、配置ChatMemoryProvider" class="headerlink" title="4.2、配置ChatMemoryProvider"></a>4.2、配置ChatMemoryProvider</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.java.ai.langchain4j.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.atguigu.java.ai.langchain4j.store.MongoChatMemoryStore;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.memory.chat.ChatMemoryProvider;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.memory.chat.MessageWindowChatMemory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SeparateChatAssistantConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//因为目前存在内存，后面使用mongodb存储，持久化</span></span><br><span class="line">    <span class="comment">//@Autowired</span></span><br><span class="line">    <span class="comment">//private MongoChatMemoryStore mongoChatMemoryStore;</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ChatMemoryProvider <span class="title function_">chatMemoryProvider</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> memoryId -&gt; MessageWindowChatMemory</span><br><span class="line">                .builder()</span><br><span class="line">                .maxMessages(<span class="number">10</span>)</span><br><span class="line">                .id(memoryId)</span><br><span class="line">                <span class="comment">//.chatMemoryStore(mongoChatMemoryStore)</span></span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="四、持久化聊天记忆-Persistence"><a href="#四、持久化聊天记忆-Persistence" class="headerlink" title="四、持久化聊天记忆 Persistence"></a>四、持久化聊天记忆 Persistence</h1><p>默认情况下，聊天记忆存储在内存中。如果需要持久化存储，可以实现一个自定义的聊天记忆存储类， 以便将聊天消息存储在你选择的任何持久化存储介质中。</p>
<h2 id="1、存储介质的选择"><a href="#1、存储介质的选择" class="headerlink" title="1、存储介质的选择"></a>1、存储介质的选择</h2><p>大模型中聊天记忆的存储选择那种数据库，需要综合考虑数据特点、应用场景和性能要求等因素，以下<br>是一些常见的选择及其特点：<br>MySQL</p>
<ul>
<li>特点：关系型数据库。支持事务处理，确保数据的一致性和完整性，适用于结构化数据的存储和查询。</li>
<li>适用场景：如果聊天记忆数据结构较为规整，例如包含固定的字段如对话D、用户D、时间戳、消息内容等，且需要进行复杂的查询和统计分析，如按用户统计对话次数、按时间范围查询特定对话等，MySQL是不错的选择</li>
</ul>
<p>Redis</p>
<ul>
<li>特点：内存数据库，读写速度极高。它适用于存储热点数据，并且支持多种数据结构，如字符串、哈希表、列表等，方便对不同类型的聊天记忆数据进行处理。</li>
<li>适用场景：对于实时性要求极高的聊天应用，如在线客服系统或即时通讯工具，Rdis可以快速存储和获取最新的聊天记录，以提供流畅的聊天体验。</li>
</ul>
<p>MongoDB</p>
<ul>
<li>特点：文档型数据库，数据以JSON-Ike的文档形式存储，具有高度的灵活性和可扩展性。它不需要预先定义严格的表结构，适合存储半结构化或非结构化的数据。</li>
<li>适用场景：当聊天记忆中包含多样化的信息，如文本消息、图片、语音等多媒体数据，或者消息格式可能会频繁变化时，MongoDB能很好地适应这种灵活性。例如，一些社交应用中用户可能会发送各种格式的消息，使用MongoDB可以方便地存储和管理这些不同类型的数据。</li>
</ul>
<p>Cassandra—<strong>这个没见过</strong></p>
<ul>
<li>特点：是一种分布式的NoSQL数据库，具有高可扩展性和高可用性，能够处理大规模的分布式数据存储和读写请求。适合存储海量的、时间序列相关的数据。</li>
<li>适用场景：对于大型的聊天应用，尤其是用户量众多、聊天数据量巨大且需要分布式存储和处理的场景，Cassandra能够有效地应对高并发的读写操作。例如，一些面向全球用户的社交媒体平台，其职聊天数据需要在多个节点上进行分布式存储和管理，Cassandra可以提供强大的支持</li>
</ul>
<h2 id="2、MongoDB"><a href="#2、MongoDB" class="headerlink" title="2、MongoDB"></a>2、MongoDB</h2><h3 id="2-1、简介"><a href="#2-1、简介" class="headerlink" title="2.1、简介"></a>2.1、简介</h3><ul>
<li><p>MongoDB是一个基于文档的NoSQL数据库，由MongoDB Inc.开发，</p>
</li>
<li><p>NoSQL,指的是非关系型的数据库。NoSQL有时也称作Not Only SQL的缩写，是对不同于传统的关系型数据库的数据库管理系统的统称。</p>
</li>
<li><p>MongoDB的设计理念是为了应对大数据量、高性能和灵活性需求。</p>
</li>
<li><p>MongoDB使用集合(Collections)来组织文档(Documents),每个文档都是由键值对组成的。</p>
<ul>
<li><p>数据库(Database):存储数据的容器，类似于关系型数据库中的数据库。</p>
</li>
<li><p>集合(Collection):数据库中的一个集合，类以于关系型数据库中的表。</p>
</li>
<li><p>文档(Document):集合中的一个数据记录，类似于关系型数据库中的行(row),以BSON格式存储。</p>
</li>
</ul>
</li>
</ul>
<p>MongoDB将数据存储为一个文档，数据结构由键值(key&#x3D;&gt;value)对组成，文档类以于JSON对象，字段值可以包含其他文档，数组及文档数组：</p>
<p><img src="/2025/04/29/langchain4j/image-20250429165149289.png" alt="image-20250429165149289"></p>
<h3 id="2-2、安装MongoDB"><a href="#2-2、安装MongoDB" class="headerlink" title="2.2、安装MongoDB"></a>2.2、安装MongoDB</h3><p>服务器： mongodb-windows-x86_64-8.0.6-signed.msi <a target="_blank" rel="noopener" href="https://www.mongodb.com/try/download/co">https://www.mongodb.com/try/download/co</a> mmunity </p>
<p>命令行客户端 ： mongosh-2.5.0-win32-x64.zip <a target="_blank" rel="noopener" href="https://www.mongodb.com/try/download/shell">https://www.mongodb.com/try/download/shell</a> </p>
<p>图形客户端： mongodb-compass-1.39.3-win32-x64.exe <a target="_blank" rel="noopener" href="https://www.mongodb.com/try/download/c">https://www.mongodb.com/try/download/c</a> ompass</p>
<h3 id="2-3、使用mongosh"><a href="#2-3、使用mongosh" class="headerlink" title="2.3、使用mongosh"></a>2.3、使用mongosh</h3><p>掌握图形化界面就行，命令行用到再说</p>
<ul>
<li>查看当前数据库：db</li>
<li>显示数据库列表：show dbs</li>
<li>切换到指定数据库：use<database_name></database_name></li>
<li>执行查询操作：db.<collection_name>.find()</collection_name></li>
<li>插入文档：db.<collection_name>.insert0ne({})</collection_name></li>
<li>更新文档：db.<collection-name>.update0ne({.·})</collection-name></li>
<li>删除文档：db.<collection_name>.delete0ne({·..})</collection_name></li>
<li>退出MongoDB Shell:quit()或者exit</li>
</ul>
<p>CRUD</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 插入文档</span></span><br><span class="line"><span class="built_in">test</span>&gt; db.mycollection.insertOne(&#123; name: <span class="string">&quot;Alice&quot;</span>, age: 30 &#125;)</span><br><span class="line"> <span class="comment"># 查询文档</span></span><br><span class="line"><span class="built_in">test</span>&gt; db.mycollection.find()</span><br><span class="line"> <span class="comment"># 更新文档</span></span><br><span class="line"><span class="built_in">test</span>&gt; db.mycollection.updateOne(&#123; name: <span class="string">&quot;Alice&quot;</span> &#125;, &#123; <span class="variable">$set</span>: &#123; age: 31 &#125; &#125;)</span><br><span class="line"> <span class="comment"># 删除文档</span></span><br><span class="line"><span class="built_in">test</span>&gt; db.mycollection.deleteOne(&#123; name: <span class="string">&quot;Alice&quot;</span> &#125;)</span><br><span class="line"> <span class="comment"># 退出 MongoDB Shell</span></span><br><span class="line"><span class="built_in">test</span>&gt; quit()</span><br></pre></td></tr></table></figure>

<h3 id="2-4、使用mongodb-compass"><a href="#2-4、使用mongodb-compass" class="headerlink" title="2.4、使用mongodb-compass"></a>2.4、使用mongodb-compass</h3><p><img src="/2025/04/29/langchain4j/image-20250429165405198.png" alt="image-20250429165405198"></p>
<h3 id="2-5、整合SpringBoot"><a href="#2-5、整合SpringBoot" class="headerlink" title="2.5、整合SpringBoot"></a>2.5、整合SpringBoot</h3><p>引入MongoDB依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- Spring Boot Starter Data MongoDB --&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-mongodb<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>添加远程连接配置：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#MongoDB连接配置</span></span><br><span class="line"><span class="string">spring.data.mongodb.uri=mongodb://localhost:27017/chat_memory_db</span></span><br></pre></td></tr></table></figure>

<h3 id="2-6、CRUD测试"><a href="#2-6、CRUD测试" class="headerlink" title="2.6、CRUD测试"></a>2.6、CRUD测试</h3><p>创建实体类：映射MongoDB中的文档（相当与MySQL的表）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.java.ai.langchain4j.bean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> org.bson.types.ObjectId;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.annotation.Id;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.mongodb.core.mapping.Document;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@Document(&quot;chat_messages&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ChatMessages</span> &#123;</span><br><span class="line">    <span class="comment">//唯一标识，映射到 MongoDB 文档的 _id 字段</span></span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="keyword">private</span> ObjectId messageId;</span><br><span class="line">    <span class="comment">//private Long messageId;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String content; <span class="comment">//存储当前聊天记录列表的json字符串</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建测试类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.java.ai.langchain4j;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.atguigu.java.ai.langchain4j.bean.ChatMessages;</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.mongodb.core.MongoTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.mongodb.core.query.Criteria;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.mongodb.core.query.Query;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.mongodb.core.query.Update;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MongoCrudTest</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MongoTemplate mongoTemplate;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 插入文档</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">   <span class="comment">/* @Test</span></span><br><span class="line"><span class="comment">    public void testInsert() &#123;</span></span><br><span class="line"><span class="comment">        mongoTemplate.insert(new ChatMessages(1L, &quot;聊天记录&quot;));</span></span><br><span class="line"><span class="comment">    &#125;*/</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 插入文档</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testInsert2</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">ChatMessages</span> <span class="variable">chatMessages</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChatMessages</span>();</span><br><span class="line">        chatMessages.setContent(<span class="string">&quot;聊天记录列表&quot;</span>);</span><br><span class="line">        mongoTemplate.insert(chatMessages);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据id查询文档</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testFindById</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">ChatMessages</span> <span class="variable">chatMessages</span> <span class="operator">=</span> mongoTemplate.findById(<span class="string">&quot;6801ead733ba9c4a0d9b6c7b&quot;</span>,</span><br><span class="line">                ChatMessages.class);</span><br><span class="line">        System.out.println(chatMessages);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 修改文档</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testUpdate</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Criteria</span> <span class="variable">criteria</span> <span class="operator">=</span> Criteria.where(<span class="string">&quot;_id&quot;</span>).is(<span class="string">&quot;6801ead733ba9c4a0d9b6c7b&quot;</span>);</span><br><span class="line">        <span class="type">Query</span> <span class="variable">query</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Query</span>(criteria);</span><br><span class="line">        <span class="type">Update</span> <span class="variable">update</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Update</span>();</span><br><span class="line">        update.set(<span class="string">&quot;content&quot;</span>, <span class="string">&quot;新的聊天记录列表&quot;</span>);</span><br><span class="line">        <span class="comment">//修改或新增</span></span><br><span class="line">        mongoTemplate.upsert(query, update, ChatMessages.class);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 新增或修改文档</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testUpdate2</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Criteria</span> <span class="variable">criteria</span> <span class="operator">=</span> Criteria.where(<span class="string">&quot;_id&quot;</span>).is(<span class="string">&quot;100&quot;</span>);</span><br><span class="line">        <span class="type">Query</span> <span class="variable">query</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Query</span>(criteria);</span><br><span class="line">        <span class="type">Update</span> <span class="variable">update</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Update</span>();</span><br><span class="line">        update.set(<span class="string">&quot;content&quot;</span>, <span class="string">&quot;新的聊天记录列表&quot;</span>);</span><br><span class="line">        <span class="comment">//修改或新增</span></span><br><span class="line">        mongoTemplate.upsert(query, update, ChatMessages.class);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除文档</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testDelete</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Criteria</span> <span class="variable">criteria</span> <span class="operator">=</span> Criteria.where(<span class="string">&quot;_id&quot;</span>).is(<span class="string">&quot;100&quot;</span>);</span><br><span class="line">        <span class="type">Query</span> <span class="variable">query</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Query</span>(criteria);</span><br><span class="line">        mongoTemplate.remove(query, ChatMessages.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3、持久化聊天"><a href="#3、持久化聊天" class="headerlink" title="3、持久化聊天"></a>3、持久化聊天</h2><h3 id="3-1、优化实体类"><a href="#3-1、优化实体类" class="headerlink" title="3.1、优化实体类"></a>3.1、优化实体类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.java.ai.langchain4j.bean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> org.bson.types.ObjectId;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.annotation.Id;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.mongodb.core.mapping.Document;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@Document(&quot;chat_messages&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ChatMessages</span> &#123;</span><br><span class="line">    <span class="comment">//唯一标识，映射到 MongoDB 文档的 _id 字段</span></span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="keyword">private</span> ObjectId id;</span><br><span class="line">    <span class="comment">//private Long messageId;</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> messageId;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String content; <span class="comment">//存储当前聊天记录列表的json字符串</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-2、创建持久化类"><a href="#3-2、创建持久化类" class="headerlink" title="3.2、创建持久化类"></a>3.2、创建持久化类</h3><p>创建一个类实现ChatMemoryStore接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.java.ai.langchain4j.store;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.atguigu.java.ai.langchain4j.bean.ChatMessages;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.data.message.ChatMessage;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.data.message.ChatMessageDeserializer;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.data.message.ChatMessageSerializer;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.store.memory.chat.ChatMemoryStore;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.mongodb.core.MongoTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.mongodb.core.query.Criteria;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.mongodb.core.query.Query;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.mongodb.core.query.Update;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.LinkedList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="comment">//重写了ChatMemoryStore，本来是写到内存中的，现在重写写入MongoDb</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MongoChatMemoryStore</span> <span class="keyword">implements</span> <span class="title class_">ChatMemoryStore</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MongoTemplate mongoTemplate;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//获取信息</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;ChatMessage&gt; <span class="title function_">getMessages</span><span class="params">(Object memoryId)</span> &#123;</span><br><span class="line">        <span class="comment">//从MongoDB找出来消息----Query</span></span><br><span class="line">        <span class="type">Criteria</span> <span class="variable">criteria</span> <span class="operator">=</span> Criteria.where(<span class="string">&quot;memoryId&quot;</span>).is(memoryId);</span><br><span class="line">        <span class="type">Query</span> <span class="variable">query</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Query</span>(criteria);</span><br><span class="line">        <span class="type">ChatMessages</span> <span class="variable">chatMessages</span> <span class="operator">=</span> mongoTemplate.findOne(query, ChatMessages.class);</span><br><span class="line">        <span class="keyword">if</span>(chatMessages == <span class="literal">null</span>) <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">//chatMessages拿出来再转回Json</span></span><br><span class="line">        <span class="keyword">return</span> ChatMessageDeserializer.messagesFromJson(chatMessages.getContent());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//更新</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateMessages</span><span class="params">(Object memoryId, List&lt;ChatMessage&gt; messages)</span> &#123;</span><br><span class="line">        <span class="type">Criteria</span> <span class="variable">criteria</span> <span class="operator">=</span> Criteria.where(<span class="string">&quot;memoryId&quot;</span>).is(memoryId);</span><br><span class="line">        <span class="type">Query</span> <span class="variable">query</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Query</span>(criteria);</span><br><span class="line">        <span class="type">Update</span> <span class="variable">update</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Update</span>();</span><br><span class="line">        <span class="comment">//ChatMessageSerializer.messagesToJson转json存储</span></span><br><span class="line">        update.set(<span class="string">&quot;content&quot;</span>, ChatMessageSerializer.messagesToJson(messages));</span><br><span class="line">        <span class="comment">//根据query条件能查询出文档，则修改文档；否则新增文档</span></span><br><span class="line">        mongoTemplate.upsert(query, update, ChatMessages.class);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//删除</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deleteMessages</span><span class="params">(Object memoryId)</span> &#123;</span><br><span class="line">        <span class="type">Criteria</span> <span class="variable">criteria</span> <span class="operator">=</span> Criteria.where(<span class="string">&quot;memoryId&quot;</span>).is(memoryId);</span><br><span class="line">        <span class="type">Query</span> <span class="variable">query</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Query</span>(criteria);</span><br><span class="line">        mongoTemplate.remove(query, ChatMessages.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在SeparateChatAssistantConfig中，添加MongoChatMemoryStore对象的配置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.java.ai.langchain4j.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.atguigu.java.ai.langchain4j.store.MongoChatMemoryStore;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.memory.chat.ChatMemoryProvider;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.memory.chat.MessageWindowChatMemory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SeparateChatAssistantConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MongoChatMemoryStore mongoChatMemoryStore;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ChatMemoryProvider <span class="title function_">chatMemoryProvider</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> memoryId -&gt; MessageWindowChatMemory</span><br><span class="line">                .builder()</span><br><span class="line">                .maxMessages(<span class="number">10</span>)</span><br><span class="line">                .id(memoryId)</span><br><span class="line">                .chatMemoryStore(mongoChatMemoryStore)<span class="comment">//配置持久化对象</span></span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4、测试"><a href="#4、测试" class="headerlink" title="4、测试"></a>4、测试</h2><p><img src="/2025/04/29/langchain4j/image-20250429165959047.png" alt="image-20250429165959047"></p>
<h1 id="五、提示词-Prompt"><a href="#五、提示词-Prompt" class="headerlink" title="五、提示词 Prompt"></a>五、提示词 Prompt</h1><h2 id="1、系统提示词"><a href="#1、系统提示词" class="headerlink" title="1、系统提示词"></a>1、系统提示词</h2><p>@SystemMessage 设定角色，塑造AI助手的专业身份，明确助手的能力范围</p>
<h3 id="1-1、配置-SystemMessage"><a href="#1-1、配置-SystemMessage" class="headerlink" title="1.1、配置@SystemMessage"></a>1.1、配置@SystemMessage</h3><p> 在SeparateChatAssistant类的chat方法上添加@SystemMessage注解</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SystemMessage(&quot;你是我的好朋友，请用东北话回答问题。&quot;)</span><span class="comment">//系统消息提示词</span></span><br><span class="line">String <span class="title function_">chat</span><span class="params">(<span class="meta">@MemoryId</span> <span class="type">int</span> memoryId, <span class="meta">@UserMessage</span> String userMessage)</span>;</span><br></pre></td></tr></table></figure>

<p> @SystemMessage 的内容将在后台转换为  SystemMessage 对象，并与  UserMessage 一起发送给大语言模型（LLM）。 SystemMessaged的内容只会发送给大模型一次。  如果你修改了SystemMessage的内容，新的SystemMessage会被发送给大模型，之前的聊天记忆会失效。</p>
<h3 id="1-2、测试"><a href="#1-2、测试" class="headerlink" title="1.2、测试"></a>1.2、测试</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.java.ai.langchain4j;</span><br><span class="line"> <span class="meta">@SpringBootTest</span></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PromptTest</span> &#123;</span><br><span class="line">     <span class="meta">@Autowired</span></span><br><span class="line">     <span class="keyword">private</span> SeparateChatAssistant separateChatAssistant;</span><br><span class="line"></span><br><span class="line">     <span class="meta">@Test</span></span><br><span class="line">     <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSystemMessage</span><span class="params">()</span> &#123;</span><br><span class="line">         <span class="type">String</span> <span class="variable">answer</span> <span class="operator">=</span> separateChatAssistant.chat(<span class="number">3</span>,<span class="string">&quot;今天几号&quot;</span>);</span><br><span class="line">         System.out.println(answer);</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果要显示今天的日期，我们需要在提示词中添加当前日期的占位符</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">@SystemMessage(&quot;你是我的好朋友，请用东北话回答问题。今天是&#123;&#123;current_date&#125;&#125;&quot;)</span><span class="comment">//系统消息提示词</span></span><br><span class="line">String <span class="title function_">chat</span><span class="params">(<span class="meta">@MemoryId</span> <span class="type">int</span> memoryId, <span class="meta">@UserMessage</span> String userMessage)</span>;</span><br></pre></td></tr></table></figure>

<h3 id="1-3、从资源中加载提示模板"><a href="#1-3、从资源中加载提示模板" class="headerlink" title="1.3、从资源中加载提示模板"></a>1.3、从资源中加载提示模板</h3><p>@SystemMessage 注解还可以从资源中加载提示模板：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SystemMessage(fromResource = &quot;my-prompt-template.txt&quot;)</span></span><br><span class="line"> String <span class="title function_">chat</span><span class="params">(<span class="meta">@MemoryId</span> <span class="type">int</span> memoryId, <span class="meta">@UserMessage</span> String userMessage)</span>;</span><br></pre></td></tr></table></figure>

<p> my-prompt-template.txt</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">你是我的好朋友，请用东北话回答问题，回答问题的时候适当添加表情符号。</span><br></pre></td></tr></table></figure>

表示当前日期

<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">你是我的好朋友，请用东北话回答问题，回答问题的时候适当添加表情符号。</span><br><span class="line">今天是 &#123;&#123;current_date&#125;&#125;。</span><br></pre></td></tr></table></figure>

<p>提示词很不错，例如在接下来的项目中可以发现，可以指定人工智能身份，让他对范围之外的不回答</p>
<h2 id="2、用户提示词模板"><a href="#2、用户提示词模板" class="headerlink" title="2、用户提示词模板"></a>2、用户提示词模板</h2><p>@UserMessage：获取用户输入</p>
<h3 id="2-1、配置-UserMessage"><a href="#2-1、配置-UserMessage" class="headerlink" title="2.1、配置@UserMessage"></a>2.1、配置@UserMessage</h3><p>在MemoryChatAssistant 的 chat 方法中添加注解</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@UserMessage(&quot;你是我的好朋友，请用上海话回答问题，并且添加一些表情符号。 &#123;&#123;it&#125;&#125;&quot;)</span> <span class="comment">//&#123;&#123;it&#125;&#125;表示这里唯一的参数的占位符，固定的</span></span><br><span class="line">String <span class="title function_">chat</span><span class="params">(String message)</span>;</span><br></pre></td></tr></table></figure>

<h2 id="3、指定参数名称"><a href="#3、指定参数名称" class="headerlink" title="3、指定参数名称"></a>3、指定参数名称</h2><h3 id="3-1、配置-V"><a href="#3-1、配置-V" class="headerlink" title="3.1、配置@V"></a>3.1、配置@V</h3><p>@V 明确指定传递的参数名称</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@UserMessage(&quot;你是我的好朋友，请用上海话回答问题，并且添加一些表情符号。&#123;&#123;message&#125;&#125;&quot;)</span></span><br><span class="line"> String <span class="title function_">chat</span><span class="params">(<span class="meta">@V(&quot;message&quot;)</span> String userMessage)</span>;</span><br></pre></td></tr></table></figure>

<h3 id="3-2、多个参数的情况"><a href="#3-2、多个参数的情况" class="headerlink" title="3.2、多个参数的情况"></a>3.2、多个参数的情况</h3><p>如果有两个或两个以上的参数，我们必须要用@V，在 SeparateChatAssistant 中定义方法 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@UserMessage(&quot;你是我的好朋友，请用粤语回答问题。&#123;&#123;message&#125;&#125;&quot;)</span> </span><br><span class="line">String <span class="title function_">chat2</span><span class="params">(<span class="meta">@MemoryId</span> <span class="type">int</span> memoryId, <span class="meta">@V(&quot;message&quot;)</span> String userMessage)</span>; </span><br></pre></td></tr></table></figure>

<h3 id="3-3、-SystemMessage和-V"><a href="#3-3、-SystemMessage和-V" class="headerlink" title="3.3、@SystemMessage和@V"></a>3.3、@SystemMessage和@V</h3><p>也可以将 @SystemMessage 和 @V 结合使用 </p>
<p>在SeparateChatAssistant 中添加方法chat3</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SystemMessage(fromResource = &quot;my-prompt-template3.txt&quot;)</span></span><br><span class="line">String <span class="title function_">chat3</span><span class="params">(</span></span><br><span class="line"><span class="params">   <span class="meta">@MemoryId</span> <span class="type">int</span> memoryId, </span></span><br><span class="line"><span class="params">   <span class="meta">@UserMessage</span> String userMessage, </span></span><br><span class="line"><span class="params">   <span class="meta">@V(&quot;username&quot;)</span> String username, </span></span><br><span class="line"><span class="params">   <span class="meta">@V(&quot;age&quot;)</span> <span class="type">int</span> age</span></span><br><span class="line"><span class="params">)</span>;</span><br></pre></td></tr></table></figure>

<p>创建提示词模板my-prompt-template3.txt，添加占位符</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">你是我的好朋友，我是&#123;&#123;username&#125;&#125;，我的年龄是&#123;&#123;age&#125;&#125;，请用东北话回答问题，回答问题的时候适当添加表情符号。</span><br><span class="line">今天是 &#123;&#123;current_date&#125;&#125;。</span><br></pre></td></tr></table></figure>

<p>测试</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testUserInfo</span><span class="params">()</span> &#123;</span><br><span class="line">     <span class="type">String</span> <span class="variable">answer</span> <span class="operator">=</span> separateChatAssistant.chat3(<span class="number">1</span>, <span class="string">&quot;我是谁，我多大了&quot;</span>, <span class="string">&quot;翠花&quot;</span>, <span class="number">18</span>);</span><br><span class="line">     System.out.println(answer);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<h1 id="六、-Function-Calling-函数调用"><a href="#六、-Function-Calling-函数调用" class="headerlink" title="六、 Function Calling 函数调用"></a>六、 Function Calling 函数调用</h1><p>Function Calling 函数调用 也叫   Tools 工具</p>
<h2 id="1、-Tool注解的可选字段"><a href="#1、-Tool注解的可选字段" class="headerlink" title="1、@Tool注解的可选字段"></a>1、@Tool注解的可选字段</h2><p>@T001注解有两个可选字段：</p>
<ul>
<li>name(工具名称)：工具的名称。如果未提供该字段，方法名会作为工具的名称。</li>
<li>value(工具描述)：工具的描述信息。</li>
</ul>
<p>根据工具的不同，即使没有任何描述，大语言模型可能也能很好地理解它（例如，add(a,b)就很直观)，但通常最好提供清晰且有意义的名称和描述。这样，大语言模型就能获得更多信息，以决定是否调用给定的工具以及如何调用。</p>
<h2 id="2、-P注解"><a href="#2、-P注解" class="headerlink" title="2、@P注解"></a>2、@P注解</h2><p>方法参数可以选择使用@P注解进行标注。<br>@P注解有两个字段：<br>value:参数的描述信息，这是必填字段。<br>required:表示该参数是否为必需项，默认值为true,此为可选字段。</p>
<h2 id="3、-ToolMemoryId"><a href="#3、-ToolMemoryId" class="headerlink" title="3、@ToolMemoryId"></a>3、@ToolMemoryId</h2><p>如果你的AIService方法中有一个参数使用  @MemoryId 注解，那么你也可以使用  @Tool 方法中的一个参数。提供给AIService方法的值将自动传递给 @ToolMemoryId 注解  @Tool 方法。如果你有多个用户， 或每个用户有多个聊天记忆，并且希望在  @Tool 方法中对它们进行区分，那么这个功能会很有用。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.java.ai.langchain4j.tools;</span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CalculatorTools</span> &#123;</span><br><span class="line">     <span class="meta">@Tool(name = &quot;加法&quot;, value = &quot;返回两个参数相加之和&quot;)</span></span><br><span class="line">     <span class="type">double</span> <span class="title function_">sum</span><span class="params">(</span></span><br><span class="line"><span class="params">         <span class="meta">@ToolMemoryId</span> <span class="type">int</span> memoryId,</span></span><br><span class="line"><span class="params">         <span class="meta">@P(value=&quot;加数1&quot;, required = true)</span> <span class="type">double</span> a,</span></span><br><span class="line"><span class="params">         <span class="meta">@P(value=&quot;加数2&quot;, required = true)</span> <span class="type">double</span> b)</span> &#123;</span><br><span class="line">             System.out.println(<span class="string">&quot;调用加法运算 &quot;</span> + memoryId);</span><br><span class="line">             <span class="keyword">return</span> a + b;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="meta">@Tool(name = &quot;平方根&quot;, value = &quot;返回给定参数的平方根&quot;)</span></span><br><span class="line">     <span class="type">double</span> <span class="title function_">squareRoot</span><span class="params">(</span></span><br><span class="line"><span class="params">                <span class="meta">@ToolMemoryId</span> <span class="type">int</span> memoryId, <span class="type">double</span> x)</span> &#123;</span><br><span class="line">         System.out.println(<span class="string">&quot;调用平方根运算 &quot;</span> + memoryId);</span><br><span class="line">         <span class="keyword">return</span> Math.sqrt(x);</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="七、检索增强生成-RAG"><a href="#七、检索增强生成-RAG" class="headerlink" title="七、检索增强生成 RAG"></a>七、检索增强生成 RAG</h1><h2 id="1、RAG"><a href="#1、RAG" class="headerlink" title="1、RAG"></a>1、RAG</h2><p>Retrieval-Augmented Generation 检索增强生成 </p>
<p>将原始问题以及提示词信息发送给大语言模型之前，先通过外部知识库检索相关信息，然后将检索结果 和原始问题一起发送给大模型，大模型依据外部知识库再结合自身的训练数据，组织自然语言回答问 题。通过这种方式，大语言模型可以获取到特定领域的相关信息，并能够利用这些信息进行回复。 </p>
<ul>
<li>优点：数据存储在外部知识库，可以实时更新，不依赖对模型自身的训练，成本更低。 </li>
<li>缺点：需要两次查询：先查询知识库，然后再查询大模型，性能不如微调大模型 </li>
<li>应用场景：适用于知识库规模大且频繁更新的场景，如企业客服、实时新闻查询、法律和医疗领域 的最新知识问答等。</li>
</ul>
<h2 id="2、RAG常用方法"><a href="#2、RAG常用方法" class="headerlink" title="2、RAG常用方法"></a>2、RAG常用方法</h2><ul>
<li>全文（关键词）搜索。这种方法通过将问题和提示词中的关键词与知识库文档数据库进行匹配来搜索文档。根据这些关键词在每个文档中的出现频率和相关性对搜索结果进行排序。</li>
<li>向量搜索，也被称为“语义搜索”。文本通过嵌入模型被转换为数字向量。然后，它根据查询向量与文档向量之间的余弦相似度或其他相似性&#x2F;距离度量来查找和排序文档，从而捕捉更深层次的语义含义。</li>
<li>混合搜索。结合多种搜索方法（例如，全文搜索+向量搜索）通常可以提高搜索的效果。</li>
</ul>
<h3 id="2-1、向量搜索"><a href="#2-1、向量搜索" class="headerlink" title="2.1、向量搜索"></a>2.1、向量搜索</h3><p>就是将事物特征抽象一个多维向量（1，1，1，1，1，1，0）这种，用许多位来表示是否有这个或者有哪个，两个向量间重复越多就代表越是接近，网上说512个比特位来表示一个事务，Transomfer也是如此来测算语义的</p>
<h2 id="3、-RAG的过程"><a href="#3、-RAG的过程" class="headerlink" title="3、 RAG的过程"></a>3、 RAG的过程</h2><p>RAG 过程分为 2 个不同的阶段：索引和检索。</p>
<h3 id="3-1、索引"><a href="#3-1、索引" class="headerlink" title="3.1、索引"></a>3.1、索引</h3><p>在索引阶段，对知识库文档进行预处理，可实现检索阶段的高效搜索。</p>
<p> 以下是索引阶段的简化图： </p>
<p>加载知识库文档 &#x3D;&#x3D;&gt; 将文档中的文本分段 &#x3D;&#x3D;&gt; 利用向量大模型将分段后的文本转换成向量 &#x3D;&#x3D;&gt; 将向量存 入向量数据库</p>
<p><img src="/2025/04/29/langchain4j/image-20250430144111015.png" alt="image-20250430144111015"></p>
<p><strong>为什么要进行文本分段？</strong> </p>
<p>大语言模型（LLM）的上下文窗口有限，所以整个知识库可能无法全部容纳其中。 </p>
<ul>
<li>你在提问中提供的信息越多，大语言模型处理并做出回应所需的时间就越长。 </li>
<li>你在提问中提供的信息越多，花费也就越多。 </li>
<li>提问中的无关信息可能会干扰大语言模型，增加产生幻觉（生成错误信息）的几率。</li>
</ul>
<p> 我们可以通过将知识库分割成更小、更易于理解的片段来解决这些问题。</p>
<h3 id="3-2、检索阶段"><a href="#3-2、检索阶段" class="headerlink" title="3.2、检索阶段"></a>3.2、检索阶段</h3><p>以下是检索阶段的简化图： </p>
<p>通过向量模型将用户查询转换成向量 &#x3D;&#x3D;&gt; 在向量数据库中根据用户查询进行相似度匹配 &#x3D;&#x3D;&gt; 将用户查询 和向量数据库中匹配到的相关内容一起交给LLM处理</p>
<p><img src="/2025/04/29/langchain4j/image-20250430144206726.png" alt="image-20250430144206726"></p>
<h2 id="4、文档加载器-Document-Loader"><a href="#4、文档加载器-Document-Loader" class="headerlink" title="4、文档加载器 Document Loader"></a>4、文档加载器 Document Loader</h2><h3 id="4-1、常见文档加载器"><a href="#4-1、常见文档加载器" class="headerlink" title="4.1、常见文档加载器"></a>4.1、常见文档加载器</h3><ol>
<li>·来自langchain4j模块的文件系统文档加载器(FileSystemDocumentLoader)</li>
<li>·来自langchain4j模块的类路径文档加载器(ClassPathDocumentLoader)</li>
<li>·来自langchain4j模块的网址文档加载器(UrlDocumentLoader)</li>
<li>·来自langchain4j-document–loader–amazon-s3模块的亚马逊S3文档加载器(AmazonS3DocumentLoader)</li>
<li>·来自langchain4j-document-loader–azure-storage-blob模块的Azure Blob存储文档加载器(AzureBlobStorageDocumentLoader)</li>
<li>·来自langchain4j-document-loader–github模块的GitHub文档加载器(GitHubDocumentLoader)</li>
<li>·来自langchain4j-document-loader-google-cloud–storage模块的谷歌云存储文档加载器(GoogleCloudStorageDocumentLoader)</li>
<li>·来自langchain4j-document-loader-selenium模块的Selenium文档加载器(SeleniumDocumentLoader)</li>
<li>·来自langchain4j-document-loader-tencent-cos模块的腾讯云对象存储文档加载器(TencentCosDocumentLoader)</li>
</ol>
<h3 id="4-2、测试文档加载"><a href="#4-2、测试文档加载" class="headerlink" title="4.2、测试文档加载"></a>4.2、测试文档加载</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.java.ai.langchain4j;</span><br><span class="line"> <span class="meta">@SpringBootTest</span></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RAGTest</span> &#123;</span><br><span class="line"> <span class="meta">@Test</span></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testReadDocument</span><span class="params">()</span> &#123;</span><br><span class="line">     <span class="comment">//使用FileSystemDocumentLoader读取指定目录下的知识库文档</span></span><br><span class="line">     <span class="comment">//并使用默认的文档解析器TextDocumentParser对文档进行解析</span></span><br><span class="line">     <span class="type">Document</span> <span class="variable">document</span> <span class="operator">=</span> FileSystemDocumentLoader.loadDocument(<span class="string">&quot;E:/knowledge/测试.txt&quot;</span>);</span><br><span class="line">     System.out.println(document.text());</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 加载单个文档</span></span><br><span class="line"><span class="type">Document</span> <span class="variable">document</span> <span class="operator">=</span> FileSystemDocumentLoader.loadDocument(<span class="string">&quot;E:/knowledge/file.txt&quot;</span>, <span class="keyword">new</span> <span class="title class_">TextDocumentParser</span>());</span><br><span class="line"></span><br><span class="line"><span class="comment">// 从一个目录中加载所有文档</span></span><br><span class="line">List&lt;Document&gt; documents = FileSystemDocumentLoader.loadDocuments(<span class="string">&quot;E:/knowledge&quot;</span>, <span class="keyword">new</span> <span class="title class_">TextDocumentParser</span>());</span><br><span class="line"></span><br><span class="line"><span class="comment">// 从一个目录中加载所有的.txt文档</span></span><br><span class="line"><span class="type">PathMatcher</span> <span class="variable">pathMatcher</span> <span class="operator">=</span> FileSystems.getDefault().getPathMatcher(<span class="string">&quot;glob:*.txt&quot;</span>);</span><br><span class="line">List&lt;Document&gt; documents = FileSystemDocumentLoader.loadDocuments(<span class="string">&quot;E:/knowledge&quot;</span>, pathMatcher, <span class="keyword">new</span> <span class="title class_">TextDocumentParser</span>());</span><br><span class="line"></span><br><span class="line"><span class="comment">// 从一个目录及其子目录中加载所有文档</span></span><br><span class="line">List&lt;Document&gt; documents = </span><br><span class="line">FileSystemDocumentLoader.loadDocumentsRecursively(<span class="string">&quot;E:/knowledge&quot;</span>, <span class="keyword">new</span> <span class="title class_">TextDocumentParser</span>());</span><br></pre></td></tr></table></figure>

<h2 id="5、文档解析器-Document-Parser"><a href="#5、文档解析器-Document-Parser" class="headerlink" title="5、文档解析器 Document Parser"></a>5、文档解析器 Document Parser</h2><p>很显然和上面加载器一起使用</p>
<h3 id="5-1、常见文档解析器"><a href="#5-1、常见文档解析器" class="headerlink" title="5.1、常见文档解析器"></a>5.1、常见文档解析器</h3><p>文档可以是各种格式的文件，比如PDF、DOC、TX灯等等。为了解析这些不同格式的文件，有一个“文档<br>解析器”(DocumentParser)接口，并且我们的库中包含了该接口的几种实现方式：</p>
<ul>
<li>来自langchain4j模块的文本文档解析器(TextDocumentParser),它能够解析纯文本格式的文件(例如TXT、HTML、MD等)</li>
<li>来自langchain4j-document–parser–apache-pdfbox模块的Apache PDFBox文档解析器(ApachePdfBoxDocumentParser),它可以解析PDF文件。</li>
<li>来自langchain4j-document-parser–apache-poi模块的Apache POI文档解析器(ApachePoiDocumentParser),它能够解析微软办公软件的文件格式（例如DOC、DOCX、PPT、PPTX、XLS、XLSX等)。</li>
<li>来自langchain4j-document-parser–apache-tika模块的Apache Tika文档解析器(ApacheTikaDocumentParser)，它可以自动检测并解析几乎所有现有的文件格式。</li>
</ul>
<p>假设如果我们想解析PDF文档，那么原有的 TextDocumentParser 就无法工作了，我们需要引入 langchain4j-document-parser-apache-pdfbox</p>
<h3 id="5-2、添加依赖"><a href="#5-2、添加依赖" class="headerlink" title="5.2、添加依赖"></a>5.2、添加依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--解析pdf文档--&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>dev.langchain4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>langchain4j-document-parser-apache-pdfbox<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="5-3、解析pdf文档"><a href="#5-3、解析pdf文档" class="headerlink" title="5.3、解析pdf文档"></a>5.3、解析pdf文档</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 解析PDF</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> <span class="meta">@Test</span></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testParsePDF</span><span class="params">()</span> &#123;</span><br><span class="line">     <span class="type">Document</span> <span class="variable">document</span> <span class="operator">=</span> FileSystemDocumentLoader.loadDocument(</span><br><span class="line">     	<span class="string">&quot;E:/knowledge/医院信息.pdf&quot;</span>,</span><br><span class="line">     	<span class="keyword">new</span> <span class="title class_">ApachePdfBoxDocumentParser</span>()</span><br><span class="line">     );</span><br><span class="line">     System.out.println(document);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<h2 id="6、文档分割器-Document-Splitter"><a href="#6、文档分割器-Document-Splitter" class="headerlink" title="6、文档分割器 Document Splitter"></a>6、文档分割器 Document Splitter</h2><h3 id="6-1、常见文档分割器"><a href="#6-1、常见文档分割器" class="headerlink" title="6.1、常见文档分割器"></a>6.1、常见文档分割器</h3><p>LangChain4j有一个“文档分割器”(DocumentSplitter)接口，并且提供了几种开箱即用的实现方式：</p>
<ul>
<li>按段落文档分割器(DocumentByParagraphSplitter)</li>
<li>按行文档分割器(DocumentByLineSplitter)</li>
<li>按句子文档分割器(DocumentBySentenceSplitter)</li>
<li>按单词文档分割器(DocumentByWordSplitter)</li>
<li>字符文档分割器(DocumenByChracterpli人</li>
<li>按正则表达式文档分割器(DocumentByRegexSplitter)</li>
<li>递归分割：DocumentSplitters.recursive()</li>
</ul>
<p>默认情况下每个文本片段最多不能超过300个token—默认可以修改</p>
<h3 id="6-2、测试向量转换和向量存储"><a href="#6-2、测试向量转换和向量存储" class="headerlink" title="6.2、测试向量转换和向量存储"></a>6.2、测试向量转换和向量存储</h3><p>Embedding (Vector) Stores 常见的意思是 “嵌入（向量）存储” 。在机器学习和自然语言处理领域， Embedding 指的是将数据（如文本、图像等）转换为低维稠密向量表示的过程，这些向量能够保留数据 的关键特征。而 Stores 表示存储，即用于存储这些嵌入向量的系统或工具。它们可以高效地存储和检索 向量数据，支持向量相似性搜索，在文本检索、推荐系统、图像识别等任务中发挥着重要作用。 </p>
<p>Langchain4j支持的向量存储：<a target="_blank" rel="noopener" href="https://docs.langchain4j.dev/integrations/embedding-stores">https://docs.langchain4j.dev/integrations/embedding-stores</a></p>
<p>添加依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--简单的rag实现--&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>dev.langchain4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>langchain4j-easy-rag<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>测试：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 加载文档并存入向量数据库</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"> <span class="meta">@Test</span></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testReadDocumentAndStore</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//使用FileSystemDocumentLoader读取指定目录下的知识库文档</span></span><br><span class="line">    <span class="comment">//并使用默认的文档解析器对文档进行解析(TextDocumentParser)</span></span><br><span class="line">     <span class="type">Document</span> <span class="variable">document</span> <span class="operator">=</span> FileSystemDocumentLoader.loadDocument(<span class="string">&quot;E:/knowledge/人工智能.md&quot;</span>);</span><br><span class="line">     </span><br><span class="line">    <span class="comment">//为了简单起见，我们暂时使用基于内存的向量存储</span></span><br><span class="line">    InMemoryEmbeddingStore&lt;TextSegment&gt; embeddingStore = <span class="keyword">new</span> <span class="title class_">InMemoryEmbeddingStore</span>&lt;&gt;();</span><br><span class="line">     </span><br><span class="line">    <span class="comment">//ingest</span></span><br><span class="line">    <span class="comment">//1、分割文档：默认使用递归分割器，将文档分割为多个文本片段，每个片段包含不超过 300个token，并且有 30个token的重叠部分保证连贯性</span></span><br><span class="line">    <span class="comment">//DocumentByParagraphSplitter(DocumentByLineSplitter(DocumentBySentenceSplitter(DocumentByWordSplitter)))</span></span><br><span class="line">    <span class="comment">//2、文本向量化：使用一个LangChain4j内置的轻量化向量模型对每个文本片段进行向量化</span></span><br><span class="line">    <span class="comment">//3、将原始文本和向量存储到向量数据库中(InMemoryEmbeddingStore)</span></span><br><span class="line">    EmbeddingStoreIngestor.ingest(document, embeddingStore);</span><br><span class="line">    <span class="comment">//查看向量数据库内容</span></span><br><span class="line">    System.out.println(embeddingStore);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<h3 id="6-3、测试文档分割"><a href="#6-3、测试文档分割" class="headerlink" title="6.3、测试文档分割"></a>6.3、测试文档分割</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 文档分割</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"> <span class="meta">@Test</span></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testDocumentSplitter</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//使用FileSystemDocumentLoader读取指定目录下的知识库文档</span></span><br><span class="line">    <span class="comment">//并使用默认的文档解析器对文档进行解析(TextDocumentParser)</span></span><br><span class="line">    <span class="type">Document</span> <span class="variable">document</span> <span class="operator">=</span> FileSystemDocumentLoader.loadDocument(<span class="string">&quot;E:/knowledge/人工智能.md&quot;</span>);</span><br><span class="line">    <span class="comment">//为了简单起见，我们暂时使用基于内存的向量存储</span></span><br><span class="line">    InMemoryEmbeddingStore&lt;TextSegment&gt; embeddingStore = <span class="keyword">new</span> <span class="title class_">InMemoryEmbeddingStore</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">//自定义文档分割器</span></span><br><span class="line">    <span class="comment">//按段落分割文档：每个片段包含不超过 300个token，并且有 30个token的重叠部分保证连贯性</span></span><br><span class="line">    <span class="comment">//注意：当段落长度总和小于设定的最大长度时，就不会有重叠的必要。</span></span><br><span class="line">    <span class="type">DocumentByParagraphSplitter</span> <span class="variable">documentSplitter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DocumentByParagraphSplitter</span>(</span><br><span class="line">    		<span class="number">300</span>,</span><br><span class="line">     		<span class="number">30</span>,</span><br><span class="line">     		<span class="comment">//token分词器：按token计算</span></span><br><span class="line">   			 <span class="keyword">new</span> <span class="title class_">HuggingFaceTokenizer</span>());</span><br><span class="line">    <span class="comment">//按字符计算</span></span><br><span class="line">    <span class="comment">//DocumentByParagraphSplitter documentSplitter = new </span></span><br><span class="line">    DocumentByParagraphSplitter(<span class="number">300</span>, <span class="number">30</span>);</span><br><span class="line">    EmbeddingStoreIngestor</span><br><span class="line">             .builder()</span><br><span class="line">             .embeddingStore(embeddingStore)</span><br><span class="line">             .documentSplitter(documentSplitter)</span><br><span class="line">             .build()</span><br><span class="line">             .ingest(document);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<h3 id="6-4、token和token计算"><a href="#6-4、token和token计算" class="headerlink" title="6.4、token和token计算"></a>6.4、token和token计算</h3><p>DeepSeek：Token 用量计算 | DeepSeek API Docs </p>
<p>阿里百炼：百炼控制台</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testTokenCount</span><span class="params">()</span> &#123;</span><br><span class="line">     <span class="type">String</span> <span class="variable">text</span> <span class="operator">=</span> <span class="string">&quot;这是一个示例文本，用于测试 token 长度的计算。&quot;</span>;</span><br><span class="line">     <span class="type">UserMessage</span> <span class="variable">userMessage</span> <span class="operator">=</span> UserMessage.userMessage(text);</span><br><span class="line">     <span class="comment">//计算 token 长度</span></span><br><span class="line">     <span class="comment">//QwenTokenizer tokenizer = new QwenTokenizer(System.getenv(&quot;DASH_SCOPE_API_KEY&quot;), &quot;qwen-max&quot;);</span></span><br><span class="line">     <span class="type">HuggingFaceTokenizer</span> <span class="variable">tokenizer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HuggingFaceTokenizer</span>();</span><br><span class="line">     <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> tokenizer.estimateTokenCountInMessage(userMessage);</span><br><span class="line">     System.out.println(<span class="string">&quot;token长度：&quot;</span> + count);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<h3 id="6-5、工作方式"><a href="#6-5、工作方式" class="headerlink" title="6.5、工作方式"></a>6.5、工作方式</h3><ol>
<li>实例化一个“文档分割器”(DocumentSplitter),指定所需的“文本片段”(TextSegment)大小，并且可以选择指定characters或token的重叠部分。</li>
<li>“文档分割器”(DocumentSplitter)将给定的文档(Document)分割成更小的单元，这些单元的性质因分割器而异。例如，“按段落分割文档器”(DocumentByParagraphSplitter)将文档分割成段落(由两个或更多连续的换行符定义)，而“按句子分割文档器”(DocumentBySentenceSplitter)使用OpenNLP库的句子检测器将文档分割成句子，依此类推。</li>
<li>然后，“文档分割器”(DocumentSplitter）将这些较小的单元（段落、句子、单词等）组合成“文本片段”(TextSegment),尝试在单个“文本片段”(TextSegment)中包含尽可能多的单元，同时不超过第一步中设置的限制。如果某些单元仍然太大，无法放入一个“文本片段”(TextSegment)中，它会调用一个子分割器。这是另个“文档分割器”(DocumentSplitter)，能够将不适合的单元分成更细粒度的单元。会向每个文本片段添加一个唯一的元数据条目“idex”。第一个“文本片段”(TextSegment)将包含index&#x3D;g,第二个是index&#x3D;:1,依此类推</li>
<li>模型上下文窗口可以通过模型参数列表查看：<a href="%5B%E7%99%BE%E7%82%BC%E6%8E%A7%E5%88%B6%E5%8F%B0%5D(https://bailian.console.aliyun.com/?tab=doc#/doc/?type=model&url=https://help.aliyun.com/document_detail/2840914.html)">阿里云百炼</a></li>
</ol>
<h1 id="八、向量模型和向量存储"><a href="#八、向量模型和向量存储" class="headerlink" title="八、向量模型和向量存储"></a>八、向量模型和向量存储</h1><h2 id="1、向量大模型"><a href="#1、向量大模型" class="headerlink" title="1、向量大模型"></a>1、向量大模型</h2><h3 id="1-1、介绍"><a href="#1-1、介绍" class="headerlink" title="1.1、介绍"></a>1.1、介绍</h3><p>通用文本向量模型：<a target="_blank" rel="noopener" href="https://help.aliyun.com/zh/model-studio/developer-reference/text-embedding-synchronous-api?spm=a2c4g.11186623.help-menu-2400256.d_2_5_0.592672a3yMJDRq&scm=20140722.H_2712515._.OR_help-T_cn~zh-V_1">https://help.aliyun.com/zh/model-studio/developer-reference/text-embedding-synchronous-api?spm=a2c4g.11186623.help-menu-2400256.d_2_5_0.592672a3yMJDRq&amp;scm=20140722.H_2712515._.OR_help-T_cn~zh-V_1</a> </p>
<p>text-embedding-v3： 阿里云百炼</p>
<p>使用通用文本向量 text-embedding-v3，维度1024，维度越多，对事务的描述越精准，信息检索的精度越高</p>
<h3 id="1-2、模型配置"><a href="#1-2、模型配置" class="headerlink" title="1.2、模型配置"></a>1.2、模型配置</h3><p>使用 text-embedding-v3 依然需要添加  langchain4j-community-dashscope 依赖 ，我们之前已经加过了 配置向量模型</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#集成阿里通义千问-通用文本向量-v3</span></span><br><span class="line"> <span class="string">langchain4j.community.dashscope.embedding-model.api-key=$&#123;DASH_SCOPE_API_KEY&#125;</span></span><br><span class="line"> <span class="string">langchain4j.community.dashscope.embedding-model.model-name=text-embedding-v3</span></span><br></pre></td></tr></table></figure>

<h3 id="1-3、文本向量化"><a href="#1-3、文本向量化" class="headerlink" title="1.3、文本向量化"></a>1.3、文本向量化</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.java.ai.langchain4j;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EmbeddingTest</span> &#123;</span><br><span class="line">     <span class="meta">@Autowired</span></span><br><span class="line">     <span class="keyword">private</span> EmbeddingModel embeddingModel;</span><br><span class="line">     <span class="meta">@Test</span></span><br><span class="line">     <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testEmbeddingModel</span><span class="params">()</span>&#123;</span><br><span class="line">         Response&lt;Embedding&gt; embed = embeddingModel.embed(<span class="string">&quot;你好&quot;</span>);</span><br><span class="line">         System.out.println(<span class="string">&quot;向量维度：&quot;</span> + embed.content().vector().length);</span><br><span class="line">         System.out.println(<span class="string">&quot;向量输出：&quot;</span> + embed.toString());</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2、向量存储"><a href="#2、向量存储" class="headerlink" title="2、向量存储"></a>2、向量存储</h2><h3 id="2-1、Pinecone简介"><a href="#2-1、Pinecone简介" class="headerlink" title="2.1、Pinecone简介"></a>2.1、Pinecone简介</h3><p>之前我们使用的是InMemoryEmbeddingStore作为向量存储，但是不建议在生产中使用基于内存的向量存 储。因此这里我们使用Pinecone作为向量数据库。 官方网站：The vector database to build knowledgeable AI | <a target="_blank" rel="noopener" href="https://www.pinecone.io/">Pinecone</a> </p>
<p>访问官方网站、注册、登录、获取apiKey且配置在环境变量中。默认有2GB的免费存储空间</p>
<h3 id="2-2、Pinecone的使用"><a href="#2-2、Pinecone的使用" class="headerlink" title="2.2、Pinecone的使用"></a>2.2、Pinecone的使用</h3><p>得分的含义<br>在向量检索场景中，当我们把查询文本转换为向量后，会在嵌入存储(EmbeddingStore)里查找与之最相以的向量（这些向量对应着文档片段等内容）。为了衡量查询向量和存储向量之间的相似程度，会使用某种相似度计算方法（例如余弦相似度等）来得出一个数值，这个数值就是得分。得分越高，表明查询向量和存储向量越相似，对应的文档片段与查询文本的相关性也就越高。<br>得分的作用</p>
<ul>
<li>筛选结果：通过设置minScore阈值，能够过滤掉那些与查询文本相关性较低的结果。在代码里，m1 nScore(g.8)意味着只有得分大于等于0.8的结果才会被返回，低于这个國值的结果会被舍弃。这样可以确保返回的结果是与查询文本高度相关的，提升检索结果的质量。</li>
<li>·控制召回率和准确率：调整m1 nScore的值可以在召回率和准确率之间进行权衡。如果把阈值设置得较低，那么更多的结果会被返回，召回率会提高，但可能会包含一些相关性不太强的结果，导致准确率下降；反之，如果把阈值设置得较高，返回的结果数量会减少，准确率会提高，但可能会遗漏一些相关的结果，使得召回率降低。在实际应用中，需要根据具体的业务需求来合理设置minScore的值。</li>
</ul>
<p>示例说明<br>假设我们有一个关于水果的文档集合，嵌入存储中存储了这些文档片段的向量。当我们使用“苹果的营养价值”作为查询文本时，向量检索会计算查询向量与存储向量的相似度得分。如果m1 Score设置为0.8,那么只有那些与“苹果的营养价值”相关性非常高的文档片段才会被返回，而一些只简单提及苹果但没有详细讨论其营养价值的文档片段可能由于得分低于0.8而不会被返回。</p>
<h3 id="2-3、集成Pinecone"><a href="#2-3、集成Pinecone" class="headerlink" title="2.3、集成Pinecone"></a>2.3、集成Pinecone</h3><p><a target="_blank" rel="noopener" href="https://docs.langchain4j.dev/integrations/embedding-stores/pinecone/">参考文档</a></p>
<p>添加依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>dev.langchain4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>langchain4j-pinecone<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="2-4、配置向量存储对象"><a href="#2-4、配置向量存储对象" class="headerlink" title="2.4、配置向量存储对象"></a>2.4、配置向量存储对象</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.java.ai.langchain4j.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.data.segment.TextSegment;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.model.embedding.EmbeddingModel;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.store.embedding.EmbeddingStore;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.store.embedding.pinecone.PineconeEmbeddingStore;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.store.embedding.pinecone.PineconeServerlessIndexConfig;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EmbeddingStoreConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> EmbeddingModel embeddingModel;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> EmbeddingStore&lt;TextSegment&gt; <span class="title function_">embeddingStore</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//创建向量存储</span></span><br><span class="line">        EmbeddingStore&lt;TextSegment&gt; embeddingStore = PineconeEmbeddingStore.builder()</span><br><span class="line">                .apiKey(System.getenv(<span class="string">&quot;PINECONE_API_KEY&quot;</span>))<span class="comment">//需要去搞一个api才行</span></span><br><span class="line">                .index(<span class="string">&quot;xiaozhi-index&quot;</span>)<span class="comment">//如果指定的索引不存在，将创建一个新的索引</span></span><br><span class="line">                .nameSpace(<span class="string">&quot;xiaozhi-namespace&quot;</span>) <span class="comment">//如果指定的名称空间不存在，将创建一个新的名称 空间</span></span><br><span class="line">                .createIndex(PineconeServerlessIndexConfig.builder()</span><br><span class="line">                                .cloud(<span class="string">&quot;AWS&quot;</span>) <span class="comment">//指定索引部署在 AWS 云服务上。</span></span><br><span class="line">                                .region(<span class="string">&quot;us-east-1&quot;</span>) <span class="comment">//指定索引所在的 AWS 区域为 us-east-1。</span></span><br><span class="line">                                .dimension(embeddingModel.dimension()) <span class="comment">//指定索引的向量维度，该维度与 embeddedModel 生成的向量维度相同。</span></span><br><span class="line">                                .build())</span><br><span class="line">                .build();</span><br><span class="line">        <span class="keyword">return</span> embeddingStore;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="2-5、测试向量存储"><a href="#2-5、测试向量存储" class="headerlink" title="2.5、测试向量存储"></a>2.5、测试向量存储</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> EmbeddingStore embeddingStore;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 将文本转换成向量，然后存储到pinecone中</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* 参考：</span></span><br><span class="line"><span class="comment">* https://docs.langchain4j.dev/tutorials/embedding-stores</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testPineconeEmbeded</span><span class="params">()</span> &#123;</span><br><span class="line">   <span class="comment">//将文本转换成向量</span></span><br><span class="line">   <span class="type">TextSegment</span> <span class="variable">segment1</span> <span class="operator">=</span> TextSegment.from(<span class="string">&quot;我喜欢羽毛球&quot;</span>);</span><br><span class="line">   <span class="type">Embedding</span> <span class="variable">embedding1</span> <span class="operator">=</span> embeddingModel.embed(segment1).content();</span><br><span class="line">   <span class="comment">//存入向量数据库</span></span><br><span class="line">   embeddingStore.add(embedding1, segment1);</span><br><span class="line">   <span class="type">TextSegment</span> <span class="variable">segment2</span> <span class="operator">=</span> TextSegment.from(<span class="string">&quot;今天天气很好&quot;</span>);</span><br><span class="line">   <span class="type">Embedding</span> <span class="variable">embedding2</span> <span class="operator">=</span> embeddingModel.embed(segment2).content();</span><br><span class="line">   embeddingStore.add(embedding2, segment2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3、相似度匹配"><a href="#3、相似度匹配" class="headerlink" title="3、相似度匹配"></a>3、相似度匹配</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Pinecone-相似度匹配</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> <span class="meta">@Test</span></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">embeddingSearch</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//提问，并将问题转成向量数据</span></span><br><span class="line">    <span class="type">Embedding</span> <span class="variable">queryEmbedding</span> <span class="operator">=</span> embeddingModel.embed(<span class="string">&quot;你最喜欢的运动是什么？&quot;</span>).content();</span><br><span class="line">    <span class="comment">//创建搜索请求对象</span></span><br><span class="line">    <span class="type">EmbeddingSearchRequest</span> <span class="variable">searchRequest</span> <span class="operator">=</span> EmbeddingSearchRequest.builder()</span><br><span class="line">            .queryEmbedding(queryEmbedding)</span><br><span class="line">            .maxResults(<span class="number">1</span>) <span class="comment">//匹配最相似的一条记录</span></span><br><span class="line">            <span class="comment">//.minScore(0.8)</span></span><br><span class="line">            .build();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//根据搜索请求 searchRequest 在向量存储中进行相似度搜索</span></span><br><span class="line">    EmbeddingSearchResult&lt;TextSegment&gt; searchResult = </span><br><span class="line">    embeddingStore.search(searchRequest);</span><br><span class="line">     <span class="comment">//searchResult.matches()：获取搜索结果中的匹配项列表。</span></span><br><span class="line">    <span class="comment">//.get(0)：从匹配项列表中获取第一个匹配项</span></span><br><span class="line">    EmbeddingMatch&lt;TextSegment&gt; embeddingMatch = searchResult.matches().get(<span class="number">0</span>);</span><br><span class="line">     <span class="comment">//获取匹配项的相似度得分</span></span><br><span class="line">    System.out.println(embeddingMatch.score()); <span class="comment">// 0.8144288515898701</span></span><br><span class="line">     <span class="comment">//返回文本结果</span></span><br><span class="line">    System.out.println(embeddingMatch.embedded().text());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="六、项目实战-创建硅谷小智"><a href="#六、项目实战-创建硅谷小智" class="headerlink" title="六、项目实战-创建硅谷小智"></a>六、项目实战-创建硅谷小智</h1><p>这部分我们实现硅谷小智的基本聊天功能，包含聊天记忆、聊天记忆持久化、提示词</p>
<h2 id="1、创建硅谷小智"><a href="#1、创建硅谷小智" class="headerlink" title="1、创建硅谷小智"></a>1、创建硅谷小智</h2><p>创建XiaoZhi接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.java.ai.langchain4j.assistant;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.service.MemoryId;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.service.SystemMessage;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.service.UserMessage;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.service.spring.AiService;</span><br><span class="line"><span class="keyword">import</span> reactor.core.publisher.Flux;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> dev.langchain4j.service.spring.AiServiceWiringMode.EXPLICIT;</span><br><span class="line"></span><br><span class="line"><span class="meta">@AiService(</span></span><br><span class="line"><span class="meta">        wiringMode = EXPLICIT,</span></span><br><span class="line"><span class="meta">        chatModel = &quot;qwenChatModel&quot;,//声明大语言模型</span></span><br><span class="line"><span class="meta">        chatMemoryProvider = &quot;chatMemoryProviderXiaozhi&quot;,//聊天记忆,</span></span><br><span class="line"><span class="meta">        tools = &quot;appointmentTools&quot;,</span></span><br><span class="line"><span class="meta">        contentRetriever = &quot;contentRetrieverXiaozhi&quot;,</span></span><br><span class="line"><span class="meta">        streamingChatModel = &quot;qwenStreamingChatModel&quot;</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">XiaozhiAgent</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//提示词模板</span></span><br><span class="line">    <span class="meta">@SystemMessage(fromResource = &quot;zhaozhi-prompt-template.txt&quot;)</span></span><br><span class="line">    <span class="comment">//Flux&lt;String&gt;是后文提及的流式显示</span></span><br><span class="line">    Flux&lt;String&gt; <span class="title function_">chat</span><span class="params">(<span class="meta">@MemoryId</span> Long memoryId, <span class="meta">@UserMessage</span> String message)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="2、提示词模板"><a href="#2、提示词模板" class="headerlink" title="2、提示词模板"></a>2、提示词模板</h2><p>haozhi-prompt-template.txt</p>
<p>在这就可以为你的人工智能定义了</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">你的名字是“硅谷小智”，你是一家名为“北京协和医院”的智能客服。</span><br><span class="line">你是一个训练有素的医疗顾问和医疗伴诊助手。</span><br><span class="line">你态度友好、礼貌且言辞简洁。</span><br><span class="line">1、请仅在用户发起第一次会话时，和用户打个招呼，并介绍你是谁。</span><br><span class="line">2、作为一个训练有素的医疗顾问：</span><br><span class="line">请基于当前临床实践和研究，针对患者提出的特定健康问题，提供详细、准确且实用的医疗建议。请同时考虑可能的病</span><br><span class="line">因、诊断流程、治疗方案以及预防措施，并给出在不同情境下的应对策略。对于药物治疗，请特别指明适用的药品名</span><br><span class="line">称、剂量和疗程。如果需要进一步的检查或就医，也请明确指示。</span><br><span class="line">3、作为医疗伴诊助手，你可以回答用户就医流程中的相关问题，主要包含以下功能：</span><br><span class="line">AI分导诊：根据患者的病情和就医需求，智能推荐最合适的科室。</span><br><span class="line">AI挂号助手：实现智能查询是否有挂号号源服务；实现智能预约挂号服务；实现智能取消挂号服务。</span><br><span class="line">4、你必须遵守的规则如下：</span><br><span class="line">在获取挂号预约详情或取消挂号预约之前，你必须确保自己知晓用户的姓名（必选）、身份证号（必选）、预约科室</span><br><span class="line">（必选）、预约日期（必选，格式举例：2025-04-14）、预约时间（必选，格式：上午 或 下午）、预约医生（可</span><br><span class="line">选）。</span><br><span class="line">当被问到其他领域的咨询时，要表示歉意并说明你无法在这方面提供帮助。</span><br><span class="line">5、请在回答的结果中适当包含一些轻松可爱的图标和表情。</span><br><span class="line">6、今天是 &#123;&#123;current_date&#125;&#125;。</span><br></pre></td></tr></table></figure>

<h2 id="3、配置小智助手"><a href="#3、配置小智助手" class="headerlink" title="3、配置小智助手"></a>3、配置小智助手</h2><p>配置持久化和记忆隔离</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.java.ai.langchain4j.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.atguigu.java.ai.langchain4j.store.MongoChatMemoryStore;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.data.document.Document;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.data.document.loader.FileSystemDocumentLoader;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.data.segment.TextSegment;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.memory.chat.ChatMemoryProvider;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.memory.chat.MessageWindowChatMemory;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.rag.content.retriever.ContentRetriever;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.rag.content.retriever.EmbeddingStoreContentRetriever;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.store.embedding.EmbeddingStoreIngestor;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.store.embedding.inmemory.InMemoryEmbeddingStore;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">XiaozhiAgentConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MongoChatMemoryStore mongoChatMemoryStore;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    ChatMemoryProvider <span class="title function_">chatMemoryProviderXiaozhi</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> memoryId -&gt; MessageWindowChatMemory</span><br><span class="line">                .builder()</span><br><span class="line">                .id(memoryId)</span><br><span class="line">                .maxMessages(<span class="number">20</span>)</span><br><span class="line">                .chatMemoryStore(mongoChatMemoryStore)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    ContentRetriever <span class="title function_">contentRetrieverXiaozhi</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//使用FileSystemDocumentLoader读取指定目录下的知识库文档</span></span><br><span class="line">        <span class="comment">//并使用默认的文档解析器对文档进行解析</span></span><br><span class="line">        <span class="type">Document</span> <span class="variable">document1</span> <span class="operator">=</span> FileSystemDocumentLoader.loadDocument(<span class="string">&quot;D:/BaiduNetdiskDownload/硅谷小智（医疗版）/资料/knowledge/knowledge/口腔科.md&quot;</span>);</span><br><span class="line">        <span class="type">Document</span> <span class="variable">document2</span> <span class="operator">=</span> FileSystemDocumentLoader.loadDocument(<span class="string">&quot;D:/BaiduNetdiskDownload/硅谷小智（医疗版）/资料/knowledge/knowledge/科室信息.md&quot;</span>);</span><br><span class="line">        <span class="type">Document</span> <span class="variable">document3</span> <span class="operator">=</span> FileSystemDocumentLoader.loadDocument(<span class="string">&quot;D:/BaiduNetdiskDownload/硅谷小智（医疗版）/资料/knowledge/knowledge/神经内科.md&quot;</span>);</span><br><span class="line">        List&lt;Document&gt; documents = Arrays.asList(document1, document2, document3);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//使用内存向量存储</span></span><br><span class="line">        InMemoryEmbeddingStore&lt;TextSegment&gt; embeddingStore = <span class="keyword">new</span> <span class="title class_">InMemoryEmbeddingStore</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">//使用默认的文档分割器</span></span><br><span class="line">        EmbeddingStoreIngestor.ingest(documents, embeddingStore);</span><br><span class="line">        <span class="comment">//从嵌入存储（EmbeddingStore）里检索和查询内容相关的信息</span></span><br><span class="line">        <span class="keyword">return</span> EmbeddingStoreContentRetriever.from(embeddingStore);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="4、封装对话对象"><a href="#4、封装对话对象" class="headerlink" title="4、封装对话对象"></a>4、封装对话对象</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.java.ai.langchain4j.bean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ChatForm</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Long memoryId;<span class="comment">//对话id</span></span><br><span class="line">    <span class="keyword">private</span> String message;<span class="comment">//用户问题</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="5、添加Controller方法"><a href="#5、添加Controller方法" class="headerlink" title="5、添加Controller方法"></a>5、添加Controller方法</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.java.ai.langchain4j.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.atguigu.java.ai.langchain4j.assistant.XiaozhiAgent;</span><br><span class="line"><span class="keyword">import</span> com.atguigu.java.ai.langchain4j.bean.ChatForm;</span><br><span class="line"><span class="keyword">import</span> io.swagger.v3.oas.annotations.Operation;</span><br><span class="line"><span class="keyword">import</span> io.swagger.v3.oas.annotations.tags.Tag;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"><span class="keyword">import</span> reactor.core.publisher.Flux;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Tag(name = &quot;硅谷小智&quot;)</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/xiaozhi&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">XiaozhiController</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> XiaozhiAgent xiaozhiAgent;</span><br><span class="line">    <span class="meta">@Operation(summary = &quot;对话&quot;)</span></span><br><span class="line">    <span class="meta">@PostMapping(value = &quot;/chat&quot;, produces = &quot;text/event-stream;charset=utf-8&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Flux&lt;String&gt; <span class="title function_">chat</span><span class="params">(<span class="meta">@RequestBody</span> ChatForm chatForm)</span>  &#123;</span><br><span class="line">        <span class="keyword">return</span> xiaozhiAgent.chat(chatForm.getMemoryId(), chatForm.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="6、预约业务的实现"><a href="#6、预约业务的实现" class="headerlink" title="6、预约业务的实现"></a>6、预约业务的实现</h2><p>这部分我们实现硅谷小智的查询订单、预约订单、取消订单的功能 </p>
<h3 id="6-1、创建MySQL数据库表"><a href="#6-1、创建MySQL数据库表" class="headerlink" title="6.1、创建MySQL数据库表"></a>6.1、创建MySQL数据库表</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">CREATE DATABASE `guiguxiaozhi`;</span><br><span class="line"> USE `guiguxiaozhi`;</span><br><span class="line"> CREATE TABLE `appointment` (</span><br><span class="line">     `id` BIGINT NOT NULL AUTO_INCREMENT,</span><br><span class="line">     `username` VARCHAR(50) NOT NULL,</span><br><span class="line">     `id_card` VARCHAR(18) NOT NULL,</span><br><span class="line">     `department` VARCHAR(50) NOT NULL,</span><br><span class="line">     `date` VARCHAR(10) NOT NULL,</span><br><span class="line">     `time` VARCHAR(10) NOT NULL,</span><br><span class="line">     `doctor_name` VARCHAR(50) DEFAULT NULL,</span><br><span class="line">     PRIMARY KEY (`id`)</span><br><span class="line"> );</span><br></pre></td></tr></table></figure>

<h3 id="6-2、引入依赖"><a href="#6-2、引入依赖" class="headerlink" title="6.2、引入依赖"></a>6.2、引入依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- Mysql Connector --&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"> <span class="comment">&lt;!--mybatis-plus 持久层--&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus-spring-boot3-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;mybatis-plus.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="6-3、配置数据库连接"><a href="#6-3、配置数据库连接" class="headerlink" title="6.3、配置数据库连接"></a>6.3、配置数据库连接</h3><p>application.properties</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 基本数据源配置</span></span><br><span class="line"> <span class="string">spring.datasource.url=jdbc:mysql://localhost:3306/guiguxiaozhi?</span></span><br><span class="line"> <span class="string">useUnicode=true&amp;characterEncoding=UTF-8&amp;serverTimezone=Asia/Shanghai&amp;useSSL=false</span></span><br><span class="line"> <span class="string">spring.datasource.username=root</span></span><br><span class="line"> <span class="string">spring.datasource.password=123456</span></span><br><span class="line"> <span class="string">spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver</span></span><br><span class="line"> <span class="comment"># 开启 SQL 日志打印</span></span><br><span class="line"> <span class="string">mybatis-plus.configuration.log-impl=org.apache.ibatis.logging.stdout.StdOutImpl</span></span><br></pre></td></tr></table></figure>

<h3 id="6-4、创建实体类"><a href="#6-4、创建实体类" class="headerlink" title="6.4、创建实体类"></a>6.4、创建实体类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.java.ai.langchain4j.entity;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.annotation.IdType;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.annotation.TableId;</span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Appointment</span> &#123;</span><br><span class="line">    <span class="meta">@TableId(type = IdType.AUTO)</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String idCard;</span><br><span class="line">    <span class="keyword">private</span> String department;</span><br><span class="line">    <span class="keyword">private</span> String date;</span><br><span class="line">    <span class="keyword">private</span> String time;</span><br><span class="line">    <span class="keyword">private</span> String doctorName;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="6-5、Mapper"><a href="#6-5、Mapper" class="headerlink" title="6.5、Mapper"></a>6.5、Mapper</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.java.ai.langchain4j.mapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.atguigu.java.ai.langchain4j.entity.Appointment;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.core.mapper.BaseMapper;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Mapper;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">AppointmentMapper</span> <span class="keyword">extends</span> <span class="title class_">BaseMapper</span>&lt;Appointment&gt; &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> xml：在resources下创建mapper目录，创建AppointmentMapper.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"> <span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span> <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span> </span></span><br><span class="line"><span class="meta"><span class="string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;com.atguigu.java.ai.langchain4j.mapper.AppointmentMapper&quot;</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="6-6、Service"><a href="#6-6、Service" class="headerlink" title="6.6、Service"></a>6.6、Service</h3><p>接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.java.ai.langchain4j.service;</span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">AppointmentService</span> <span class="keyword">extends</span> <span class="title class_">IService</span>&lt;Appointment&gt; &#123;</span><br><span class="line"> 	Appointment <span class="title function_">getOne</span><span class="params">(Appointment appointment)</span>;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>实现类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.java.ai.langchain4j.service.serviceImpl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.atguigu.java.ai.langchain4j.entity.Appointment;</span><br><span class="line"><span class="keyword">import</span> com.atguigu.java.ai.langchain4j.mapper.AppointmentMapper;</span><br><span class="line"><span class="keyword">import</span> com.atguigu.java.ai.langchain4j.service.AppiontmentService;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AppiontmentServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;AppointmentMapper, Appointment&gt; <span class="keyword">implements</span> <span class="title class_">AppiontmentService</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询订单是否存在</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> appointment</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Appointment <span class="title function_">getOne</span><span class="params">(Appointment appointment)</span> &#123;</span><br><span class="line">        LambdaQueryWrapper&lt;Appointment&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();</span><br><span class="line">        queryWrapper.eq(Appointment::getUsername, appointment.getUsername());</span><br><span class="line">        queryWrapper.eq(Appointment::getIdCard, appointment.getIdCard());</span><br><span class="line">        queryWrapper.eq(Appointment::getDepartment, appointment.getDepartment());</span><br><span class="line">        queryWrapper.eq(Appointment::getDate, appointment.getDate());</span><br><span class="line">        queryWrapper.eq(Appointment::getTime, appointment.getTime());</span><br><span class="line">        <span class="type">Appointment</span> <span class="variable">appointmentDB</span> <span class="operator">=</span> baseMapper.selectOne(queryWrapper);</span><br><span class="line">        <span class="keyword">return</span> appointmentDB;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="6-7、测式"><a href="#6-7、测式" class="headerlink" title="6.7、测式"></a>6.7、测式</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.java.ai.langchain4j.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.atguigu.java.ai.langchain4j.entity.Appointment;</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AppointmentServiceTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AppiontmentService appointmentService;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testGetOne</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Appointment</span> <span class="variable">appointment</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Appointment</span>();</span><br><span class="line">        appointment.setUsername(<span class="string">&quot;张三&quot;</span>);</span><br><span class="line">        appointment.setIdCard(<span class="string">&quot;123456789012345678&quot;</span>);</span><br><span class="line">        appointment.setDepartment(<span class="string">&quot;内科&quot;</span>);</span><br><span class="line">        appointment.setDate(<span class="string">&quot;2025-04-14&quot;</span>);</span><br><span class="line">        appointment.setTime(<span class="string">&quot;上午&quot;</span>);</span><br><span class="line">        <span class="type">Appointment</span> <span class="variable">appointmentDB</span> <span class="operator">=</span> appointmentService.getOne(appointment);</span><br><span class="line">        System.out.println(appointmentDB);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testSave</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Appointment</span> <span class="variable">appointment</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Appointment</span>();</span><br><span class="line">        appointment.setUsername(<span class="string">&quot;张三&quot;</span>);</span><br><span class="line">        appointment.setIdCard(<span class="string">&quot;123456789012345678&quot;</span>);</span><br><span class="line">        appointment.setDepartment(<span class="string">&quot;内科&quot;</span>);</span><br><span class="line">        appointment.setDate(<span class="string">&quot;2025-04-14&quot;</span>);</span><br><span class="line">        appointment.setTime(<span class="string">&quot;上午&quot;</span>);</span><br><span class="line">        appointment.setDoctorName(<span class="string">&quot;张医生&quot;</span>);</span><br><span class="line">        appointmentService.save(appointment);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testRemoveById</span><span class="params">()</span> &#123;</span><br><span class="line">        appointmentService.removeById(<span class="number">1L</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="7、Tools"><a href="#7、Tools" class="headerlink" title="7、Tools"></a>7、Tools</h2><h3 id="7-1、创建Tools"><a href="#7-1、创建Tools" class="headerlink" title="7.1、创建Tools"></a>7.1、创建Tools</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.java.ai.langchain4j.tools;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.atguigu.java.ai.langchain4j.entity.Appointment;</span><br><span class="line"><span class="keyword">import</span> com.atguigu.java.ai.langchain4j.service.AppiontmentService;</span><br><span class="line"><span class="keyword">import</span> com.atguigu.java.ai.langchain4j.service.serviceImpl.AppiontmentServiceImpl;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.agent.tool.P;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.agent.tool.Tool;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AppointmentTools</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AppiontmentService appiontmentService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Tool(name=&quot;预约挂号&quot;, value = &quot;根据参数，先执行工具方法queryDepartment查询是否可预约，并直接给用户回答是否可预约，并让用户确认所有预约信息，用户确认后再进行预约。如果用户没有提供具体的医生姓名，请从向量存储中找到一位医生。&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">bookAppointment</span><span class="params">(Appointment appointment)</span> &#123;</span><br><span class="line">        <span class="comment">//查找是否有预约信息</span></span><br><span class="line">        <span class="type">Appointment</span> <span class="variable">appointmentDB</span> <span class="operator">=</span> appiontmentService.getOne(appointment);</span><br><span class="line">        <span class="keyword">if</span>(appointmentDB == <span class="literal">null</span>)&#123;</span><br><span class="line">            appointment.setId(<span class="literal">null</span>);<span class="comment">//防止大模型幻觉设置了id</span></span><br><span class="line">            <span class="keyword">if</span>(appiontmentService.save(appointment))&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;预约成功，并返回预约详情&quot;</span>;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;预约失败&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;您在相同的科室和时间已有预约&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Tool(name=&quot;取消预约挂号&quot;, value = &quot;根据参数，查询预约是否存在，如果存在则删除预约记录并返回取 消预约成功，否则返回取消预约失败&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">cancelAppointment</span><span class="params">(Appointment appointment)</span> &#123;</span><br><span class="line">        <span class="type">Appointment</span> <span class="variable">appointmentDB</span> <span class="operator">=</span> appiontmentService.getOne(appointment);</span><br><span class="line">        <span class="keyword">if</span>(appointmentDB != <span class="literal">null</span>)&#123;</span><br><span class="line">            appiontmentService.removeById(appointmentDB.getId());</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;取消预约成功&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;取消预约失败&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Tool(name = &quot;查询是否有号源&quot;, value=&quot;根据科室名称，日期，时间和医生查询是否有号源，并返回给用 户&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">queryDepartment</span><span class="params">(</span></span><br><span class="line"><span class="params">            <span class="meta">@P(value = &quot;科室名称&quot;)</span> String name,</span></span><br><span class="line"><span class="params">            <span class="meta">@P(value = &quot;日期&quot;)</span> String date,</span></span><br><span class="line"><span class="params">            <span class="meta">@P(value = &quot;时间，可选值：上午、下午&quot;)</span> String time,</span></span><br><span class="line"><span class="params">            //required=<span class="literal">false</span>表示该参数不是必须的，如果用户没有输入该参数，则默认为<span class="literal">null</span></span></span><br><span class="line"><span class="params">            <span class="meta">@P(value = &quot;医生名称&quot;, required = false)</span> String doctorName</span></span><br><span class="line"><span class="params">    )</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;查询是否有号源&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;科室名称：&quot;</span> + name);</span><br><span class="line">        System.out.println(<span class="string">&quot;日期：&quot;</span> + date);</span><br><span class="line">        System.out.println(<span class="string">&quot;时间：&quot;</span> + time);</span><br><span class="line">        System.out.println(<span class="string">&quot;医生名称：&quot;</span> + doctorName);</span><br><span class="line">        <span class="comment">//TODO 维护医生的排班信息：</span></span><br><span class="line">        <span class="comment">//如果没有指定医生名字，则根据其他条件查询是否有可以预约的医生（有返回true，否则返回false</span></span><br><span class="line">        <span class="comment">//如果指定了医生名字，则判断医生是否有排班（没有排版返回false）</span></span><br><span class="line">        <span class="comment">//如果有排班，则判断医生排班时间段是否已约满（约满返回false，有空闲时间返回true）</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="7-2、配置Tools"><a href="#7-2、配置Tools" class="headerlink" title="7.2、配置Tools"></a>7.2、配置Tools</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@AiService(</span></span><br><span class="line"><span class="meta">        wiringMode = EXPLICIT,</span></span><br><span class="line"><span class="meta">        chatModel = &quot;qwenChatModel&quot;,</span></span><br><span class="line"><span class="meta">        chatMemoryProvider = &quot;chatMemoryProviderXiaozhi&quot;,</span></span><br><span class="line"><span class="meta">        tools = &quot;appointmentTools&quot; //tools配置</span></span><br><span class="line"><span class="meta">)</span></span><br></pre></td></tr></table></figure>

<h2 id="8、RAG"><a href="#8、RAG" class="headerlink" title="8、RAG"></a>8、RAG</h2><h3 id="8-1、创建-Bean对象"><a href="#8-1、创建-Bean对象" class="headerlink" title="8.1、创建@Bean对象"></a>8.1、创建@Bean对象</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line">    ContentRetriever <span class="title function_">contentRetrieverXiaozhi</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//使用FileSystemDocumentLoader读取指定目录下的知识库文档</span></span><br><span class="line">        <span class="comment">//并使用默认的文档解析器对文档进行解析</span></span><br><span class="line">        <span class="type">Document</span> <span class="variable">document1</span> <span class="operator">=</span> FileSystemDocumentLoader.loadDocument(<span class="string">&quot;D:/BaiduNetdiskDownload/硅谷小智（医疗版）/资料/knowledge/knowledge/口腔科.md&quot;</span>);</span><br><span class="line">        <span class="type">Document</span> <span class="variable">document2</span> <span class="operator">=</span> FileSystemDocumentLoader.loadDocument(<span class="string">&quot;D:/BaiduNetdiskDownload/硅谷小智（医疗版）/资料/knowledge/knowledge/科室信息.md&quot;</span>);</span><br><span class="line">        <span class="type">Document</span> <span class="variable">document3</span> <span class="operator">=</span> FileSystemDocumentLoader.loadDocument(<span class="string">&quot;D:/BaiduNetdiskDownload/硅谷小智（医疗版）/资料/knowledge/knowledge/神经内科.md&quot;</span>);</span><br><span class="line">        List&lt;Document&gt; documents = Arrays.asList(document1, document2, document3);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//使用内存向量存储</span></span><br><span class="line">        InMemoryEmbeddingStore&lt;TextSegment&gt; embeddingStore = <span class="keyword">new</span> <span class="title class_">InMemoryEmbeddingStore</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">//使用默认的文档分割器</span></span><br><span class="line">        EmbeddingStoreIngestor.ingest(documents, embeddingStore);</span><br><span class="line">        <span class="comment">//从嵌入存储（EmbeddingStore）里检索和查询内容相关的信息</span></span><br><span class="line">        <span class="keyword">return</span> EmbeddingStoreContentRetriever.from(embeddingStore);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="8-2、添加配置"><a href="#8-2、添加配置" class="headerlink" title="8.2、添加配置"></a>8.2、添加配置</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">contentRetriever = <span class="string">&quot;contentRetrieverXiaozhi&quot;</span> <span class="comment">//配置向量存储</span></span><br></pre></td></tr></table></figure>

<h3 id="8-3、修改工具的value提示"><a href="#8-3、修改工具的value提示" class="headerlink" title="8.3、修改工具的value提示"></a>8.3、修改工具的value提示</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Tool(name=&quot;预约挂号&quot;, value = &quot;根据参数，先执行工具方法queryDepartment查询是否可预约，并直接给用户回答是否可预约，并让用户确认所有预约信息，用户确认后再进行预约。如果用户没有提供具体的医生姓名，请从向量存储中找到一位医生。&quot;)</span></span><br></pre></td></tr></table></figure>

<h2 id="9、整合向量数据库"><a href="#9、整合向量数据库" class="headerlink" title="9、整合向量数据库"></a>9、整合向量数据库</h2><h3 id="9-1、上传知识库到Pinecone"><a href="#9-1、上传知识库到Pinecone" class="headerlink" title="9.1、上传知识库到Pinecone"></a>9.1、上传知识库到Pinecone</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testUploadKnowledgeLibrary</span><span class="params">()</span> &#123;</span><br><span class="line">     <span class="comment">//使用FileSystemDocumentLoader读取指定目录下的知识库文档</span></span><br><span class="line">    <span class="comment">//并使用默认的文档解析器对文档进行解析</span></span><br><span class="line">    <span class="type">Document</span> <span class="variable">document1</span> <span class="operator">=</span> FileSystemDocumentLoader.loadDocument(<span class="string">&quot;E:/knowledge/医院信息.md&quot;</span>);</span><br><span class="line">     <span class="type">Document</span> <span class="variable">document2</span> <span class="operator">=</span> FileSystemDocumentLoader.loadDocument(<span class="string">&quot;E:/knowledge/科室信息.md&quot;</span>);</span><br><span class="line">     <span class="type">Document</span> <span class="variable">document3</span> <span class="operator">=</span> FileSystemDocumentLoader.loadDocument(<span class="string">&quot;E:/knowledge/神经内科.md&quot;</span>);</span><br><span class="line">     List&lt;Document&gt; documents = Arrays.asList(document1, document2, document3);</span><br><span class="line"></span><br><span class="line">     <span class="comment">//文本向量化并存入向量数据库：将每个片段进行向量化，得到一个嵌入向量</span></span><br><span class="line">    EmbeddingStoreIngestor</span><br><span class="line">     .builder()</span><br><span class="line">     .embeddingStore(embeddingStore)</span><br><span class="line">     .embeddingModel(embeddingModel)</span><br><span class="line">     .build()</span><br><span class="line">     .ingest(documents)</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<h3 id="9-2、修改XiaozhiAgentConfig"><a href="#9-2、修改XiaozhiAgentConfig" class="headerlink" title="9.2、修改XiaozhiAgentConfig"></a>9.2、修改XiaozhiAgentConfig</h3><p>添加基于Pinecone的向量数据库配置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"> <span class="keyword">private</span> EmbeddingStore embeddingStore;</span><br><span class="line"> <span class="meta">@Autowired</span></span><br><span class="line"> <span class="keyword">private</span> EmbeddingModel embeddingModel;</span><br><span class="line">修改contentRetriever的配置为contentRetrieverXiaozhiPincone </span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"> ContentRetriever <span class="title function_">contentRetrieverXiaozhiPincone</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 创建一个 EmbeddingStoreContentRetriever 对象，用于从嵌入存储中检索内容</span></span><br><span class="line">    <span class="keyword">return</span> EmbeddingStoreContentRetriever</span><br><span class="line">            .builder()</span><br><span class="line">            <span class="comment">// 设置用于生成嵌入向量的嵌入模型</span></span><br><span class="line">            .embeddingModel(embeddingModel)</span><br><span class="line">            <span class="comment">// 指定要使用的嵌入存储</span></span><br><span class="line">            .embeddingStore(embeddingStore)</span><br><span class="line">            <span class="comment">// 设置最大检索结果数量，这里表示最多返回 1 条匹配结果</span></span><br><span class="line">            .maxResults(<span class="number">1</span>)</span><br><span class="line">            <span class="comment">// 设置最小得分阈值，只有得分大于等于 0.8 的结果才会被返回</span></span><br><span class="line">            .minScore(<span class="number">0.8</span>)</span><br><span class="line">            <span class="comment">// 构建最终的 EmbeddingStoreContentRetriever 实例</span></span><br><span class="line">            .build();</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<h3 id="9-3、修改XiaozhiAgent"><a href="#9-3、修改XiaozhiAgent" class="headerlink" title="9.3、修改XiaozhiAgent"></a>9.3、修改XiaozhiAgent</h3><p>修改contentRetriever的配置为contentRetrieverXiaozhiPincone</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@AiService(</span></span><br><span class="line"><span class="meta">       wiringMode = EXPLICIT,</span></span><br><span class="line"><span class="meta">       chatModel = &quot;qwenChatModel&quot;,</span></span><br><span class="line"><span class="meta">       chatMemoryProvider = &quot;chatMemoryProviderXiaozhi&quot;,</span></span><br><span class="line"><span class="meta">       tools = &quot;appointmentTools&quot;,</span></span><br><span class="line"><span class="meta">       contentRetriever = &quot;contentRetrieverXiaozhiPincone&quot;)</span></span><br></pre></td></tr></table></figure>

<h2 id="10、流式输出"><a href="#10、流式输出" class="headerlink" title="10、流式输出"></a>10、流式输出</h2><p>大模型的流式输出是指大模型在生成文本或其他类型的数据时，不是等到整个生成过程完成后再一次性 返回所有内容，而是生成一部分就立即发送一部分给用户或下游系统，以逐步、逐块的方式返回结果。 这样，用户就不需要等待整个文本生成完成再看到结果。通过这种方式可以改善用户体验，因为用户不 需要等待太长时间，几乎可以立即开始阅读响应。</p>
<h3 id="10-1、添加依赖"><a href="#10-1、添加依赖" class="headerlink" title="10.1、添加依赖"></a>10.1、添加依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--流式输出--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-webflux<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>dev.langchain4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>langchain4j-reactor<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="10-2、配置流式输出模型"><a href="#10-2、配置流式输出模型" class="headerlink" title="10.2、配置流式输出模型"></a>10.2、配置流式输出模型</h3><p>在application.properties中配置流式输出大模型</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#集成阿里通义千问-流式输出</span><br><span class="line">langchain4j.community.dashscope.streaming-chat-model.api-key=$&#123;DASH_SCOPE_API_KEY&#125;</span><br><span class="line"> langchain4j.community.dashscope.streaming-chat-model.model-name=qwen-plus</span><br></pre></td></tr></table></figure>

<h3 id="10-3、编码"><a href="#10-3、编码" class="headerlink" title="10.3、编码"></a>10.3、编码</h3><p>修改 XiaozhiAgent 中 chatModel 改为 streamingChatModel &#x3D; “qwenStreamingChatModel”</p>
<p> &#96;chat 方法的返回值为 Flux</p>
<p>修改 XiaozhiController 中 chat 方法的返回值为 Flux ，并添加 produces 属性</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="http://example.com">TTDB</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2025/04/29/langchain4j/">http://example.com/2025/04/29/langchain4j/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="http://example.com" target="_blank">TTDB's blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/java-%E5%A4%A7%E6%A8%A1%E5%9E%8B/">java, 大模型</a></div><div class="post-share"><div class="social-share" data-image="/img/ab271877b6d5d966b6bcd9cda1623d51.jpeg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i>赞助</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/0ed4d56b723a59b4303d73913cf16f7.jpg" target="_blank"><img class="post-qr-code-img" src="/img/0ed4d56b723a59b4303d73913cf16f7.jpg" alt="wechat"/></a><div class="post-qr-code-desc">wechat</div></li><li class="reward-item"><a href="/img/8151e0eadcb22bce884312f7f78e0f6.jpg" target="_blank"><img class="post-qr-code-img" src="/img/8151e0eadcb22bce884312f7f78e0f6.jpg" alt="alipay"/></a><div class="post-qr-code-desc">alipay</div></li></ul></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related full-width" href="/2025/04/21/%E6%B3%A8%E8%A7%A3/" title="注解"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">注解</div></div><div class="info-2"><div class="info-item-1">前言本篇笔记是对注解的理解，了解为什么注解，注解有哪些，功能又是什么 Javaweb&gt;spring&gt;springMVC&gt;mybatis&gt;spring高级，一路走来，跌跌撞撞，发现spring也不过尔尔，说白了，spring就是想尽办法将new做的更简单，更完美，更可配置。 Spring的一个核心功能是IOC，就是将Bean初始化加载到容器中，Bean是如何加载到容器的，可以使用Spring注解方式或者Spring XML配置方式。 Spring注解方式减少了配置文件内容，更加便于管理，并且使用注解可以大大提高了开发效率！ 注解本身是没有功能的，和xml一样，注解和xml都是一种元数据，元数据即解释数据的数据，也就是所谓的配置。 什么是注解(Annotation)注解是Java...</div></div></div></a></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/ab271877b6d5d966b6bcd9cda1623d51.jpeg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">TTDB</div><div class="author-info-description">What can I do for you?</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">16</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">8</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">4</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/HgnGoning" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:hgn314134@163.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E5%85%A5%E9%97%A8"><span class="toc-number">1.</span> <span class="toc-text">一、入门</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81%E4%B8%BB%E8%A6%81%E5%8A%9F%E8%83%BD"><span class="toc-number">1.1.</span> <span class="toc-text">1、主要功能</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81%E5%88%9B%E5%BB%BASpringBoot%E6%B5%8B%E8%AF%95%E7%8E%AF%E5%A2%83"><span class="toc-number">1.2.</span> <span class="toc-text">2、创建SpringBoot测试环境</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1%E6%96%B0%E5%BB%BA%E4%B8%80%E4%B8%AAMaven%E9%A1%B9%E7%9B%AE"><span class="toc-number">1.2.1.</span> <span class="toc-text">2.1新建一个Maven项目</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">1.2.2.</span> <span class="toc-text">2.2配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3%E5%88%9B%E5%BB%BA%E5%90%AF%E5%8A%A8%E7%B1%BB"><span class="toc-number">1.2.3.</span> <span class="toc-text">2.3创建启动类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4%E6%8E%A5%E5%8F%A3%E6%B5%8B%E8%AF%95%E6%96%87%E6%A1%A3"><span class="toc-number">1.2.4.</span> <span class="toc-text">2.4接口测试文档</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%E3%80%81%E6%8E%A5%E5%85%A5%E5%A4%A7%E6%A8%A1%E5%9E%8B"><span class="toc-number">1.3.</span> <span class="toc-text">3、接入大模型</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1%E3%80%81LangChain4j-%E5%BA%93%E7%BB%93%E6%9E%84"><span class="toc-number">1.3.1.</span> <span class="toc-text">3.1、LangChain4j 库结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2%E3%80%81%E4%BE%9D%E8%B5%96"><span class="toc-number">1.3.2.</span> <span class="toc-text">3.2、依赖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3%E3%80%81%E5%88%9B%E5%BB%BA%E6%B5%8B%E8%AF%95%E7%94%A8%E4%BE%8B"><span class="toc-number">1.3.3.</span> <span class="toc-text">3.3、创建测试用例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E3%80%81SpringBoot%E6%95%B4%E5%90%88"><span class="toc-number">1.3.4.</span> <span class="toc-text">4、SpringBoot整合</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1%E6%9B%BF%E6%8D%A2%E4%BE%9D%E8%B5%96"><span class="toc-number">1.3.5.</span> <span class="toc-text">4.1替换依赖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2%E6%A8%A1%E5%9E%8B%E5%8F%82%E6%95%B0"><span class="toc-number">1.3.6.</span> <span class="toc-text">4.2模型参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-%E6%B5%8B%E8%AF%95"><span class="toc-number">1.3.7.</span> <span class="toc-text">4.3 测试</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4%E3%80%81%E6%8E%A5%E5%85%A5%E5%85%B6%E4%BB%96%E5%A4%A7%E6%A8%A1%E5%9E%8B"><span class="toc-number">1.4.</span> <span class="toc-text">4、接入其他大模型</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-Deepseek"><span class="toc-number">1.4.1.</span> <span class="toc-text">4.1 Deepseek</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-ollama%E6%9C%AC%E5%9C%B0%E9%83%A8%E7%BD%B2"><span class="toc-number">1.4.2.</span> <span class="toc-text">4.2 ollama本地部署</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-%E9%98%BF%E9%87%8C%E7%99%BE%E7%82%BC%E5%B9%B3%E5%8F%B0"><span class="toc-number">1.4.3.</span> <span class="toc-text">4.3 阿里百炼平台</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E4%BA%BA%E5%B7%A5%E6%99%BA%E8%83%BD%E6%9C%8D%E5%8A%A1-AIService"><span class="toc-number">2.</span> <span class="toc-text">二、人工智能服务 AIService</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81%E4%BB%80%E4%B9%88%E6%98%AFAlService"><span class="toc-number">2.1.</span> <span class="toc-text">1、什么是AlService</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1%E3%80%81%E9%93%BEChain-l%E6%97%A7%E7%89%88"><span class="toc-number">2.1.1.</span> <span class="toc-text">1.1、链Chain(l旧版)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2%E3%80%81%E4%BA%BA%E5%B7%A5%E6%99%BA%E8%83%BD%E6%9C%8D%E5%8A%A1AlService"><span class="toc-number">2.1.2.</span> <span class="toc-text">1.2、人工智能服务AlService</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81%E5%88%9B%E5%BB%BAAIService"><span class="toc-number">2.2.</span> <span class="toc-text">2、创建AIService</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1%E3%80%81%E5%BC%95%E5%85%A5%E4%BE%9D%E8%B5%96"><span class="toc-number">2.2.1.</span> <span class="toc-text">2.1、引入依赖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2%E3%80%81%E5%88%9B%E5%BB%BA%E6%8E%A5%E5%8F%A3"><span class="toc-number">2.2.2.</span> <span class="toc-text">2.2、创建接口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3%E3%80%81%E6%B5%8B%E8%AF%95%E7%94%A8%E4%BE%8B"><span class="toc-number">2.2.3.</span> <span class="toc-text">2.3、测试用例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4%E3%80%81-AiService"><span class="toc-number">2.2.4.</span> <span class="toc-text">2.4、@AiService</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5%E3%80%81%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="toc-number">2.2.5.</span> <span class="toc-text">2.5、工作原理</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E8%81%8A%E5%A4%A9%E8%AE%B0%E5%BF%86-Chat-memory"><span class="toc-number">3.</span> <span class="toc-text">三、聊天记忆 Chat memory</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81%E8%81%8A%E5%A4%A9%E8%AE%B0%E5%BF%86%E7%9A%84%E7%AE%80%E5%8D%95%E5%AE%9E%E7%8E%B0"><span class="toc-number">3.1.</span> <span class="toc-text">1、聊天记忆的简单实现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81%E4%BD%BF%E7%94%A8ChatMemory%E5%AE%9E%E7%8E%B0%E8%81%8A%E5%A4%A9%E8%AE%B0%E5%BF%86"><span class="toc-number">3.2.</span> <span class="toc-text">2、使用ChatMemory实现聊天记忆</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%E3%80%81%E4%BD%BF%E7%94%A8AIService%E5%AE%9E%E7%8E%B0%E8%81%8A%E5%A4%A9%E8%AE%B0%E5%BF%86"><span class="toc-number">3.3.</span> <span class="toc-text">3、使用AIService实现聊天记忆</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1%E3%80%81%E5%88%9B%E5%BB%BA%E8%AE%B0%E5%BF%86%E5%AF%B9%E8%AF%9D%E6%99%BA%E8%83%BD%E4%BD%93"><span class="toc-number">3.3.1.</span> <span class="toc-text">3.1、创建记忆对话智能体</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2%E3%80%81%E9%85%8D%E7%BD%AEChatMemory"><span class="toc-number">3.3.2.</span> <span class="toc-text">3.2、配置ChatMemory</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4%E3%80%81%E9%9A%94%E7%A6%BB%E8%81%8A%E5%A4%A9%E8%AE%B0%E5%BF%86"><span class="toc-number">3.4.</span> <span class="toc-text">4、隔离聊天记忆</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1%E3%80%81%E5%88%9B%E5%BB%BA%E8%AE%B0%E5%BF%86%E9%9A%94%E7%A6%BB%E5%AF%B9%E8%AF%9D%E6%99%BA%E8%83%BD%E4%BD%93"><span class="toc-number">3.4.1.</span> <span class="toc-text">4.1、创建记忆隔离对话智能体</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2%E3%80%81%E9%85%8D%E7%BD%AEChatMemoryProvider"><span class="toc-number">3.4.2.</span> <span class="toc-text">4.2、配置ChatMemoryProvider</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E6%8C%81%E4%B9%85%E5%8C%96%E8%81%8A%E5%A4%A9%E8%AE%B0%E5%BF%86-Persistence"><span class="toc-number">4.</span> <span class="toc-text">四、持久化聊天记忆 Persistence</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81%E5%AD%98%E5%82%A8%E4%BB%8B%E8%B4%A8%E7%9A%84%E9%80%89%E6%8B%A9"><span class="toc-number">4.1.</span> <span class="toc-text">1、存储介质的选择</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81MongoDB"><span class="toc-number">4.2.</span> <span class="toc-text">2、MongoDB</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1%E3%80%81%E7%AE%80%E4%BB%8B"><span class="toc-number">4.2.1.</span> <span class="toc-text">2.1、简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2%E3%80%81%E5%AE%89%E8%A3%85MongoDB"><span class="toc-number">4.2.2.</span> <span class="toc-text">2.2、安装MongoDB</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3%E3%80%81%E4%BD%BF%E7%94%A8mongosh"><span class="toc-number">4.2.3.</span> <span class="toc-text">2.3、使用mongosh</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4%E3%80%81%E4%BD%BF%E7%94%A8mongodb-compass"><span class="toc-number">4.2.4.</span> <span class="toc-text">2.4、使用mongodb-compass</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5%E3%80%81%E6%95%B4%E5%90%88SpringBoot"><span class="toc-number">4.2.5.</span> <span class="toc-text">2.5、整合SpringBoot</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-6%E3%80%81CRUD%E6%B5%8B%E8%AF%95"><span class="toc-number">4.2.6.</span> <span class="toc-text">2.6、CRUD测试</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%E3%80%81%E6%8C%81%E4%B9%85%E5%8C%96%E8%81%8A%E5%A4%A9"><span class="toc-number">4.3.</span> <span class="toc-text">3、持久化聊天</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1%E3%80%81%E4%BC%98%E5%8C%96%E5%AE%9E%E4%BD%93%E7%B1%BB"><span class="toc-number">4.3.1.</span> <span class="toc-text">3.1、优化实体类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2%E3%80%81%E5%88%9B%E5%BB%BA%E6%8C%81%E4%B9%85%E5%8C%96%E7%B1%BB"><span class="toc-number">4.3.2.</span> <span class="toc-text">3.2、创建持久化类</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4%E3%80%81%E6%B5%8B%E8%AF%95"><span class="toc-number">4.4.</span> <span class="toc-text">4、测试</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%94%E3%80%81%E6%8F%90%E7%A4%BA%E8%AF%8D-Prompt"><span class="toc-number">5.</span> <span class="toc-text">五、提示词 Prompt</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81%E7%B3%BB%E7%BB%9F%E6%8F%90%E7%A4%BA%E8%AF%8D"><span class="toc-number">5.1.</span> <span class="toc-text">1、系统提示词</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1%E3%80%81%E9%85%8D%E7%BD%AE-SystemMessage"><span class="toc-number">5.1.1.</span> <span class="toc-text">1.1、配置@SystemMessage</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2%E3%80%81%E6%B5%8B%E8%AF%95"><span class="toc-number">5.1.2.</span> <span class="toc-text">1.2、测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3%E3%80%81%E4%BB%8E%E8%B5%84%E6%BA%90%E4%B8%AD%E5%8A%A0%E8%BD%BD%E6%8F%90%E7%A4%BA%E6%A8%A1%E6%9D%BF"><span class="toc-number">5.1.3.</span> <span class="toc-text">1.3、从资源中加载提示模板</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81%E7%94%A8%E6%88%B7%E6%8F%90%E7%A4%BA%E8%AF%8D%E6%A8%A1%E6%9D%BF"><span class="toc-number">5.2.</span> <span class="toc-text">2、用户提示词模板</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1%E3%80%81%E9%85%8D%E7%BD%AE-UserMessage"><span class="toc-number">5.2.1.</span> <span class="toc-text">2.1、配置@UserMessage</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%E3%80%81%E6%8C%87%E5%AE%9A%E5%8F%82%E6%95%B0%E5%90%8D%E7%A7%B0"><span class="toc-number">5.3.</span> <span class="toc-text">3、指定参数名称</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1%E3%80%81%E9%85%8D%E7%BD%AE-V"><span class="toc-number">5.3.1.</span> <span class="toc-text">3.1、配置@V</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2%E3%80%81%E5%A4%9A%E4%B8%AA%E5%8F%82%E6%95%B0%E7%9A%84%E6%83%85%E5%86%B5"><span class="toc-number">5.3.2.</span> <span class="toc-text">3.2、多个参数的情况</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3%E3%80%81-SystemMessage%E5%92%8C-V"><span class="toc-number">5.3.3.</span> <span class="toc-text">3.3、@SystemMessage和@V</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%AD%E3%80%81-Function-Calling-%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8"><span class="toc-number">6.</span> <span class="toc-text">六、 Function Calling 函数调用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81-Tool%E6%B3%A8%E8%A7%A3%E7%9A%84%E5%8F%AF%E9%80%89%E5%AD%97%E6%AE%B5"><span class="toc-number">6.1.</span> <span class="toc-text">1、@Tool注解的可选字段</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81-P%E6%B3%A8%E8%A7%A3"><span class="toc-number">6.2.</span> <span class="toc-text">2、@P注解</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%E3%80%81-ToolMemoryId"><span class="toc-number">6.3.</span> <span class="toc-text">3、@ToolMemoryId</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%83%E3%80%81%E6%A3%80%E7%B4%A2%E5%A2%9E%E5%BC%BA%E7%94%9F%E6%88%90-RAG"><span class="toc-number">7.</span> <span class="toc-text">七、检索增强生成 RAG</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81RAG"><span class="toc-number">7.1.</span> <span class="toc-text">1、RAG</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81RAG%E5%B8%B8%E7%94%A8%E6%96%B9%E6%B3%95"><span class="toc-number">7.2.</span> <span class="toc-text">2、RAG常用方法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1%E3%80%81%E5%90%91%E9%87%8F%E6%90%9C%E7%B4%A2"><span class="toc-number">7.2.1.</span> <span class="toc-text">2.1、向量搜索</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%E3%80%81-RAG%E7%9A%84%E8%BF%87%E7%A8%8B"><span class="toc-number">7.3.</span> <span class="toc-text">3、 RAG的过程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1%E3%80%81%E7%B4%A2%E5%BC%95"><span class="toc-number">7.3.1.</span> <span class="toc-text">3.1、索引</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2%E3%80%81%E6%A3%80%E7%B4%A2%E9%98%B6%E6%AE%B5"><span class="toc-number">7.3.2.</span> <span class="toc-text">3.2、检索阶段</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4%E3%80%81%E6%96%87%E6%A1%A3%E5%8A%A0%E8%BD%BD%E5%99%A8-Document-Loader"><span class="toc-number">7.4.</span> <span class="toc-text">4、文档加载器 Document Loader</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1%E3%80%81%E5%B8%B8%E8%A7%81%E6%96%87%E6%A1%A3%E5%8A%A0%E8%BD%BD%E5%99%A8"><span class="toc-number">7.4.1.</span> <span class="toc-text">4.1、常见文档加载器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2%E3%80%81%E6%B5%8B%E8%AF%95%E6%96%87%E6%A1%A3%E5%8A%A0%E8%BD%BD"><span class="toc-number">7.4.2.</span> <span class="toc-text">4.2、测试文档加载</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5%E3%80%81%E6%96%87%E6%A1%A3%E8%A7%A3%E6%9E%90%E5%99%A8-Document-Parser"><span class="toc-number">7.5.</span> <span class="toc-text">5、文档解析器 Document Parser</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1%E3%80%81%E5%B8%B8%E8%A7%81%E6%96%87%E6%A1%A3%E8%A7%A3%E6%9E%90%E5%99%A8"><span class="toc-number">7.5.1.</span> <span class="toc-text">5.1、常见文档解析器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2%E3%80%81%E6%B7%BB%E5%8A%A0%E4%BE%9D%E8%B5%96"><span class="toc-number">7.5.2.</span> <span class="toc-text">5.2、添加依赖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3%E3%80%81%E8%A7%A3%E6%9E%90pdf%E6%96%87%E6%A1%A3"><span class="toc-number">7.5.3.</span> <span class="toc-text">5.3、解析pdf文档</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6%E3%80%81%E6%96%87%E6%A1%A3%E5%88%86%E5%89%B2%E5%99%A8-Document-Splitter"><span class="toc-number">7.6.</span> <span class="toc-text">6、文档分割器 Document Splitter</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1%E3%80%81%E5%B8%B8%E8%A7%81%E6%96%87%E6%A1%A3%E5%88%86%E5%89%B2%E5%99%A8"><span class="toc-number">7.6.1.</span> <span class="toc-text">6.1、常见文档分割器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2%E3%80%81%E6%B5%8B%E8%AF%95%E5%90%91%E9%87%8F%E8%BD%AC%E6%8D%A2%E5%92%8C%E5%90%91%E9%87%8F%E5%AD%98%E5%82%A8"><span class="toc-number">7.6.2.</span> <span class="toc-text">6.2、测试向量转换和向量存储</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-3%E3%80%81%E6%B5%8B%E8%AF%95%E6%96%87%E6%A1%A3%E5%88%86%E5%89%B2"><span class="toc-number">7.6.3.</span> <span class="toc-text">6.3、测试文档分割</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-4%E3%80%81token%E5%92%8Ctoken%E8%AE%A1%E7%AE%97"><span class="toc-number">7.6.4.</span> <span class="toc-text">6.4、token和token计算</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-5%E3%80%81%E5%B7%A5%E4%BD%9C%E6%96%B9%E5%BC%8F"><span class="toc-number">7.6.5.</span> <span class="toc-text">6.5、工作方式</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%AB%E3%80%81%E5%90%91%E9%87%8F%E6%A8%A1%E5%9E%8B%E5%92%8C%E5%90%91%E9%87%8F%E5%AD%98%E5%82%A8"><span class="toc-number">8.</span> <span class="toc-text">八、向量模型和向量存储</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81%E5%90%91%E9%87%8F%E5%A4%A7%E6%A8%A1%E5%9E%8B"><span class="toc-number">8.1.</span> <span class="toc-text">1、向量大模型</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1%E3%80%81%E4%BB%8B%E7%BB%8D"><span class="toc-number">8.1.1.</span> <span class="toc-text">1.1、介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2%E3%80%81%E6%A8%A1%E5%9E%8B%E9%85%8D%E7%BD%AE"><span class="toc-number">8.1.2.</span> <span class="toc-text">1.2、模型配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3%E3%80%81%E6%96%87%E6%9C%AC%E5%90%91%E9%87%8F%E5%8C%96"><span class="toc-number">8.1.3.</span> <span class="toc-text">1.3、文本向量化</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81%E5%90%91%E9%87%8F%E5%AD%98%E5%82%A8"><span class="toc-number">8.2.</span> <span class="toc-text">2、向量存储</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1%E3%80%81Pinecone%E7%AE%80%E4%BB%8B"><span class="toc-number">8.2.1.</span> <span class="toc-text">2.1、Pinecone简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2%E3%80%81Pinecone%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-number">8.2.2.</span> <span class="toc-text">2.2、Pinecone的使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3%E3%80%81%E9%9B%86%E6%88%90Pinecone"><span class="toc-number">8.2.3.</span> <span class="toc-text">2.3、集成Pinecone</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4%E3%80%81%E9%85%8D%E7%BD%AE%E5%90%91%E9%87%8F%E5%AD%98%E5%82%A8%E5%AF%B9%E8%B1%A1"><span class="toc-number">8.2.4.</span> <span class="toc-text">2.4、配置向量存储对象</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5%E3%80%81%E6%B5%8B%E8%AF%95%E5%90%91%E9%87%8F%E5%AD%98%E5%82%A8"><span class="toc-number">8.2.5.</span> <span class="toc-text">2.5、测试向量存储</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81%E7%9B%B8%E4%BC%BC%E5%BA%A6%E5%8C%B9%E9%85%8D"><span class="toc-number">8.2.6.</span> <span class="toc-text">3、相似度匹配</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%AD%E3%80%81%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98-%E5%88%9B%E5%BB%BA%E7%A1%85%E8%B0%B7%E5%B0%8F%E6%99%BA"><span class="toc-number">9.</span> <span class="toc-text">六、项目实战-创建硅谷小智</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81%E5%88%9B%E5%BB%BA%E7%A1%85%E8%B0%B7%E5%B0%8F%E6%99%BA"><span class="toc-number">9.1.</span> <span class="toc-text">1、创建硅谷小智</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81%E6%8F%90%E7%A4%BA%E8%AF%8D%E6%A8%A1%E6%9D%BF"><span class="toc-number">9.2.</span> <span class="toc-text">2、提示词模板</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%E3%80%81%E9%85%8D%E7%BD%AE%E5%B0%8F%E6%99%BA%E5%8A%A9%E6%89%8B"><span class="toc-number">9.3.</span> <span class="toc-text">3、配置小智助手</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4%E3%80%81%E5%B0%81%E8%A3%85%E5%AF%B9%E8%AF%9D%E5%AF%B9%E8%B1%A1"><span class="toc-number">9.4.</span> <span class="toc-text">4、封装对话对象</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5%E3%80%81%E6%B7%BB%E5%8A%A0Controller%E6%96%B9%E6%B3%95"><span class="toc-number">9.5.</span> <span class="toc-text">5、添加Controller方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6%E3%80%81%E9%A2%84%E7%BA%A6%E4%B8%9A%E5%8A%A1%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="toc-number">9.6.</span> <span class="toc-text">6、预约业务的实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1%E3%80%81%E5%88%9B%E5%BB%BAMySQL%E6%95%B0%E6%8D%AE%E5%BA%93%E8%A1%A8"><span class="toc-number">9.6.1.</span> <span class="toc-text">6.1、创建MySQL数据库表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2%E3%80%81%E5%BC%95%E5%85%A5%E4%BE%9D%E8%B5%96"><span class="toc-number">9.6.2.</span> <span class="toc-text">6.2、引入依赖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-3%E3%80%81%E9%85%8D%E7%BD%AE%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%9E%E6%8E%A5"><span class="toc-number">9.6.3.</span> <span class="toc-text">6.3、配置数据库连接</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-4%E3%80%81%E5%88%9B%E5%BB%BA%E5%AE%9E%E4%BD%93%E7%B1%BB"><span class="toc-number">9.6.4.</span> <span class="toc-text">6.4、创建实体类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-5%E3%80%81Mapper"><span class="toc-number">9.6.5.</span> <span class="toc-text">6.5、Mapper</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-6%E3%80%81Service"><span class="toc-number">9.6.6.</span> <span class="toc-text">6.6、Service</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-7%E3%80%81%E6%B5%8B%E5%BC%8F"><span class="toc-number">9.6.7.</span> <span class="toc-text">6.7、测式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7%E3%80%81Tools"><span class="toc-number">9.7.</span> <span class="toc-text">7、Tools</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#7-1%E3%80%81%E5%88%9B%E5%BB%BATools"><span class="toc-number">9.7.1.</span> <span class="toc-text">7.1、创建Tools</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-2%E3%80%81%E9%85%8D%E7%BD%AETools"><span class="toc-number">9.7.2.</span> <span class="toc-text">7.2、配置Tools</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8%E3%80%81RAG"><span class="toc-number">9.8.</span> <span class="toc-text">8、RAG</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#8-1%E3%80%81%E5%88%9B%E5%BB%BA-Bean%E5%AF%B9%E8%B1%A1"><span class="toc-number">9.8.1.</span> <span class="toc-text">8.1、创建@Bean对象</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-2%E3%80%81%E6%B7%BB%E5%8A%A0%E9%85%8D%E7%BD%AE"><span class="toc-number">9.8.2.</span> <span class="toc-text">8.2、添加配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-3%E3%80%81%E4%BF%AE%E6%94%B9%E5%B7%A5%E5%85%B7%E7%9A%84value%E6%8F%90%E7%A4%BA"><span class="toc-number">9.8.3.</span> <span class="toc-text">8.3、修改工具的value提示</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9%E3%80%81%E6%95%B4%E5%90%88%E5%90%91%E9%87%8F%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-number">9.9.</span> <span class="toc-text">9、整合向量数据库</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#9-1%E3%80%81%E4%B8%8A%E4%BC%A0%E7%9F%A5%E8%AF%86%E5%BA%93%E5%88%B0Pinecone"><span class="toc-number">9.9.1.</span> <span class="toc-text">9.1、上传知识库到Pinecone</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-2%E3%80%81%E4%BF%AE%E6%94%B9XiaozhiAgentConfig"><span class="toc-number">9.9.2.</span> <span class="toc-text">9.2、修改XiaozhiAgentConfig</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-3%E3%80%81%E4%BF%AE%E6%94%B9XiaozhiAgent"><span class="toc-number">9.9.3.</span> <span class="toc-text">9.3、修改XiaozhiAgent</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10%E3%80%81%E6%B5%81%E5%BC%8F%E8%BE%93%E5%87%BA"><span class="toc-number">9.10.</span> <span class="toc-text">10、流式输出</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#10-1%E3%80%81%E6%B7%BB%E5%8A%A0%E4%BE%9D%E8%B5%96"><span class="toc-number">9.10.1.</span> <span class="toc-text">10.1、添加依赖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-2%E3%80%81%E9%85%8D%E7%BD%AE%E6%B5%81%E5%BC%8F%E8%BE%93%E5%87%BA%E6%A8%A1%E5%9E%8B"><span class="toc-number">9.10.2.</span> <span class="toc-text">10.2、配置流式输出模型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-3%E3%80%81%E7%BC%96%E7%A0%81"><span class="toc-number">9.10.3.</span> <span class="toc-text">10.3、编码</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/04/29/langchain4j/" title="langchain4j">langchain4j</a><time datetime="2025-04-29T08:18:34.845Z" title="发表于 2025-04-29 16:18:34">2025-04-29</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/04/21/%E6%B3%A8%E8%A7%A3/" title="注解">注解</a><time datetime="2025-04-21T06:26:10.422Z" title="发表于 2025-04-21 14:26:10">2025-04-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/04/21/%E5%AD%A6%E6%88%90-%E7%AC%94%E8%AE%B0/" title="学成技术文档">学成技术文档</a><time datetime="2025-04-21T06:26:10.419Z" title="发表于 2025-04-21 14:26:10">2025-04-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/04/21/%E9%9D%A2%E8%AF%95/" title="面试---java基础">面试---java基础</a><time datetime="2025-04-21T06:26:10.376Z" title="发表于 2025-04-21 14:26:10">2025-04-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/04/21/%E5%8F%8D%E5%B0%84/" title="反射">反射</a><time datetime="2025-04-21T06:26:10.372Z" title="发表于 2025-04-21 14:26:10">2025-04-21</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2025 By TTDB</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo 7.3.0</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.3.5</a></div><div class="footer_custom_text">Hi, welcome to my <a target="_blank" rel="noopener" href="https://butterfly.js.org/">blog</a>!</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><div class="js-pjax"></div><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-nest.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = false;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script id="click-heart" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/click-heart.min.js" async="async" mobile="false"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>